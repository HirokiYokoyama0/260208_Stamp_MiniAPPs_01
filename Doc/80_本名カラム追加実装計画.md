# 本名（氏名）カラム追加実装計画

**作成日:** 2026-02-22
**ステータス:** 検討中

---

## 📋 概要

現在、ユーザーの名前は LINE の `display_name`（表示名）のみを `profiles.display_name` カラムに保存しています。LINE表示名はユーザーが自由に変更でき、本名でない場合も多いため、医療機関として患者様の本名を別途管理する必要があります。

本ドキュメントでは、**本名（氏名）カラムを追加するためのLIFFアプリ側の実装計画**を記載します。

---

## 🎯 目的

1. **患者様の本名を正確に管理**
   - LINE表示名とは別に、患者様の本名（フルネーム）を記録
   - 診療記録や診察券との正確な紐付けを実現

2. **医院側の管理業務改善**
   - 受付での患者確認がスムーズに
   - 診察券番号と本名でダブルチェック可能
   - カルテとの照合が容易に

3. **ユーザー体験の向上**
   - 本名での呼びかけで親しみやすさ向上
   - 診察券に本名を表示可能

---

## 🗂️ 現状の問題点

### 現在の実装

- **保存されているデータ**: LINE `displayName`（LINEプロフィールの表示名）
- **保存場所**: `profiles.display_name` カラム
- **取得タイミング**: LIFF初期化時に自動取得（[useLiff.ts:107](hooks/useLiff.ts#L107)）
- **保存タイミング**: ログイン後に自動upsert（[AdultHome.tsx:85-96](components/(adult)/AdultHome.tsx#L85-L96)）

### 問題点

| 問題 | 影響 |
|------|------|
| LINE表示名は本名とは限らない | 「ニックネーム」「あだ名」「絵文字」などが入っている可能性 |
| ユーザーが自由に変更可能 | 患者様が LINE 表示名を変更すると、診療記録との紐付けが困難に |
| 診察券番号との照合が困難 | 受付で「診察券番号 123456 の 🐱ねこちゃん🐱 さんですね？」となる |
| カルテとの整合性 | 紙カルテやレセプトでは本名が必要 |

**例:**
```
診察券番号: 001234
LINE表示名: 🌸さくら🌸  ← 本名「山田花子」とは異なる
```

---

## 📐 データベース設計

### 追加するカラム

**テーブル**: `profiles`

| カラム名 | 型 | NULL許可 | デフォルト | 説明 |
|---------|---|---------|----------|------|
| `real_name` | TEXT | YES | NULL | 患者様の本名（フルネーム、漢字表記） |
| `real_name_kana` | TEXT | YES | NULL | 本名のふりがな（ひらがな表記、任意） |

### 追加カラムの仕様

```sql
-- 既存の profiles テーブルに追加
ALTER TABLE profiles
ADD COLUMN real_name TEXT,
ADD COLUMN real_name_kana TEXT;

-- インデックス（検索用）
CREATE INDEX idx_profiles_real_name ON profiles(real_name);
CREATE INDEX idx_profiles_real_name_kana ON profiles(real_name_kana);

-- コメント
COMMENT ON COLUMN profiles.real_name IS '患者様の本名（フルネーム、漢字）。LINE表示名とは別に管理。';
COMMENT ON COLUMN profiles.real_name_kana IS '本名のふりがな（ひらがな）。検索用、任意。';
```

### NULL許可の理由

- **任意入力とする**: 初回登録時に本名を入力しなくても登録完了できる
- **段階的な移行**: 既存ユーザーには影響せず、新規ユーザーから徐々に本名を収集
- **プライバシー配慮**: 強制にせず、ユーザーの同意を得て入力してもらう

---

## 🚀 実装計画（LIFFアプリ側）

### Phase 1: データベースマイグレーション

**ファイル**: `supabase/012_add_real_name_column.sql`

```sql
-- 本名カラムを追加
ALTER TABLE profiles
ADD COLUMN real_name TEXT,
ADD COLUMN real_name_kana TEXT;

-- インデックスを作成
CREATE INDEX idx_profiles_real_name ON profiles(real_name);
CREATE INDEX idx_profiles_real_name_kana ON profiles(real_name_kana);

-- コメント
COMMENT ON COLUMN profiles.real_name IS '患者様の本名（フルネーム、漢字）。LINE表示名とは別に管理。';
COMMENT ON COLUMN profiles.real_name_kana IS '本名のふりがな（ひらがな）。検索用、任意。';
```

---

### Phase 2: TypeScript型定義の更新

#### 2.1 `hooks/useLiff.ts` の更新

```typescript
export interface LiffProfile {
  userId: string;
  displayName: string;    // LINE表示名（既存）
  pictureUrl?: string;
  statusMessage?: string;
}
```

**変更不要**: LIFF SDK が返す情報に本名は含まれていないため、そのまま維持

---

#### 2.2 新しい型定義を追加（`types/profile.ts` 新規作成）

```typescript
// types/profile.ts
export interface UserProfile {
  id: string;                  // LINE User ID
  line_user_id: string;        // LINE User ID
  display_name: string;        // LINE表示名
  real_name?: string | null;   // 🆕 本名（漢字）
  real_name_kana?: string | null; // 🆕 本名（ふりがな）
  picture_url?: string | null;
  stamp_count: number;
  ticket_number?: string | null;
  family_id?: string | null;
  family_role?: 'parent' | 'child' | null;
  last_visit_date?: string | null;
  is_line_friend?: boolean | null;
  view_mode: 'adult' | 'kids';
  created_at: string;
  updated_at: string;
}
```

---

### Phase 3: 本名入力フォームの実装

#### 3.1 本名入力モーダルコンポーネントの作成

**ファイル**: `components/shared/RealNameInputModal.tsx`（新規作成）

```typescript
'use client';

import { useState } from 'react';
import { Loader2, User, X } from 'lucide-react';

interface RealNameInputModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (realName: string, realNameKana: string) => Promise<void>;
  currentRealName?: string | null;
  currentRealNameKana?: string | null;
}

export default function RealNameInputModal({
  isOpen,
  onClose,
  onSubmit,
  currentRealName,
  currentRealNameKana,
}: RealNameInputModalProps) {
  const [realName, setRealName] = useState(currentRealName || '');
  const [realNameKana, setRealNameKana] = useState(currentRealNameKana || '');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async () => {
    // バリデーション
    if (!realName.trim()) {
      setError('お名前を入力してください');
      return;
    }

    setIsLoading(true);
    setError('');

    try {
      await onSubmit(realName.trim(), realNameKana.trim());
      onClose();
    } catch (err) {
      console.error('本名の保存に失敗しました:', err);
      setError('保存に失敗しました。もう一度お試しください。');
    } finally {
      setIsLoading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="mx-4 w-full max-w-md rounded-xl bg-white p-6 shadow-xl">
        {/* ヘッダー */}
        <div className="mb-4 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <User className="text-primary" size={24} />
            <h3 className="text-lg font-bold text-gray-800">本名の入力</h3>
          </div>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600"
          >
            <X size={24} />
          </button>
        </div>

        {/* 説明 */}
        <p className="mb-4 text-sm text-gray-600">
          診察券やカルテとの照合のため、本名をご入力ください。
        </p>

        {/* エラー表示 */}
        {error && (
          <div className="mb-4 rounded-lg bg-red-50 border border-red-200 p-3 text-sm text-red-700">
            {error}
          </div>
        )}

        {/* フォーム */}
        <div className="space-y-4">
          {/* 本名（漢字） */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">
              お名前（漢字） <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={realName}
              onChange={(e) => setRealName(e.target.value)}
              placeholder="例: 山田 太郎"
              className="w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-800 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              disabled={isLoading}
            />
          </div>

          {/* 本名（ふりがな） */}
          <div>
            <label className="mb-1 block text-sm font-medium text-gray-700">
              ふりがな（任意）
            </label>
            <input
              type="text"
              value={realNameKana}
              onChange={(e) => setRealNameKana(e.target.value)}
              placeholder="例: やまだ たろう"
              className="w-full rounded-lg border border-gray-300 px-4 py-2 text-gray-800 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              disabled={isLoading}
            />
          </div>
        </div>

        {/* ボタン */}
        <div className="mt-6 flex gap-3">
          <button
            onClick={onClose}
            disabled={isLoading}
            className="flex-1 rounded-lg border border-gray-300 px-4 py-2.5 font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
          >
            スキップ
          </button>
          <button
            onClick={handleSubmit}
            disabled={isLoading}
            className="flex flex-1 items-center justify-center gap-2 rounded-lg bg-primary px-4 py-2.5 font-semibold text-white hover:bg-primary-dark disabled:opacity-50"
          >
            {isLoading && <Loader2 className="animate-spin" size={18} />}
            保存
          </button>
        </div>

        {/* 注意事項 */}
        <p className="mt-4 text-xs text-gray-500">
          ※ 入力いただいた本名は、診療記録の管理のみに使用します。
        </p>
      </div>
    </div>
  );
}
```

---

#### 3.2 本名入力モーダルの表示タイミング

**方針**: 以下の2つのタイミングで本名入力を促す

1. **初回登録時**: オンボーディング完了後に自動表示
2. **設定画面から**: ユーザーが任意で入力・編集可能

---

### Phase 4: API実装

#### 4.1 本名更新API

**ファイル**: `app/api/users/[userId]/real-name/route.ts`（新規作成）

```typescript
import { NextRequest, NextResponse } from "next/server";
import { supabase } from "@/lib/supabase";

interface RealNameUpdateRequest {
  realName: string;
  realNameKana?: string;
}

/**
 * PUT /api/users/[userId]/real-name
 * ユーザーの本名を更新
 */
export async function PUT(
  request: NextRequest,
  { params }: { params: { userId: string } }
): Promise<NextResponse> {
  try {
    const userId = params.userId;
    const body: RealNameUpdateRequest = await request.json();
    const { realName, realNameKana } = body;

    // バリデーション
    if (!userId) {
      return NextResponse.json(
        {
          success: false,
          message: "ユーザーIDが指定されていません",
        },
        { status: 400 }
      );
    }

    if (!realName || realName.trim().length === 0) {
      return NextResponse.json(
        {
          success: false,
          message: "お名前を入力してください",
        },
        { status: 400 }
      );
    }

    // プロフィール更新
    const { data, error } = await supabase
      .from("profiles")
      .update({
        real_name: realName.trim(),
        real_name_kana: realNameKana?.trim() || null,
        updated_at: new Date().toISOString(),
      })
      .eq("id", userId)
      .select()
      .single();

    if (error) {
      console.error("本名の更新に失敗しました:", error);
      return NextResponse.json(
        {
          success: false,
          message: "本名の更新に失敗しました",
          error: error.message,
        },
        { status: 500 }
      );
    }

    console.log(`✅ 本名を更新しました: User ${userId}, Name: ${realName}`);

    return NextResponse.json(
      {
        success: true,
        message: "本名を更新しました",
        profile: data,
      },
      { status: 200 }
    );
  } catch (error) {
    console.error("本名更新API エラー:", error);
    return NextResponse.json(
      {
        success: false,
        message: "サーバーエラーが発生しました",
        error: error instanceof Error ? error.message : "Unknown error",
      },
      { status: 500 }
    );
  }
}
```

---

### Phase 5: UI統合

#### 5.1 初回登録フローに本名入力を追加

**ファイル**: `app/onboarding/page.tsx` を修正

```typescript
// 役割設定完了後に本名入力モーダルを表示
const handleSelectRole = async (role: 'parent' | 'child') => {
  // ... 既存の処理 ...

  if (role === 'parent') {
    // 親の場合: 家族作成完了 → 本名入力モーダル表示 → ホーム画面へ
    setShowRealNameModal(true); // 🆕
  } else {
    // 子の場合: 家族参加フローへ（本名は後で入力可能）
    router.push('/family/join');
  }
};
```

---

#### 5.2 設定画面に本名編集機能を追加

**ファイル**: `app/settings/page.tsx` を修正

```typescript
export default function SettingsPage() {
  const { profile } = useLiff();
  const [realName, setRealName] = useState<string | null>(null);
  const [realNameKana, setRealNameKana] = useState<string | null>(null);
  const [showRealNameModal, setShowRealNameModal] = useState(false);

  // ユーザー情報を取得
  useEffect(() => {
    const fetchUserProfile = async () => {
      if (!profile?.userId) return;

      const res = await fetch(`/api/users/me?userId=${profile.userId}`);
      const data = await res.json();

      if (data.success && data.profile) {
        setRealName(data.profile.real_name);
        setRealNameKana(data.profile.real_name_kana);
      }
    };

    fetchUserProfile();
  }, [profile?.userId]);

  const handleUpdateRealName = async (newRealName: string, newRealNameKana: string) => {
    if (!profile?.userId) return;

    const res = await fetch(`/api/users/${profile.userId}/real-name`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        realName: newRealName,
        realNameKana: newRealNameKana,
      }),
    });

    const data = await res.json();

    if (data.success) {
      setRealName(newRealName);
      setRealNameKana(newRealNameKana);
      alert('本名を更新しました');
    } else {
      alert(data.message || '更新に失敗しました');
    }
  };

  return (
    <div className="px-4 py-6">
      {/* 既存のセクション */}

      {/* 🆕 本名管理セクション */}
      <section className="mt-8">
        <h3 className="mb-3 text-sm font-medium text-gray-700">プロフィール</h3>
        <button
          onClick={() => setShowRealNameModal(true)}
          className="flex w-full items-center gap-4 rounded-lg border-2 border-gray-200 p-4 transition-all hover:border-primary hover:bg-primary/5"
        >
          <User size={32} className="text-primary" />
          <div className="flex-1 text-left">
            <p className="font-semibold text-gray-800">本名の設定</p>
            <p className="text-xs text-gray-500">
              {realName || 'まだ設定されていません'}
            </p>
          </div>
          <span className="text-gray-400">→</span>
        </button>
      </section>

      {/* 本名入力モーダル */}
      <RealNameInputModal
        isOpen={showRealNameModal}
        onClose={() => setShowRealNameModal(false)}
        onSubmit={handleUpdateRealName}
        currentRealName={realName}
        currentRealNameKana={realNameKana}
      />
    </div>
  );
}
```

---

#### 5.3 診察券画面に本名を表示

**ファイル**: `components/(adult)/AdultHome.tsx` を修正

```typescript
// ユーザーデータ取得時に本名も取得
const fetchUserData = async (userId: string) => {
  const { data, error } = await supabase
    .from("profiles")
    .select("stamp_count, updated_at, ticket_number, family_id, real_name, real_name_kana") // 🆕
    .eq("id", userId)
    .single();

  if (data) {
    setRealName(data.real_name); // 🆕
    setRealNameKana(data.real_name_kana); // 🆕
    // ...
  }
};

// 診察券カードの表示を変更
<section className="rounded-xl border border-gray-100 bg-gradient-to-br from-white to-gray-50/50 p-5 shadow-sm">
  <h2 className="mb-4 text-xs font-medium uppercase tracking-wider text-gray-400">
    デジタル診察券
  </h2>
  <div className="space-y-3">
    {/* 🆕 本名を優先表示、未設定ならLINE表示名 */}
    <p className="text-2xl font-semibold text-gray-800">
      {realName || displayName}
    </p>
    {realName && realNameKana && (
      <p className="text-sm text-gray-500">
        {realNameKana}
      </p>
    )}
    {/* LINE表示名は小さく表示（本名が設定されている場合のみ） */}
    {realName && realName !== displayName && (
      <p className="text-xs text-gray-400">
        LINE表示名: {displayName}
      </p>
    )}
    <p className="font-mono text-sm text-gray-600">
      診察券番号: {displayTicketNumber}
    </p>
    <p className="text-xs text-gray-500">
      最終アクセス: {formatDate(lastUpdated)}
    </p>
  </div>
</section>
```

---

### Phase 6: 管理画面での本名表示

#### 6.1 次回メモ管理画面で本名検索を追加

**ファイル**: `app/admin/memo/page.tsx`（将来実装）

```typescript
// ユーザー検索時に本名でも検索可能に
const searchUsers = async (query: string) => {
  const { data, error } = await supabase
    .from("profiles")
    .select("id, display_name, real_name, real_name_kana, ticket_number")
    .or(`display_name.ilike.%${query}%,real_name.ilike.%${query}%,real_name_kana.ilike.%${query}%,ticket_number.ilike.%${query}%`)
    .limit(10);

  return data;
};

// 検索結果の表示
<div className="space-y-2">
  {searchResults.map((user) => (
    <button
      key={user.id}
      onClick={() => setSelectedUserId(user.id)}
      className="w-full text-left p-3 rounded-lg border hover:bg-gray-50"
    >
      <p className="font-semibold">{user.real_name || user.display_name}</p>
      {user.real_name_kana && (
        <p className="text-sm text-gray-500">{user.real_name_kana}</p>
      )}
      <p className="text-xs text-gray-400">
        診察券番号: {user.ticket_number || '未登録'}
      </p>
      {user.real_name && user.real_name !== user.display_name && (
        <p className="text-xs text-gray-400">
          LINE表示名: {user.display_name}
        </p>
      )}
    </button>
  ))}
</div>
```

---

## 🔐 セキュリティ・プライバシー考慮

### 1. データ保護

- **RLSポリシー**: 自分の本名のみ閲覧・編集可能

  ```sql
  -- ユーザーは自分のプロフィールのみ更新可能
  CREATE POLICY "user_update_own_profile"
    ON profiles
    FOR UPDATE
    USING (auth.uid() = id);
  ```

### 2. プライバシーポリシー

- **利用目的の明示**: 本名は診療記録の管理のみに使用することを明記
- **任意入力**: 強制せず、ユーザーの同意を得て入力してもらう
- **スキップ可能**: 初回登録時に入力しなくても登録完了できる

### 3. データ管理

- **バックアップ**: 定期的にSupabaseのバックアップを取得
- **アクセスログ**: 本名へのアクセスをログ記録（監査証跡）

---

## 📊 表示優先順位

ユーザー名の表示は以下の優先順位で行う：

| 表示場所 | 優先順位 |
|---------|---------|
| デジタル診察券 | 1. 本名（漢字）<br>2. LINE表示名（本名未設定時） |
| ふりがな | 本名のふりがな（設定されている場合のみ表示） |
| 管理画面 | 1. 本名（漢字）+ ふりがな<br>2. LINE表示名（参考情報として小さく表示） |
| 受付での確認 | 診察券番号 + 本名（ダブルチェック） |

---

## 🧪 テスト計画

### 単体テスト

- [ ] 本名更新API（PUT /api/users/[userId]/real-name）のテスト
  - 正常系: 本名とふりがなを正しく保存
  - 異常系: 空文字列、NULL、特殊文字のバリデーション
  - 異常系: 存在しないユーザーIDでの更新

### 統合テスト

- [ ] 初回登録フロー
  - オンボーディング → 本名入力 → 保存確認
  - スキップボタン → 後で入力可能
- [ ] 設定画面からの編集
  - 本名編集 → 保存 → 診察券画面に反映
- [ ] 検索機能
  - 本名・ふりがな・LINE表示名で検索可能

### UIテスト

- [ ] モーダルの表示・非表示
- [ ] バリデーションエラーの表示
- [ ] ローディング状態の表示
- [ ] スキップボタンの動作

---

## 📅 実装スケジュール（案）

| Phase | タスク | 所要時間 | 優先度 |
|-------|-------|---------|--------|
| Phase 1 | データベースマイグレーション | 30分 | 高 |
| Phase 2 | TypeScript型定義の更新 | 30分 | 高 |
| Phase 3 | 本名入力モーダル実装 | 2時間 | 高 |
| Phase 4 | API実装 | 1時間 | 高 |
| Phase 5 | UI統合（オンボーディング・設定画面） | 2時間 | 高 |
| Phase 6 | 診察券画面への表示 | 1時間 | 高 |
| Phase 7 | テスト・デバッグ | 2時間 | 高 |
| Phase 8 | 管理画面対応 | 2時間 | 中 |

**合計**: 約11時間

---

## 🚧 注意点・課題

### 1. 既存ユーザーへの影響

- **既存ユーザーの本名はNULL**: 過去に登録したユーザーは本名が未設定
- **移行戦略**:
  - 次回ログイン時にモーダル表示（1日1回まで）
  - 「後で設定する」ボタンでスキップ可能
  - 設定画面から任意で入力可能

### 2. 本名の正確性

- **自己申告制**: ユーザーが入力した本名が正しいかどうかは保証できない
- **対策**: 受付での確認時に口頭で確認、必要に応じて保険証等で照合

### 3. 個人情報保護法への対応

- **利用目的の明示**: プライバシーポリシーに本名の利用目的を記載
- **同意の取得**: 初回入力時に利用規約への同意を取得
- **データ保持期間**: 退会時に本名を削除（またはマスク処理）

---

## 🔗 関連ドキュメント

- [データベーススキーマ](05_Database_Schema.md)
- [機能仕様書](03_機能仕様書.md)
- [実装履歴](90_実装履歴.md)

---

## 📝 次のアクション

1. **この実装計画書のレビュー**
   - クライアント（医院側）への確認
   - プライバシーポリシーの確認

2. **Phase 1の実装開始**
   - データベースマイグレーション実行
   - Supabase本番環境への適用

3. **Phase 2〜6の順次実装**

---

**作成者**: Claude Code
**最終更新日**: 2026-02-22