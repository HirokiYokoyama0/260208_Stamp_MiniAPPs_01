# スタッフ手動スタンプ付与機能 仕様書

## 概要

QRコードが読み取れない場合のリスク対応として、受付スタッフが手動でスタンプを付与できる機能。

---

## ユースケース

### 通常フロー
```
患者: QRコードをスキャン → 自動でスタンプ付与 ✅
```

### エラーケース（QR読み取り失敗）
- QRコードが破損/汚れている
- スマホカメラ故障
- 高齢者でQRスキャンが難しい
- ネットワークエラー

### リカバリーフロー
```
患者: 受付スタッフに相談
  ↓
スタッフ: 患者のスマホを預かる
  ↓
スタッフ: アプリ下部のバージョン表示を 3回連続タップ
  ↓
システム: 暗証番号入力ダイアログを表示
  ↓
スタッフ: 暗証番号「1234」を入力
  ↓
システム: スタンプを手動付与 ✅
  ↓
スタッフ: 患者にスマホを返却
```

---

## UI設計

### 1. 隠しリンクの配置

**場所:** ページ最下部のバージョン情報エリア

```
┌─────────────────────────────────────┐
│  スタンプ進捗表示                    │
└─────────────────────────────────────┘

─────────────────────────────────────
       v1.0.0 • dev
       ↑
     3回タップで暗証番号入力
```

### 2. 暗証番号入力ダイアログ（ステップ1）

```
┌─────────────────────────────────────┐
│  スタッフ操作                    [×] │
├─────────────────────────────────────┤
│                                      │
│  暗証番号を入力してください          │
│                                      │
│  暗証番号（4桁）                     │
│  [  •  •  •  •  ]                   │
│                                      │
│  [キャンセル]  [次へ]                │
└─────────────────────────────────────┘
```

### 3. スタンプ数編集画面（ステップ2）

```
┌─────────────────────────────────────┐
│  スタッフ操作                    [×] │
├─────────────────────────────────────┤
│                                      │
│  スタンプ数を調整してください        │
│                                      │
│  現在のスタンプ数                    │
│  5個                                 │
│                                      │
│  新しいスタンプ数                    │
│  [ - ]  [  6  ]  [ + ]              │
│                                      │
│  変更: +1個                          │
│                                      │
│  [キャンセル]  [更新]                │
└─────────────────────────────────────┘
```

### 4. 成功メッセージ

```
┌─────────────────────────────────────┐
│  ✅ スタンプ数を更新しました          │
│                                      │
│  現在 6 / 10個                      │
└─────────────────────────────────────┘
```

---

## 技術仕様

### 1. 暗証番号

| 項目 | 値 |
|-----|---|
| **暗証番号** | `1234` |
| **桁数** | 4桁 |
| **保存場所** | 環境変数 `NEXT_PUBLIC_STAFF_PIN` |
| **変更頻度** | 月次（推奨） |

### 2. APIエンドポイント

**エンドポイント:** `POST /api/stamps/manual`

**機能:** スタッフがユーザーのスタンプ数を任意の値に変更できる（1日1回制限なし）

**リクエスト:**
```json
{
  "userId": "U1234567890abcdef",
  "staffPin": "1234",
  "newStampCount": 6
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "message": "スタンプ数を更新しました",
  "stampCount": 6
}
```

**レスポンス（暗証番号エラー）:**
```json
{
  "success": false,
  "message": "暗証番号が間違っています",
  "error": "Invalid PIN"
}
```

**レスポンス（バリデーションエラー）:**
```json
{
  "success": false,
  "message": "スタンプ数は0～999の範囲で指定してください",
  "error": "Invalid stamp count"
}
```

### 3. データベース記録

**profilesテーブル（直接更新）:**
```sql
UPDATE profiles
SET
  stamp_count = 6,  -- 新しいスタンプ数
  updated_at = NOW()
WHERE id = 'U1234567890abcdef';
```

**stamp_historyテーブル（監査証跡）:**
```sql
INSERT INTO stamp_history (
  user_id,
  visit_date,
  stamp_number,
  stamp_method,        -- 'manual_admin'
  qr_code_id,          -- 'MANUAL-ADJUST-20260209-143015'
  notes,               -- 'スタッフ操作: +1個 (5 → 6)'
  created_at
) VALUES (...);
```

**スタッフ操作の識別:**
- `stamp_method`: `'manual_admin'`（QRスキャンは `'qr_scan'`）
- `qr_code_id`: `MANUAL-ADJUST-{YYYYMMDD}-{HHMMSS}` 形式
- `notes`: `スタッフ操作: +1個 (5 → 6)` または `スタッフ操作: -2個 (8 → 6)`
- `stamp_number`: 変更後のスタンプ数を記録

---

## セキュリティ設計

### 1. 不正利用防止

| 対策 | 内容 |
|-----|------|
| **隠しリンク** | 3回連続タップでのみ表示 |
| **暗証番号** | スタッフのみ知っている |
| **監査証跡** | stamp_historyに手動付与を記録 |
| **スマホ預かり前提** | 患者自身は操作しない |

### 2. 監査ログ分析

```sql
-- 手動付与の履歴を確認
SELECT
  user_id,
  visit_date,
  stamp_number,
  qr_code_id,
  notes
FROM stamp_history
WHERE stamp_method = 'manual_admin'
ORDER BY visit_date DESC
LIMIT 20;
```

### 3. 不正検知

**月次チェック項目:**
- 手動付与の頻度（全体の5%以下が正常）
- 同一ユーザーの連続手動付与（要確認）
- 営業時間外の手動付与（異常）

---

## 環境変数設定

### .env.local（開発環境）
```env
NEXT_PUBLIC_STAFF_PIN=1234
```

### Vercel（本番環境）
```
Settings → Environment Variables
NEXT_PUBLIC_STAFF_PIN=1234
```

**注意:** 本番環境では定期的に変更してください（推奨: 月次）

---

## 操作手順（スタッフ向け）

### 1. 暗証番号入力画面の表示

1. 患者からスマホを預かる
2. LINEミニアプリを開く
3. ページ最下部のバージョン情報（`v1.0.1 • dev`）を **3回連続でタップ**
4. 暗証番号入力ダイアログが表示される

### 2. スタンプ数の変更

**ステップ1: 認証**
1. 暗証番号 `1234` を入力
2. 「次へ」ボタンをタップ

**ステップ2: 編集**
1. 現在のスタンプ数が表示される（例: 5個）
2. 「+」ボタンで増やす、「-」ボタンで減らす
3. 目的のスタンプ数になったら「更新」ボタンをタップ
4. 成功メッセージを確認
5. 患者にスマホを返却

**使用例:**
- **スタンプ追加:** QR読み取り失敗時に1個追加（5 → 6）
- **スタンプ減算:** 誤登録時に1個減らす（6 → 5）
- **大幅修正:** データ不整合時に直接設定（5 → 10）

### 3. エラー時の対応

| エラー | 原因 | 対処 |
|-------|------|------|
| 暗証番号が間違っています | 入力ミス | 再度入力 |
| ユーザー情報の取得に失敗しました | ネットワークエラー | 時間をおいて再試行 |
| スタンプ数は0～999の範囲で指定してください | 範囲外の値 | 正しい範囲で入力 |

---

## 制限事項

### 1. 操作制限

**制限なし:** スタッフ操作は何度でも実行可能（1日1回制限なし）

**理由:** QRコード読み取り失敗や誤登録の修正に柔軟に対応するため

**監査証跡:** すべての操作はstamp_historyに記録され、後から確認可能

### 2. スタンプ数の範囲

**範囲:** 0～999個

**理由:** データベースの整合性とUI表示の制約

### 3. 暗証番号の管理

**運用ルール:**
- 暗証番号は受付スタッフのみに共有
- 月次で変更（推奨）
- 漏洩時は即座に変更

---

## トラブルシューティング

### Q1: 3回タップしても反応しない

**A:** タップ間隔が長すぎる可能性があります。2秒以内に3回タップしてください。

### Q2: 暗証番号を忘れた

**A:** 管理者に確認してください。環境変数 `NEXT_PUBLIC_STAFF_PIN` に記載されています。

### Q3: スタンプ数変更後も画面が更新されない

**A:** 通常は自動的に更新されますが、更新されない場合はアプリを再読み込みしてください。

### Q4: 間違ってスタンプを減らしてしまった

**A:** 同じ手順で再度スタッフ操作を行い、正しい数に戻してください。すべての操作は記録されているため、後から確認できます。

---

## 改訂履歴

| 日付 | バージョン | 内容 |
|------|----------|------|
| 2026-02-09 | 1.0 | 初版作成（1個追加のみ） |
| 2026-02-09 | 2.0 | スタンプ数を自由に編集できる機能に変更（+/-ボタン、1日1回制限解除） |
