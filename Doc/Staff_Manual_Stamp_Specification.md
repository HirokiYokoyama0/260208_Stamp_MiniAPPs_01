# スタッフ手動スタンプ付与機能 仕様書

## 概要

QRコードが読み取れない場合のリスク対応として、受付スタッフが手動でスタンプを付与できる機能。

---

## ユースケース

### 通常フロー
```
患者: QRコードをスキャン → 自動でスタンプ付与 ✅
```

### エラーケース（QR読み取り失敗）
- QRコードが破損/汚れている
- スマホカメラ故障
- 高齢者でQRスキャンが難しい
- ネットワークエラー

### リカバリーフロー
```
患者: 受付スタッフに相談
  ↓
スタッフ: 患者のスマホを預かる
  ↓
スタッフ: アプリ下部のバージョン表示を 3回連続タップ
  ↓
システム: 暗証番号入力ダイアログを表示
  ↓
スタッフ: 暗証番号「1234」を入力
  ↓
システム: スタンプを手動付与 ✅
  ↓
スタッフ: 患者にスマホを返却
```

---

## UI設計

### 1. 隠しリンクの配置

**場所:** ページ最下部のバージョン情報エリア

```
┌─────────────────────────────────────┐
│  スタンプ進捗表示                    │
└─────────────────────────────────────┘

─────────────────────────────────────
       v1.0.0 • dev
       ↑
     3回タップで暗証番号入力
```

### 2. 暗証番号入力ダイアログ

```
┌─────────────────────────────────────┐
│  スタッフ操作                        │
├─────────────────────────────────────┤
│                                      │
│  QRコードが読み取れない場合のみ      │
│  使用してください                    │
│                                      │
│  暗証番号（4桁）                     │
│  [ 1 ] [ 2 ] [ 3 ] [ 4 ]            │
│                                      │
│  [キャンセル]  [スタンプを付与]      │
└─────────────────────────────────────┘
```

### 3. 成功メッセージ

```
┌─────────────────────────────────────┐
│  ✅ スタンプを付与しました            │
│                                      │
│  現在 4 / 10個                      │
└─────────────────────────────────────┘
```

---

## 技術仕様

### 1. 暗証番号

| 項目 | 値 |
|-----|---|
| **暗証番号** | `1234` |
| **桁数** | 4桁 |
| **保存場所** | 環境変数 `NEXT_PUBLIC_STAFF_PIN` |
| **変更頻度** | 月次（推奨） |

### 2. APIエンドポイント

**エンドポイント:** `POST /api/stamps/manual`

**リクエスト:**
```json
{
  "userId": "U1234567890abcdef",
  "staffPin": "1234"
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "message": "スタンプを手動で付与しました",
  "stampCount": 4,
  "stampNumber": 4
}
```

**レスポンス（暗証番号エラー）:**
```json
{
  "success": false,
  "message": "暗証番号が間違っています",
  "error": "Invalid PIN"
}
```

### 3. データベース記録

**stamp_historyテーブル:**
```sql
INSERT INTO stamp_history (
  user_id,
  visit_date,
  stamp_number,
  stamp_method,        -- 'manual_admin'
  qr_code_id,          -- 'MANUAL-20260209-143015'
  notes,               -- 'スタッフ手動付与'
  created_at
) VALUES (...);
```

**手動付与の識別:**
- `stamp_method`: `'manual_admin'`（自動付与は `'qr_scan'`）
- `qr_code_id`: `MANUAL-{YYYYMMDD}-{HHMMSS}` 形式
- `notes`: `スタッフ手動付与`

---

## セキュリティ設計

### 1. 不正利用防止

| 対策 | 内容 |
|-----|------|
| **隠しリンク** | 3回連続タップでのみ表示 |
| **暗証番号** | スタッフのみ知っている |
| **監査証跡** | stamp_historyに手動付与を記録 |
| **スマホ預かり前提** | 患者自身は操作しない |

### 2. 監査ログ分析

```sql
-- 手動付与の履歴を確認
SELECT
  user_id,
  visit_date,
  stamp_number,
  qr_code_id,
  notes
FROM stamp_history
WHERE stamp_method = 'manual_admin'
ORDER BY visit_date DESC
LIMIT 20;
```

### 3. 不正検知

**月次チェック項目:**
- 手動付与の頻度（全体の5%以下が正常）
- 同一ユーザーの連続手動付与（要確認）
- 営業時間外の手動付与（異常）

---

## 環境変数設定

### .env.local（開発環境）
```env
NEXT_PUBLIC_STAFF_PIN=1234
```

### Vercel（本番環境）
```
Settings → Environment Variables
NEXT_PUBLIC_STAFF_PIN=1234
```

**注意:** 本番環境では定期的に変更してください（推奨: 月次）

---

## 操作手順（スタッフ向け）

### 1. 暗証番号入力画面の表示

1. 患者からスマホを預かる
2. LINEミニアプリを開く
3. ページ最下部のバージョン情報（`v1.0.0 • dev`）を **3回連続でタップ**
4. 暗証番号入力ダイアログが表示される

### 2. スタンプ付与

1. 暗証番号 `1234` を入力
2. 「スタンプを付与」ボタンをタップ
3. 成功メッセージを確認
4. 患者にスマホを返却

### 3. エラー時の対応

| エラー | 原因 | 対処 |
|-------|------|------|
| 暗証番号が間違っています | 入力ミス | 再度入力 |
| 本日すでにスタンプを取得済みです | 重複登録 | QRスキャンと同じ日の重複防止 |
| ユーザー情報の取得に失敗しました | ネットワークエラー | 時間をおいて再試行 |

---

## 制限事項

### 1. 重複防止

**制限:** 同日に複数回の手動付与はできない

**理由:** QRスキャンと同様、1日1回の制限

**エラーメッセージ:** 「本日すでにスタンプを取得済みです」

### 2. 暗証番号の管理

**運用ルール:**
- 暗証番号は受付スタッフのみに共有
- 月次で変更（推奨）
- 漏洩時は即座に変更

---

## トラブルシューティング

### Q1: 3回タップしても反応しない

**A:** タップ間隔が長すぎる可能性があります。2秒以内に3回タップしてください。

### Q2: 暗証番号を忘れた

**A:** 管理者に確認してください。環境変数 `NEXT_PUBLIC_STAFF_PIN` に記載されています。

### Q3: 手動付与後もスタンプ数が増えない

**A:** ページを再読み込みしてください。それでも解決しない場合はログを確認してください。

---

## 改訂履歴

| 日付 | バージョン | 内容 |
|------|----------|------|
| 2026-02-09 | 1.0 | 初版作成 |
