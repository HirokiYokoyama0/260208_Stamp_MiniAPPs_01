# å®Ÿè£…ã‚µãƒãƒªãƒ¼ - 2026å¹´2æœˆ8æ—¥

## ğŸ“Š æœ¬æ—¥ã®å®Ÿè£…å†…å®¹

### Phase 1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åŸºç›¤æ§‹ç¯‰ âœ… å®Œäº†

---

## 1. Supabaseé€£æºå®Ÿè£…

### 1-1. ç’°å¢ƒæ§‹ç¯‰
- **@supabase/supabase-js** (v2.48.1) ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- **lib/supabase.ts** ä½œæˆ: Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
- **.env.local** ç’°å¢ƒå¤‰æ•°è¨­å®š
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`

### 1-2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1ï¼ˆã‚·ãƒ³ãƒ—ãƒ«è¨­è¨ˆï¼‰ã‚’æ¡ç”¨**
- `id` ã‚«ãƒ©ãƒ ã‚’ TEXT å‹ã«ã—ã¦ã€LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç›´æ¥æ ¼ç´
- ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„æ§‹é€ 
- è¿…é€Ÿãªå®Ÿè£…ãŒå¯èƒ½

**profilesãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ :**

```sql
CREATE TABLE profiles (
  id TEXT PRIMARY KEY,              -- LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  line_user_id TEXT UNIQUE NOT NULL,
  display_name TEXT,
  picture_url TEXT,
  stamp_count INTEGER DEFAULT 0,
  ticket_number TEXT,
  last_visit_date TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**RLS (Row Level Security) è¨­å®š:**
- å…¨å“¡ãŒé–²è¦§å¯èƒ½ï¼ˆSELECTï¼‰
- å…¨å“¡ãŒæŒ¿å…¥å¯èƒ½ï¼ˆINSERTï¼‰
- å…¨å“¡ãŒæ›´æ–°å¯èƒ½ï¼ˆUPDATEï¼‰
- å°†æ¥çš„ã«ã€Œè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã€ã«å¤‰æ›´å¯èƒ½

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:**
- `idx_profiles_line_user_id` (line_user_id)
- `idx_profiles_last_visit_date` (last_visit_date) â€»ãƒªãƒã‚¤ãƒ³ãƒ‰æ©Ÿèƒ½ç”¨

---

## 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è‡ªå‹•ä¿å­˜æ©Ÿèƒ½

### å®Ÿè£…å†…å®¹

**app/page.tsx** ã® `useEffect` ã§å®Ÿè£…:

```typescript
const saveUserProfile = async () => {
  const { data, error } = await supabase.from("profiles").upsert({
    id: profile.userId,
    line_user_id: profile.userId,
    display_name: profile.displayName,
    picture_url: profile.pictureUrl,
    updated_at: new Date().toISOString(),
  }, {
    onConflict: "id",
  });
};
```

### å‹•ä½œ
1. **åˆå›ãƒ­ã‚°ã‚¤ãƒ³**: æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
2. **2å›ç›®ä»¥é™**: æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ï¼ˆUPSERTï¼‰
3. **è‡ªå‹•æ›´æ–°**: `updated_at` ãŒè‡ªå‹•çš„ã«æœ€æ–°ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚ã«æ›´æ–°

---

## 3. ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º

### å®Ÿè£…å†…å®¹

**useState ã§ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’ç®¡ç†:**
```typescript
const [stampCount, setStampCount] = useState(0);
```

**Supabaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—:**
```typescript
const fetchUserData = async (userId: string) => {
  const { data, error } = await supabase
    .from("profiles")
    .select("stamp_count, updated_at, ticket_number")
    .eq("id", userId)
    .single();

  if (data) {
    setStampCount(data.stamp_count ?? 0);
    // ...
  }
};
```

### å‹•ä½œãƒ•ãƒ­ãƒ¼
1. LINEãƒ­ã‚°ã‚¤ãƒ³ â†’ profileå–å¾—
2. Supabaseã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’UPSERT
3. æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— (`fetchUserData`)
4. ç”»é¢ã«åæ˜ 

---

## 4. è¨ºå¯Ÿåˆ¸ç•ªå·è¡¨ç¤ºæ©Ÿèƒ½

### å®Ÿè£…å†…å®¹

**DB ã‚«ãƒ©ãƒ **: `ticket_number` (TEXT, NULLå¯)
**ç”»é¢è¡¨ç¤º**: `è¨ºå¯Ÿåˆ¸ç•ªå·: {displayTicketNumber}`

```typescript
const [ticketNumber, setTicketNumber] = useState<string | null>(null);
const displayTicketNumber = ticketNumber ?? "æœªç™»éŒ²";
```

### è¡¨ç¤ºãƒ‘ã‚¿ãƒ¼ãƒ³
| DBã®å€¤ | ç”»é¢è¡¨ç¤º |
|-------|---------|
| NULL | `è¨ºå¯Ÿåˆ¸ç•ªå·: æœªç™»éŒ²` |
| "1234-5678" | `è¨ºå¯Ÿåˆ¸ç•ªå·: 1234-5678` |

---

## 5. æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚è¡¨ç¤ºæ©Ÿèƒ½

### å®Ÿè£…å†…å®¹

**DB ã‚«ãƒ©ãƒ **: `updated_at` (TIMESTAMPTZ, è‡ªå‹•æ›´æ–°)
**ç”»é¢è¡¨ç¤º**: `æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹: 2026å¹´2æœˆ8æ—¥ 20:45`

```typescript
const formatDate = (dateString: string | null): string => {
  if (!dateString) return "æœªç™»éŒ²";

  const date = new Date(dateString);
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const hours = date.getHours();
  const minutes = date.getMinutes().toString().padStart(2, "0");

  return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
};
```

### æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- **åˆå›ãƒ­ã‚°ã‚¤ãƒ³**: æ–°è¦ä½œæˆæ™‚ã®æ™‚åˆ»
- **2å›ç›®ä»¥é™**: ã‚¢ãƒ—ãƒªã‚’é–‹ããŸã³ã«æ›´æ–°
- **UPSERTå®Ÿè¡Œæ™‚**: è‡ªå‹•çš„ã«æœ€æ–°æ™‚åˆ»ã«æ›´æ–°

---

## ğŸ“± ãƒ‡ã‚¸ã‚¿ãƒ«è¨ºå¯Ÿåˆ¸ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ‡ã‚¸ã‚¿ãƒ«è¨ºå¯Ÿåˆ¸                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å±±ç”°å¤ªéƒ                          â”‚
â”‚ è¨ºå¯Ÿåˆ¸ç•ªå·: 1234-5678            â”‚
â”‚ æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹: 2026å¹´2æœˆ8æ—¥ 20:45 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¾åœ¨ã®ã‚¹ã‚¿ãƒ³ãƒ—é€²æ—                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é€šé™¢ã‚¹ã‚¿ãƒ³ãƒ—          3 / 10     â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 30%        â”‚
â”‚ ã‚ã¨7å›ã§ã”ã»ã†ã³äº¤æ›å¯èƒ½ã§ã™     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›  æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆæ›´æ–°ï¼‰

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|---------|------|-----------|
| **Frontend** | Next.js (App Router, Turbopack) | 16.1.6 |
| **React** | React | 19.2.4 |
| **TypeScript** | TypeScript | 5.x |
| **UI** | Tailwind CSS | 3.4.1 |
| **Icons** | Lucide React | 0.460.0 |
| **LINE SDK** | @line/liff | 2.26.1 |
| **Backend/Database** | Supabase | - |
| **Supabase Client** | @supabase/supabase-js | 2.48.1 |

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œ

- âœ… Next.js 15.1.0 â†’ 16.1.6 (CVE-2025-66478 è„†å¼±æ€§å¯¾å¿œ)
- âœ… React 19.0.0 â†’ 19.2.4
- âœ… eslint-config-next 15.1.0 â†’ 16.1.6
- âœ… ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§: **0ä»¶**
- âœ… .gitignore ã« `.claude`, `.env.local`, `/test` ã‚’è¿½åŠ 

---

## ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã®å¤‰æ›´

### æ–°è¦è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«

```
lib/
â””â”€â”€ supabase.ts              # Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š

supabase/
â””â”€â”€ 001_create_profiles_table.sql  # ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆSQL

Doc/
â”œâ”€â”€ TODO.md                  # ã‚¿ã‚¹ã‚¯ç®¡ç†ï¼ˆPhase 1å®Œäº†ãƒãƒ¼ã‚¯ï¼‰
â”œâ”€â”€ Supabase_Setup.md       # è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1/2ã®æ¯”è¼ƒï¼‰
â””â”€â”€ Supabase_Setup_Instructions.md  # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †æ›¸
```

### æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«

```
app/
â””â”€â”€ page.tsx                 # Supabaseé€£æºã€ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºæ©Ÿèƒ½è¿½åŠ 

Doc/
â”œâ”€â”€ TODO.md                  # Phase 1å®Œäº†ã€æœ€æ–°ã‚¿ã‚¹ã‚¯åæ˜ 
â””â”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ.md            # Supabaseé–¢é€£ã®è¿½è¨˜
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ

**Supabaseæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆnpx tsx test/supabase-connection.tsï¼‰**

| ãƒ†ã‚¹ãƒˆé …ç›® | çµæœ |
|----------|------|
| ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ | âœ… æˆåŠŸ |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª | âœ… æˆåŠŸ |
| ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥ | âœ… æˆåŠŸ |
| ãƒ‡ãƒ¼ã‚¿ã®å–å¾— | âœ… æˆåŠŸ |
| ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ï¼ˆUPSERTï¼‰ | âœ… æˆåŠŸ |
| ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ | âœ… æˆåŠŸ |

**ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯:**
```
found 0 vulnerabilities
```

---

## ğŸš€ Vercelãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™

### å¿…é ˆç’°å¢ƒå¤‰æ•°ï¼ˆVercel Settingsï¼‰

| Variable Name | èª¬æ˜ |
|--------------|------|
| `NEXT_PUBLIC_LIFF_ID` | LINE LIFF ID |
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase Project URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase Anon Key |

### ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †
1. Vercel Dashboard â†’ Settings â†’ Environment Variables
2. ä¸Šè¨˜3ã¤ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
3. Environment: Production, Preview, Development ã™ã¹ã¦ã«ãƒã‚§ãƒƒã‚¯
4. Saveå¾Œã€Redeploy

### Gitãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ…‹
- âœ… æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: `a3445dc` (feat: è¨ºå¯Ÿåˆ¸ç•ªå·ã‚’Supabaseã‹ã‚‰å–å¾—ã—ã¦è¡¨ç¤º)
- âœ… ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿: `origin/main`
- âœ… Vercelè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤: æœ‰åŠ¹

---

## ğŸ“ Gitã‚³ãƒŸãƒƒãƒˆå±¥æ­´ï¼ˆæœ¬æ—¥ï¼‰

```
a3445dc - feat: è¨ºå¯Ÿåˆ¸ç•ªå·ã‚’Supabaseã‹ã‚‰å–å¾—ã—ã¦è¡¨ç¤º
6f657e5 - feat: æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹æ—¥æ™‚ã‚’è¡¨ç¤º
6a1e543 - feat: Supabaseã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’å–å¾—ã—ã¦è¡¨ç¤º
16b0264 - chore: testãƒ•ã‚©ãƒ«ãƒ€ã¨ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
46b091f - feat: Supabaseé€£æºã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜æ©Ÿèƒ½ã‚’å®Ÿè£…
```

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆPhase 2ï¼‰

### ã‚¹ã‚¿ãƒ³ãƒ—æ©Ÿèƒ½ã®å®Œå…¨å®Ÿè£…

1. **QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³æ™‚ã®ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ä¸**
   - QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š â†’ stamp_count + 1
   - `last_visit_date` æ›´æ–°
   - åŒæ—¥ã®äºŒé‡ç™»éŒ²é˜²æ­¢

2. **ã‚¹ã‚¿ãƒ³ãƒ—ãƒšãƒ¼ã‚¸ï¼ˆ/stampï¼‰å®Ÿè£…**
   - ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§è¡¨ç¤ºï¼ˆã‚«ãƒ¼ãƒ‰å‹ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
   - æ¥é™¢å±¥æ­´è¡¨ç¤º
   - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼

3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°**
   - ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—å¾Œã®ç”»é¢è‡ªå‹•æ›´æ–°
   - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 

---

## ğŸ“Œ ãƒ¡ãƒ¢

### ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œ

```
LINEãƒ­ã‚°ã‚¤ãƒ³
    â†“
profileå–å¾—
    â†“
Supabase UPSERT (id, line_user_id, display_name, picture_url, updated_at)
    â†“
fetchUserData (stamp_count, updated_at, ticket_number)
    â†“
ç”»é¢è¡¨ç¤ºæ›´æ–°
```

### ä»Šå¾Œã®æ©Ÿèƒ½æ‹¡å¼µæ€§

ç¾åœ¨ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1ï¼ˆã‚·ãƒ³ãƒ—ãƒ«è¨­è¨ˆï¼‰ã¯ï¼š
- âœ… è¿…é€Ÿãªå®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆãŒå¯èƒ½
- âœ… LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ç›´æ¥ä½¿ç”¨
- âš ï¸ å°†æ¥çš„ã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2ï¼ˆUUID + Supabase Authï¼‰ã¸ã®ç§»è¡Œã‚‚å¯èƒ½

---

## æ”¹è¨‚å±¥æ­´

| æ—¥ä»˜ | å†…å®¹ |
|------|------|
| 2026-02-08 | å®Ÿè£…ã‚µãƒãƒªãƒ¼ä½œæˆ |
