# 家族管理機能 - ユーザータイプとケース分類

**最終更新日**: 2026-02-28
**バージョン**: 1.0.0

---

## 📋 目的

本ドキュメントは、家族管理機能における**ユーザーの状態**と**利用可能な操作**を明確に分類し、開発者・運用者が正しくユーザーフローを理解できるようにするためのものです。

---

## 🧑‍🤝‍🧑 家族管理の基本概念

### 家族グループとは

- **家族グループ**: 複数のユーザー（親・子）が一緒にスタンプを貯める仕組み
- **代表者（親）**: 家族を作成したユーザー。家族の管理権限を持つ
- **子**: 家族に参加したユーザー。自分の情報のみ閲覧可能
- **代理管理メンバー（スマホなし子供）**: LINE User IDを持たず、親が代わりに登録・管理するメンバー

### 家族の種類

| 種類 | LINE User ID | 登録方法 | 管理方法 |
|-----|-------------|---------|---------|
| **スマホあり家族** | ✅ あり | 招待コードで参加 | 自分で操作 |
| **スマホなし子供** | ❌ なし（`NULL`） | 親が代理登録 | 親が代理操作 |

---

## 📊 ユーザーの状態分類

### データベーステーブル: `profiles`

| カラム | 説明 | 値の例 |
|--------|-----|-------|
| `id` | LINE User ID（主キー） | `U1234567890abcdef...` |
| `family_id` | 所属する家族のID | `fam_xxx...` or `NULL` |
| `family_role` | 家族内の役割 | `'parent'` / `'child'` / `NULL` |

### 5つの主要ケース

| ケース | `family_role` | `family_id` | 状態の説明 | 想定ユーザー |
|--------|--------------|------------|-----------|------------|
| **① 新規ユーザー** | `NULL` | `NULL` | 家族未参加 | アプリ初回利用者 |
| **② 親（家族未作成）** | `'parent'` | `NULL` | 親ロールだが家族未作成（理論上は発生しない） | エラー状態 |
| **③ 子（家族未参加）** | `'child'` | `NULL` | 子ロールだが家族未参加（理論上は発生しない） | エラー状態 |
| **④ 親（家族参加済み）** | `'parent'` | `'fam_xxx'` | 家族の代表者 | 保護者 |
| **⑤ 子（家族参加済み）** | `'child'` | `'fam_xxx'` | 家族のメンバー | スマホを持っている子供 |

**注意**: ケース②・③は通常発生しません。家族作成・参加時に`family_id`と`family_role`が同時に設定されるためです。

---

## 🚪 ユーザータイプ別の利用フロー

### パターンA: 親として家族を作成したい

**対象ユーザー**: ケース① 新規ユーザー（`family_role = NULL`, `family_id = NULL`）

#### フロー

```
設定画面
  ↓
「家族グループを作成」ボタンをタップ
  ↓
/family/create （家族作成画面）
  ↓
家族名を入力して「家族グループを作成」
  ↓
POST /api/families/create
  ↓
profiles更新: family_role = 'parent', family_id = 作成された家族ID
  ↓
/family/manage （家族管理画面）へリダイレクト
  ↓
【次のステップ】
- 「👶 スマホなしの子供を追加」ボタンで代理登録
- 招待コードをコピーして、スマホを持っている家族に共有
```

#### 使用画面・API

| 種類 | パス | 説明 |
|-----|------|-----|
| 画面 | `/family/create` | 家族作成画面 |
| API | `POST /api/families/create` | 家族グループ新規作成 |
| 画面 | `/family/manage` | 家族管理画面 |

---

### パターンB: 子として既存の家族に参加したい

**対象ユーザー**: ケース① 新規ユーザー（`family_role = NULL`, `family_id = NULL`）

#### フロー

```
設定画面
  ↓
「家族に参加」ボタンをタップ
  ↓
/family/join （家族参加画面）
  ↓
招待コードを入力（またはペースト）して「家族に参加」
  ↓
POST /api/families/join
  ↓
profiles更新: family_role = 'child', family_id = 参加した家族ID
  ↓
/ （ホーム画面）へリダイレクト
  ↓
【次のステップ】
- 家族全体のスタンプを確認
- 自分のスタンプを貯める
```

#### 使用画面・API

| 種類 | パス | 説明 |
|-----|------|-----|
| 画面 | `/family/join` | 家族参加画面（招待コード入力） |
| API | `POST /api/families/join` | 既存家族に参加 |

---

### パターンC: 親が家族を管理する

**対象ユーザー**: ケース④ 親（家族参加済み）（`family_role = 'parent'`, `family_id = 'fam_xxx'`）

#### フロー

```
設定画面
  ↓
「家族の管理」ボタンをタップ
  ↓
/family/manage （家族管理画面）
  ↓
【できること】
- 家族名の編集
- スマホなしの子供を追加（代理登録）
- メンバーの編集・削除
- 招待コードのコピー（スマホあり家族を招待）
- スマホなし子供のキッズモードを開く
```

#### 使用画面・API

| 種類 | パス | 説明 |
|-----|------|-----|
| 画面 | `/family/manage` | 家族管理画面 |
| API | `POST /api/families/members/add` | スマホなし子供追加 |
| API | `PATCH /api/families/update` | 家族名更新 |
| API | `PATCH /api/families/members/[memberId]` | メンバー情報更新 |
| API | `DELETE /api/families/members/[memberId]` | メンバー削除 |

---

### パターンD: 子が家族情報を確認する

**対象ユーザー**: ケース⑤ 子（家族参加済み）（`family_role = 'child'`, `family_id = 'fam_xxx'`）

#### フロー

```
設定画面
  ↓
「家族情報」ボタンをタップ
  ↓
/family/manage （家族管理画面）
  ↓
【できること】
- 家族名の閲覧
- 家族全体のスタンプ数の確認
- メンバー一覧の閲覧（編集・削除はできない）
```

**注意**: 現在は親と同じ `/family/manage` 画面を使用していますが、将来的には子供専用の閲覧画面を実装予定。

---

## 🖥️ 設定画面の表示ロジック

### 家族管理セクション（設定画面）

[app/settings/page.tsx:306-376](app/settings/page.tsx#L306-L376)

#### 表示パターン

| 条件 | 表示内容 | 遷移先 |
|-----|---------|-------|
| `family_role === 'parent'` かつ `family_id !== null` | 「家族の管理」ボタン（1つ） | `/family/manage` |
| `family_role === 'child'` かつ `family_id !== null` | 「家族情報」ボタン（1つ） | `/family/manage` |
| `family_role === NULL` または `family_id === NULL` | 「家族グループを作成」と「家族に参加」の2つのボタン | `/family/create` または `/family/join` |

#### コード例

```typescript
{(familyRole && familyId) ? (
  // 家族参加済み → 管理画面へ
  <button onClick={() => router.push('/family/manage')}>
    {familyRole === 'parent' && '家族の管理'}
    {familyRole === 'child' && '家族情報'}
  </button>
) : (
  // 家族未参加 → 2つの選択肢
  <div>
    <button onClick={() => router.push('/family/create')}>
      家族グループを作成
    </button>
    <button onClick={() => router.push('/family/join')}>
      家族に参加
    </button>
  </div>
)}
```

---

## 🔄 状態遷移図

```
【新規ユーザー】
family_role = NULL, family_id = NULL
         │
         ├─→ 親として家族作成 → POST /api/families/create
         │                      ↓
         │                   family_role = 'parent'
         │                   family_id = 新規作成ID
         │                      ↓
         │                   【親（家族参加済み）】
         │
         └─→ 子として家族参加 → POST /api/families/join
                                ↓
                             family_role = 'child'
                             family_id = 参加先の家族ID
                                ↓
                             【子（家族参加済み）】
```

---

## 🧪 テストケース

### 1. 新規ユーザーが家族を作成

**前提条件**:
- `family_role = NULL`, `family_id = NULL`

**操作**:
1. 設定画面を開く
2. 「家族グループを作成」をタップ
3. 家族名「テスト家族」を入力
4. 「家族グループを作成」をタップ

**期待結果**:
- `family_role = 'parent'`
- `family_id = 新しい家族ID`
- `/family/manage` に遷移
- 家族名「テスト家族」が表示される

---

### 2. 新規ユーザーが既存家族に参加

**前提条件**:
- `family_role = NULL`, `family_id = NULL`
- 既存の家族ID: `fam_abc123`

**操作**:
1. 設定画面を開く
2. 「家族に参加」をタップ
3. 招待コード「fam_abc123」を入力
4. 「家族に参加」をタップ

**期待結果**:
- `family_role = 'child'`
- `family_id = 'fam_abc123'`
- `/` (ホーム画面) に遷移

---

### 3. 親がスマホなし子供を追加

**前提条件**:
- `family_role = 'parent'`, `family_id = 'fam_abc123'`

**操作**:
1. 設定画面 → 「家族の管理」をタップ
2. 「👶 スマホなしの子供を追加」をタップ
3. 名前「太郎」、診察券番号「123456」を入力
4. 「追加」をタップ

**期待結果**:
- 新しいprofileレコードが作成される
  - `id = 自動生成UUID`
  - `line_user_id = NULL`
  - `real_name = '太郎'`
  - `ticket_number = '123456'`
  - `family_id = 'fam_abc123'`
  - `family_role = 'child'`
- メンバー一覧に「太郎」が表示される

---

## 🚨 エラーケース

### 1. すでに家族に参加済みのユーザーが再度参加しようとする

**シナリオ**: `family_id` が既に設定されているユーザーが、別の招待コードで参加しようとする

**処理**:
- `POST /api/families/join` でエラーを返す
- エラーメッセージ: 「すでに他の家族に参加しています」

---

### 2. すでに家族を作成済みのユーザーが再度作成しようとする

**シナリオ**: `family_id` が既に設定されているユーザーが、新しい家族を作成しようとする

**処理**:
- `POST /api/families/create` でエラーを返す
- エラーメッセージ: 「すでに他の家族に参加しています」

---

## 📁 関連ファイル一覧

### 画面（Pages）

| ファイルパス | 説明 |
|------------|-----|
| `app/settings/page.tsx` | 設定画面（家族管理セクション含む） |
| `app/family/create/page.tsx` | 家族作成画面 |
| `app/family/join/page.tsx` | 家族参加画面（招待コード入力） |
| `app/family/manage/page.tsx` | 家族管理画面（親・子共通） |

### API Routes

| ファイルパス | 説明 |
|------------|-----|
| `app/api/families/create/route.ts` | 家族作成API |
| `app/api/families/join/route.ts` | 家族参加API |
| `app/api/families/me/route.ts` | 自分の家族情報取得API |
| `app/api/families/update/route.ts` | 家族名更新API |
| `app/api/families/members/add/route.ts` | スマホなし子供追加API |
| `app/api/families/members/[memberId]/route.ts` | メンバー編集・削除API |

### コンポーネント

| ファイルパス | 説明 |
|------------|-----|
| `components/AddChildDialog.tsx` | スマホなし子供追加ダイアログ |

---

## 💡 よくある質問（FAQ）

### Q1: スマホを持っている子供とスマホなし子供の違いは？

**A**:

| 項目 | スマホあり子供 | スマホなし子供 |
|-----|-------------|-------------|
| LINE User ID | ✅ あり | ❌ なし（`NULL`） |
| 登録方法 | 招待コードで参加 | 親が代理登録 |
| ログイン | 自分のLINEでログイン | 親がキッズモードで開く |
| 操作 | 自分で操作可能 | 親が代理操作 |

---

### Q2: 家族に参加していないユーザーは何ができる？

**A**:
- 自分のスタンプを貯める（個人として）
- 特典交換
- 診察券表示
- **家族作成または家族参加を選択**

---

### Q3: 親が削除されたら家族はどうなる？

**A**:
現在の実装では、親（`representative_user_id`）の削除は想定していません。将来的には：
- 親の削除を禁止
- または、別のメンバーを代表者に昇格させる機能を実装予定

---

## 📌 今後の改善予定

- [ ] 子供専用の家族情報閲覧画面を作成（`/family/view`）
- [ ] 家族から脱退する機能
- [ ] 代表者の権限委譲機能
- [ ] QRコードでの家族参加機能
- [ ] 家族の統計・分析ダッシュボード

---

**作成者**: Claude Code
**最終更新日**: 2026-02-28
