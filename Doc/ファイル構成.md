# つくばホワイト歯科 × ハブラーシカ LINEミニアプリ　ファイル構成

## フォルダ・ファイル一覧

```
260208_Stamp_MiniAPPs_01/
├── app/
│   ├── layout.tsx        # ルートレイアウト（Noto Sans JP、AppLayout）
│   ├── page.tsx          # ホーム画面（診察券、スタンプ進捗、Supabase連携、QRスキャン）
│   ├── globals.css
│   ├── api/
│   │   └── stamps/
│   │       └── route.ts  # スタンプ登録API（POST /api/stamps）
│   ├── stamp/page.tsx    # スタンプページ（完全実装：履歴、カウンター、QRスキャン）
│   ├── care/page.tsx     # ケア記録タブ（プレースホルダー）
│   └── info/page.tsx     # 医院情報タブ（プレースホルダー）
├── components/
│   ├── layout/
│   │   └── AppLayout.tsx # ヘッダー＋4タブボトムナビ
│   └── features/
│       └── QRScanner.tsx # liff.scanCodeV2() 呼び出しボタン
├── hooks/
│   └── useLiff.ts        # LIFF初期化・ログイン状態管理
├── lib/
│   ├── supabase.ts       # Supabaseクライアント設定
│   └── stamps.ts         # スタンプユーティリティ関数
├── types/
│   └── stamp.ts          # スタンプ機能の型定義
├── supabase/
│   ├── 001_create_profiles_table.sql  # profilesテーブル作成SQL
│   └── 002_create_stamp_history_table.sql  # stamp_historyテーブル作成SQL
├── Doc/
│   ├── つくばホワイト歯科_ハブラーシカ_LINEミニアプリ仕様書_大人版.md
│   ├── ファイル構成.md   # 本ファイル
│   ├── TODO.md           # 開発タスク管理
│   ├── Implementation_Summary_20260208.md  # Phase 1実装サマリー
│   ├── Implementation_Summary_20260209.md  # Phase 2実装サマリー
│   ├── Supabase_Setup.md # Supabase設計ドキュメント
│   └── Supabase_Setup_Instructions.md  # セットアップ手順書
├── package.json
├── tsconfig.json
├── next.config.ts
├── tailwind.config.ts    # スカイブルー・シャンパンゴールドのカスタム色
├── postcss.config.mjs
├── eslint.config.mjs
├── .env.local            # 環境変数（LIFF_ID, Supabase接続情報）
└── .gitignore
```

---

## 主な実装内容

| 項目 | 内容 |
|------|------|
| **useLiff** | `liff.init`、ログイン状態、プロフィール取得。`NEXT_PUBLIC_LIFF_ID` を参照 |
| **AppLayout** | 「つくばホワイト歯科」ヘッダー＋診察券/スタンプ/ケア記録/医院情報の4タブ |
| **page.tsx** | デジタル診察券カード、ハブラーシカメッセージ、QRスキャンボタン、スタンプ進捗ゲージ、Supabaseデータ表示 |
| **stamp/page.tsx** | スタンプカウンター、来院履歴リスト、QRスキャン、プログレスバー |
| **QRScanner** | `liff.scanCodeV2()` を呼ぶ「来院スタンプを読み取る」ボタン |
| **supabase.ts** | Supabaseクライアント初期化、接続設定 |
| **stamps.ts** | スタンプ関連のユーティリティ関数（fetchStampCount, fetchStampHistory, addStamp等） |
| **api/stamps/route.ts** | スタンプ登録API（重複チェック機能付き） |

## Supabase連携機能

| 機能 | 説明 |
|-----|------|
| **ユーザー情報保存** | LINEログイン時に自動的にprofilesテーブルにUPSERT（id, line_user_id, display_name, picture_url） |
| **スタンプ数表示** | Supabaseから `stamp_count` を取得してリアルタイム表示（Single Source of Truth） |
| **スタンプ履歴管理** | stamp_historyテーブルで来院履歴を記録、トリガーでprofilesを自動更新 |
| **重複チェック** | 同日同QRの二重登録を防止 |
| **診察券番号表示** | Supabaseから `ticket_number` を取得して表示（未登録時は「未登録」） |
| **最終アクセス日時** | `updated_at` を日本語フォーマット（例: 2026年2月8日 20:45）で表示 |

---

## 開発環境

| 項目 | バージョン |
|------|----------|
| **Next.js** | 16.1.6 (Turbopack) |
| **React** | 19.2.4 |
| **TypeScript** | 5.x |
| **Tailwind CSS** | 3.4.1 |
| **@line/liff** | 2.26.1 |
| **@supabase/supabase-js** | 2.48.1 |

---

## 最近のアップデート履歴

| 日付 | 内容 |
|------|------|
| 2026-02-09 | **Phase 2完了**：スタンプ機能完全実装 |
| 2026-02-09 | stamp_historyテーブル作成、トリガー実装 |
| 2026-02-09 | スタンプ登録API実装（POST /api/stamps、重複チェック機能） |
| 2026-02-09 | スタンプページUI完全実装（カウンター、履歴リスト、プログレスバー） |
| 2026-02-09 | データ統一アーキテクチャ確立（Single Source of Truth） |
| 2026-02-09 | lib/stamps.ts ユーティリティ関数追加、types/stamp.ts 型定義追加 |
| 2026-02-08 | **Phase 1完了**：バックエンド基盤構築 |
| 2026-02-08 | Next.js 15.1.0 → 16.1.6 にアップデート（CVE-2025-66478 脆弱性対応） |
| 2026-02-08 | React 19.0.0 → 19.2.4 にアップデート |
| 2026-02-08 | .gitignoreに `.claude` と `.env.local` を追加 |
| 2026-02-08 | Supabase連携実装：profilesテーブル、ユーザー情報自動保存、スタンプ数表示 |
| 2026-02-08 | 最終アクセス日時（updated_at）と診察券番号（ticket_number）の表示機能追加 |
