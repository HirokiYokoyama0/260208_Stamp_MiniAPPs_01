# つくばホワイト歯科 × ハブラーシカ LINEミニアプリ　ファイル構成

## フォルダ・ファイル一覧

```
260208_Stamp_MiniAPPs_01/
├── app/
│   ├── layout.tsx            # ルートレイアウト（Noto Sans JP、AppLayout）
│   ├── page.tsx              # ホーム画面（viewMode分岐 → AdultHome / KidsHome）
│   ├── globals.css
│   ├── api/
│   │   ├── stamps/
│   │   │   ├── route.ts      # スタンプ登録API（POST /api/stamps）
│   │   │   ├── manual/
│   │   │   │   └── route.ts  # スタッフ手動スタンプAPI（POST /api/stamps/manual）
│   │   │   └── scan/
│   │   │       ├── route.ts        # QRスキャン専用API（POST /api/stamps/scan）
│   │   │       └── delete-today/
│   │   │           └── route.ts    # テスト用：本日のQRスキャン削除API
│   │   └── rewards/
│   │       ├── route.ts      # 特典一覧取得API（GET /api/rewards）
│   │       └── exchange/
│   │           └── route.ts  # 特典交換API（POST /api/rewards/exchange）
│   ├── stamp/page.tsx        # スタンプページ（viewMode分岐）
│   ├── scan/page.tsx         # QRコードスキャンページ（LIFF scanCodeV2使用）
│   ├── rewards/page.tsx      # 特典交換ページ（viewMode分岐）
│   ├── care/page.tsx         # ケア記録タブ（viewMode分岐）
│   ├── info/page.tsx         # 医院情報タブ（viewMode分岐）
│   ├── settings/page.tsx     # 設定ページ（大人用/子供用モード切替）
│   └── slot/page.tsx         # スロットゲームページ（プレースホルダー）
├── components/
│   ├── layout/
│   │   ├── AppLayout.tsx     # ヘッダー＋5タブボトムナビ、ViewModeProvider、KidsSlotButton
│   │   └── VersionInfo.tsx   # バージョン情報表示コンポーネント
│   ├── features/
│   │   └── FriendshipPromptModal.tsx  # LINE友だち登録促進モーダル
│   ├── survey/
│   │   ├── SurveyModal.tsx   # アンケートモーダル（大人用ホームで表示）
│   │   ├── SurveyForm.tsx    # アンケートフォーム本体
│   │   ├── SurveyCompleted.tsx # アンケート完了画面
│   │   ├── StarRating.tsx    # 5段階評価（星）コンポーネント
│   │   └── NPSScale.tsx      # NPS（0-10）スケールコンポーネント
│   ├── shared/
│   │   ├── QRScanner.tsx     # liff.scanCodeV2() 呼び出しボタン
│   │   ├── StaffPinModal.tsx # スタッフ手動スタンプモーダル（2ステップUI）
│   │   └── KidsSlotButton.tsx # 子供用スロットボタン（フローティング、ボトムナビ左上）
│   ├── (adult)/
│   │   ├── AdultHome.tsx         # 大人用ホーム（診察券、スタンプ進捗、QRスキャン）
│   │   ├── AdultStampPage.tsx    # 大人用スタンプページ（履歴、カウンター）
│   │   ├── AdultRewardsPage.tsx  # 大人用特典交換ページ
│   │   ├── AdultCarePage.tsx     # 大人用ケア記録（プレースホルダー）
│   │   └── AdultInfoPage.tsx     # 大人用医院情報（設定リンク付き）
│   └── (kids)/
│       ├── KidsHome.tsx          # 子供用ホーム（プレースホルダー）
│       ├── KidsStampPage.tsx     # 子供用スタンプページ（プレースホルダー）
│       ├── KidsRewardsPage.tsx   # 子供用特典交換ページ（プレースホルダー）
│       ├── KidsCarePage.tsx      # 子供用ケア記録（プレースホルダー）
│       └── KidsInfoPage.tsx      # 子供用医院情報（プレースホルダー）
├── contexts/
│   └── ViewModeContext.tsx   # 表示モード管理（adult/kids切替、Supabase連携）
├── hooks/
│   └── useLiff.ts            # LIFF初期化・ログイン状態管理
├── lib/
│   ├── supabase.ts           # Supabaseクライアント設定
│   ├── stamps.ts             # スタンプユーティリティ関数
│   ├── rewards.ts            # 特典ユーティリティ関数（Phase 2.5）
│   ├── analytics.ts          # イベントログ送信ユーティリティ（Phase 2.7）
│   └── version.ts            # バージョン情報取得
├── types/
│   ├── stamp.ts              # スタンプ機能の型定義
│   ├── reward.ts             # 特典機能の型定義（Phase 2.5）
│   ├── viewMode.ts           # 表示モードの型定義（ViewMode, PageProps等）
│   └── liff.d.ts             # LIFF SDK型定義拡張（scanCodeV2メソッド）
├── supabase/
│   ├── 001_create_profiles_table.sql                 # profilesテーブル作成
│   ├── 002_create_stamp_history_table.sql            # stamp_historyテーブル作成
│   ├── 003_create_rewards_tables.sql                 # rewards/reward_exchangesテーブル作成
│   ├── 004_add_is_line_friend_column.sql             # 友だち登録フラグ追加
│   ├── 005_add_view_mode_column.sql                  # 表示モードカラム追加
│   ├── 006-014_...                                   # その他のマイグレーション
│   ├── 015_create_event_logs_table_ForUser.sql       # イベントログテーブル作成（Phase 2.7）
│   ├── 016_add_delete_policy_stamp_history.sql       # DELETE RLSポリシー追加（Phase 2.7）
│   ├── 017_create_survey_tables.sql                  # アンケート機能テーブル作成（surveys/survey_questions/survey_responses）
│   └── 018_fix_survey_reward_trigger.sql             # アンケート報酬バグ修正（来院回数カウント除外）
├── scripts/
│   └── update-version.mjs    # バージョン自動更新スクリプト（Gitタグ連携）
├── public/
│   └── images/
│       └── haburashika.jpg   # ハブラーシカ画像（子供用ページで使用）
├── Doc/
│   ├── つくばホワイト歯科_ハブラーシカ_LINEミニアプリ仕様書_大人版.md
│   ├── Kids_Mode_Specification.md     # 子供用モード仕様書
│   ├── Feature_Specifications.md      # 機能仕様書（統合版: スタンプ/特典/スタッフ操作/友だち登録）
│   ├── Implementation_Summary.md      # 実装サマリー（追記型、全日付統合）
│   ├── Specification_Change_Log.md    # 仕様変更履歴（v1.1: 積み上げ式変更）
│   ├── TODO.md                        # 開発タスク管理
│   ├── ファイル構成.md                # 本ファイル
│   └── archive/                       # アーカイブ（統合前の個別ファイル）
│       ├── Implementation_Summary_20260208.md
│       ├── Implementation_Summary_20260209.md
│       ├── Implementation_Summary_20260211.md
│       ├── Stamp_System_Design.md
│       ├── Rewards_System_Specification.md
│       ├── Staff_Manual_Stamp_Specification.md
│       ├── LINE_Friendship_Feature_Specification.md
│       ├── Supabase_Setup.md
│       ├── Supabase_Setup_Instructions.md
│       └── Version_Management.md
├── package.json
├── tsconfig.json
├── next.config.mjs
├── tailwind.config.ts        # カスタム色（primary/accent + kids-*）、子供用フォント
├── postcss.config.mjs
├── eslint.config.mjs
├── .env.local                # 環境変数（LIFF_ID, Supabase接続情報）
└── .gitignore
```

---

## 主な実装内容

| 項目 | 内容 |
|------|------|
| **useLiff** | `liff.init`、ログイン状態、プロフィール取得、`liff.getFriendship()`。`NEXT_PUBLIC_LIFF_ID` を参照 |
| **AppLayout** | 「つくばホワイト歯科」ヘッダー＋診察券/スタンプ/特典/ケア記録/医院情報の5タブ。ViewModeProviderでラップ |
| **ViewModeContext** | 大人用/子供用の表示モード管理。Supabase profiles.view_modeと同期 |
| **page.tsx（各ページ共通）** | `useViewMode()`でモード判定 → Adult/Kidsコンポーネントに分岐 |
| **AdultHome** | デジタル診察券カード、ハブラーシカメッセージ、QRスキャン、スタンプ進捗ゲージ |
| **AdultStampPage** | スタンプカウンター、来院履歴リスト、QRスキャン、プログレスバー |
| **AdultRewardsPage** | 特典交換ページ（スタンプ数表示、特典一覧、交換機能） |
| **AdultInfoPage** | 医院情報、設定ページへのリンク |
| **Kids*（各ページ）** | 子供用UIプレースホルダー（Phase 3で本実装予定） |
| **settings/page.tsx** | 大人用/子供用モード切替UI |
| **QRScanner** | `liff.scanCodeV2()` を呼ぶ「来院スタンプを読み取る」ボタン（shared/に配置） |
| **StaffPinModal** | スタッフ手動スタンプモーダル（2ステップUI、+/-ボタン）（shared/に配置） |
| **FriendshipPromptModal** | LINE公式アカウント友だち登録促進モーダル |
| **supabase.ts** | Supabaseクライアント初期化、接続設定、`getSupabaseAdmin()`でサービスロールキー使用 |
| **stamps.ts** | スタンプ関連ユーティリティ（fetchStampCount, fetchVisitCount, fetchStampHistory, addStamp, getStampMethodLabel, getStampMethodIcon等） |
| **scan/page.tsx** | QRコードスキャンページ（window.liff.scanCodeV2()、開発者モード付き） |
| **rewards.ts** | 特典関連ユーティリティ（fetchRewards, exchangeReward等） |
| **analytics.ts** | イベントログ送信ユーティリティ（logEvent, logAppOpen, logStampScanSuccess等） |
| **api/stamps/route.ts** | スタンプ登録API（重複チェック機能付き、QRコードペイロード解析） |
| **api/stamps/manual/route.ts** | スタッフ手動スタンプAPI（PIN認証） |
| **api/stamps/scan/route.ts** | QRスキャン専用API（stamps個数を動的に処理） |
| **api/stamps/scan/delete-today/route.ts** | テスト用：本日のQRスキャン削除API（サービスロールキー使用） |
| **api/rewards/route.ts** | 特典一覧取得API |
| **api/rewards/exchange/route.ts** | 特典交換API（積み上げ式） |
| **update-version.mjs** | Gitタグから自動的にバージョン番号を取得・更新 |

## Supabase連携機能

| 機能 | 説明 |
|-----|------|
| **ユーザー情報保存** | LINEログイン時に自動的にprofilesテーブルにUPSERT（id, line_user_id, display_name, picture_url） |
| **スタンプ数表示** | Supabaseから `stamp_count` を取得してリアルタイム表示（Single Source of Truth） |
| **スタンプ履歴管理** | stamp_historyテーブルで来院履歴を記録、トリガーでprofilesを自動更新 |
| **重複チェック** | 同日同QRの二重登録を防止 |
| **診察券番号表示** | Supabaseから `ticket_number` を取得して表示（未登録時は「未登録」） |
| **最終アクセス日時** | `updated_at` を日本語フォーマット（例: 2026年2月8日 20:45）で表示 |
| **特典交換システム** | rewardsテーブルで特典マスター管理、reward_exchangesテーブルで交換履歴記録 |
| **積み上げ式スタンプ** | 特典交換後もスタンプ数は減らない、条件を満たせば何度でも交換可能 |
| **友だち登録フラグ** | `liff.getFriendship()` の結果を profiles.is_line_friend に保存 |
| **表示モード保存** | profiles.view_mode で大人用/子供用モードをユーザーごとに永続化 |

---

## 開発環境

| 項目 | バージョン |
|------|----------|
| **Next.js** | 16.1.6 (Turbopack) |
| **React** | 19.2.4 |
| **TypeScript** | 5.x |
| **Tailwind CSS** | 3.4.1 |
| **@line/liff** | 2.26.1 |
| **@supabase/supabase-js** | 2.95.3 |

---

## アーキテクチャ: 表示モード分岐

```
app/page.tsx（各ページ共通パターン）
  └─ useViewMode() で viewMode を取得
      ├─ 'adult' → components/(adult)/AdultXxx.tsx
      └─ 'kids'  → components/(kids)/KidsXxx.tsx

contexts/ViewModeContext.tsx
  └─ Supabase profiles.view_mode と同期
  └─ デフォルト: 'adult'
  └─ AppLayout.tsx 内で Provider としてラップ
```

---

## 最近のアップデート履歴

| 日付 | 内容 |
|------|------|
| 2026-02-27 | **訪問回数とスタンプ獲得回数の分離表示**: `fetchVisitCount()`関数追加、profiles.visit_countから正確な訪問回数を表示 |
| 2026-02-27 | **スタンプ履歴表示改善**: "+XX個獲得（合計 YY個）"形式に変更、取得方法別アイコン・色分け対応 |
| 2026-02-27 | **アンケート報酬バグ修正（重要）**: survey_rewardが来院回数にカウントされないよう018マイグレーション実行 |
| 2026-02-26 | **アンケート機能実装**: surveys/survey_questions/survey_responsesテーブル、SurveyModal/SurveyForm等コンポーネント追加 |
| 2026-02-24 | **ドキュメント整理**: Doc/81修正（points→stamps）、Doc/82統合、イベントログ仕様追加 |
| 2026-02-23 | **イベントログ機能実装**: event_logsテーブル、lib/analytics.ts、各種イベント記録 |
| 2026-02-23 | **QRコードスキャン機能バグ修正（重要）**：`points` → `stamps` 全面修正、`/api/stamps` でQRペイロード解析対応 |
| 2026-02-23 | テスト用削除機能追加：`/api/stamps/scan/delete-today`、StaffPinModalに削除ボタン追加 |
| 2026-02-23 | **RLS改善**: SERVICE_ROLE_KEY依存削除、016マイグレーションでDELETE/UPDATEポリシー追加 |
| 2026-02-22 | **QRコードスキャン機能実装**：`app/scan/page.tsx`、`/api/stamps/scan`、LIFF scanCodeV2使用 |
| 2026-02-22 | スマホなし子供機能の改善：`real_name`フィールド活用、localStorageキー統一 |
| 2026-02-17 | **仮想メンバー機能実装**：スマホなし子供の代理管理、子供モード画面 |
| 2026-02-17 | **Phase 2家族紐付け機能実装**：families/profilesテーブル拡張、招待コード機能 |
| 2026-02-14 | 予約ボタンクリック数トラッキング機能追加 |
| 2026-02-14 | 次回メモ機能実装：次回来院予定日・カスタムメッセージ設定 |
| 2026-02-11 | **子供用モード基盤（Phase 1）**：ViewModeContext、(adult)/(kids)コンポーネント分離、設定ページ追加 |
| 2026-02-11 | tailwind.config.ts に子供用カラー（kids-pink/yellow/green/blue/purple）・フォント追加 |
| 2026-02-11 | supabase/005: profiles.view_mode カラム追加SQL |
| 2026-02-11 | QRScanner/StaffPinModal を features/ → shared/ に移動 |
| 2026-02-09 | **LINE友だち登録機能**：is_line_friend カラム、FriendshipPromptModal追加 |
| 2026-02-09 | **重要な仕様変更（v1.1）**：スタンプ消費型 → 積み上げ式に変更、特典内容詳細化 |
| 2026-02-09 | **Phase 2.5完了**：特典交換システム実装（rewardsテーブル、特典ページ、ボトムナビ5つ化） |
| 2026-02-09 | バージョン管理自動化（Gitタグ連携、scripts/update-version.mjs） |
| 2026-02-09 | スタッフ手動スタンプ機能強化（2ステップUI、+/-ボタン、1日制限解除） |
| 2026-02-09 | **Phase 2完了**：スタンプ機能完全実装 |
| 2026-02-08 | **Phase 1完了**：バックエンド基盤構築 |
| 2026-02-08 | Next.js 15.1.0 → 16.1.6 にアップデート（CVE-2025-66478 脆弱性対応） |
| 2026-02-08 | Supabase連携実装：profilesテーブル、ユーザー情報自動保存、スタンプ数表示 |
