# スマホなし子供画面開発ガイド（開発者向け）

**作成日:** 2026-02-27
**対象:** スマホなし子供画面の担当開発者
**目的:** Git/Vercel環境での開発競合を避け、安全に並行開発を進めるためのガイド

---

## 📋 目次

1. [開発対象範囲の確認](#1-開発対象範囲の確認)
2. [完全に独立している部分](#2-完全に独立している部分)
3. [共有しているファイル](#3-共有しているファイル)
4. [Git運用の留意点](#4-git運用の留意点)
5. [Vercelデプロイの留意点](#5-vercelデプロイの留意点)
6. [開発の進め方（推奨）](#6-開発の進め方推奨)
7. [競合を避けるためのルール](#7-競合を避けるためのルール)

---

## 1. 開発対象範囲の確認

### スマホなし子供画面とは

- **定義**: 家族機能で親が管理する「スマホを持っていない子供」の専用画面
- **アクセス方法**:
  1. 親が「家族管理」画面で子供を登録
  2. 子供のカードをタップ
  3. `/child-mode` ページに遷移
- **主な機能**:
  - 診察券表示（子供の名前・診察券番号）
  - スタンプカード表示（子供のスタンプ数）
  - 家族合計スタンプ表示
  - ハブラーシカのメッセージ
  - スロットゲームリンク

### 開発対象ファイル

```
app/
├── child-mode/
│   ├── page.tsx              # スマホなし子供用ホーム画面（エントリーポイント）
│   └── settings/
│       └── page.tsx          # スマホなし子供用設定画面

components/
└── (kids)/
    ├── KidsHome.tsx          # 子供用ホームコンポーネント（共通）
    ├── KidsStampPage.tsx     # 子供用スタンプページ（プレースホルダー）
    ├── KidsRewardsPage.tsx   # 子供用特典ページ（プレースホルダー）
    ├── KidsCarePage.tsx      # 子供用ケア記録（プレースホルダー）
    └── KidsInfoPage.tsx      # 子供用医院情報（プレースホルダー）
```

---

## 2. 完全に独立している部分

### ✅ 安全に編集できるファイル

以下のファイルは**スマホなし子供画面専用**で、他の機能と競合しません：

#### app/child-mode/
```
app/child-mode/page.tsx
app/child-mode/settings/page.tsx
```

**特徴:**
- ルーティングが完全に分離（`/child-mode` パス）
- 親の画面（大人用モード）と独立
- 他の開発者が触ることはほぼない

#### components/(kids)/
```
components/(kids)/KidsStampPage.tsx
components/(kids)/KidsRewardsPage.tsx
components/(kids)/KidsCarePage.tsx
components/(kids)/KidsInfoPage.tsx
```

**特徴:**
- 現在は全てプレースホルダー（未実装）
- 自由に開発可能
- `KidsHome.tsx` のみ注意が必要（後述）

---

## 3. 共有しているファイル

### ⚠️ 注意が必要なファイル

以下のファイルは**複数の機能で共有**されており、変更時に競合の可能性があります：

### 3.1 components/(kids)/KidsHome.tsx

**使用箇所:**
1. **通常の子供用モード**: `/` ページで `view_mode = 'kids'` の時
2. **スマホなし子供画面**: `/child-mode` ページ

**共有の仕組み:**
```typescript
// app/page.tsx（ホーム画面）
if (viewMode === 'kids') {
  return <KidsHome />;  // 通常の子供用モード
}

// app/child-mode/page.tsx（スマホなし子供画面）
<KidsHome profileOverride={profile} />  // propsで子供のプロフィールを渡す
```

**重要な注意点:**
- `profileOverride` プロパティを使用して子供のデータを上書き
- このファイルを変更する場合は、両方のモードで動作確認が必要
- **変更前に必ずメイン担当者に確認すること**

### 3.2 API Routes

**共有されているAPI:**
```
app/api/profiles/[profileId]/route.ts    # プロフィール取得
app/api/families/me/route.ts            # 家族情報取得
app/api/families/members/route.ts       # 家族メンバー一覧
app/api/stamps/route.ts                 # スタンプ登録
```

**留意点:**
- これらのAPIは大人用画面・子供用モード・スマホなし子供画面で共通使用
- **変更する場合は必ずメイン担当者と相談すること**
- 新しいAPIエンドポイントを追加する場合は問題なし

### 3.3 データベーステーブル

**共有テーブル:**
```
profiles             # ユーザープロフィール（大人も子供も）
stamp_history        # スタンプ履歴
families             # 家族グループ
family_members       # 家族メンバー
family_stamp_totals  # 家族スタンプ合計（VIEW）
```

**留意点:**
- これらのテーブルはアプリ全体で共有
- **スキーマ変更（カラム追加・削除）は必ずメイン担当者と相談すること**
- データ取得のみであれば問題なし

### 3.4 共通ライブラリ

**共有されているlib/**
```
lib/stamps.ts     # スタンプ関連ユーティリティ
lib/supabase.ts   # Supabaseクライアント
lib/memo.ts       # メモ関連ユーティリティ
```

**留意点:**
- 既存の関数を変更する場合は要注意
- 新しい関数を追加する場合は問題なし
- **変更する場合は必ずメイン担当者に確認すること**

---

## 4. Git運用の留意点

### 4.1 ブランチ戦略（推奨）

```
main               # 本番環境（触らない）
  └── feature/child-mode-ui    # スマホなし子供画面専用ブランチ
```

**推奨手順:**

1. **feature ブランチを作成:**
```bash
git checkout -b feature/child-mode-ui
```

2. **こまめにコミット:**
```bash
git add app/child-mode/
git add components/(kids)/
git commit -m "feat: スマホなし子供画面の○○機能を実装"
```

3. **定期的にmainをマージ:**
```bash
git checkout main
git pull origin main
git checkout feature/child-mode-ui
git merge main
```

### 4.2 コミットメッセージの規則

**スマホなし子供画面の変更には必ずプレフィックスを付ける:**

```bash
# 良い例
git commit -m "feat(child-mode): スロットゲーム画面を追加"
git commit -m "fix(child-mode): スタンプ表示のバグ修正"
git commit -m "style(child-mode): 背景色を調整"

# 悪い例（どこを変更したか不明確）
git commit -m "画面を修正"
git commit -m "バグ修正"
```

### 4.3 .gitignoreの確認

**自動生成ファイルをコミットしない:**
```
.next/
node_modules/
.env.local
.DS_Store
```

**既に.gitignoreに含まれているか確認:**
```bash
cat .gitignore
```

---

## 5. Vercelデプロイの留意点

### 5.1 プレビューデプロイの活用

**Vercelの機能:**
- **プレビューデプロイ**: ブランチをpushすると自動でプレビュー環境が作成される
- **本番デプロイ**: `main` ブランチのみが本番環境に反映される

**推奨手順:**

1. **feature ブランチをpush:**
```bash
git push origin feature/child-mode-ui
```

2. **プレビューURLで動作確認:**
   - Vercelダッシュボードでプレビュー環境のURLを確認
   - スマホなし子供画面の動作をテスト
   - 問題なければPull Request作成

3. **メイン担当者がレビュー:**
   - コードレビュー
   - プレビュー環境での動作確認
   - 問題なければmainにマージ

### 5.2 環境変数の確認

**必要な環境変数:**
```
NEXT_PUBLIC_LIFF_ID
NEXT_PUBLIC_SUPABASE_URL
NEXT_PUBLIC_SUPABASE_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY
```

**留意点:**
- これらの環境変数は既にVercelに設定済み
- **新しい環境変数が必要な場合は、メイン担当者に依頼すること**
- プレビュー環境でも本番と同じ環境変数が使用される

### 5.3 ビルドエラーの対処

**ビルドが失敗した場合:**

1. **ローカルでビルドテスト:**
```bash
npm run build
```

2. **TypeScript型エラーをチェック:**
```bash
npx tsc --noEmit
```

3. **エラーを修正してから再度push:**
```bash
git add .
git commit -m "fix(child-mode): ビルドエラーを修正"
git push origin feature/child-mode-ui
```

---

## 6. 開発の進め方（推奨）

### 6.1 開発フロー

```
1. タスクの明確化
   ↓
2. feature ブランチを作成
   ↓
3. ローカルで開発・テスト
   ↓
4. コミット・push
   ↓
5. Vercelプレビュー環境で動作確認
   ↓
6. Pull Request作成
   ↓
7. メイン担当者がレビュー
   ↓
8. mainにマージ
   ↓
9. 本番デプロイ
```

### 6.2 ローカル開発環境のセットアップ

**初回のみ:**

1. **リポジトリをクローン:**
```bash
git clone <repository-url>
cd 260208_Stamp_MiniAPPs_01
```

2. **依存関係をインストール:**
```bash
npm install
```

3. **環境変数を設定:**
```bash
# .env.local ファイルを作成（メイン担当者から受け取る）
NEXT_PUBLIC_LIFF_ID=...
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=...
```

4. **開発サーバーを起動:**
```bash
npm run dev
```

5. **ブラウザでアクセス:**
```
http://localhost:3000/child-mode
```

### 6.3 開発時の注意点

**スマホなし子供画面のテスト方法:**

1. **家族管理画面で子供を追加:**
   - `/family/manage` にアクセス
   - 「子供を追加」で仮想メンバーを作成

2. **子供画面に遷移:**
   - 子供のカードをタップ
   - `/child-mode` ページが表示される

3. **動作確認:**
   - 診察券情報が表示されるか
   - スタンプカードが表示されるか
   - 家族スタンプ合計が表示されるか
   - 戻るボタンが機能するか

---

## 7. 競合を避けるためのルール

### 7.1 ファイル編集のルール

| ファイル種別 | 編集可否 | 確認要否 |
|------------|---------|---------|
| `app/child-mode/**` | ✅ 自由に編集可能 | 不要 |
| `components/(kids)/Kids*Page.tsx` | ✅ 自由に編集可能 | 不要 |
| `components/(kids)/KidsHome.tsx` | ⚠️ 要注意 | **必須** |
| `app/api/**` | ⚠️ 要注意 | **必須** |
| `lib/**` | ⚠️ 要注意 | **必須** |
| `supabase/**` | ❌ 編集禁止 | **必須** |
| `components/(adult)/**` | ❌ 編集禁止 | - |

### 7.2 コミュニケーションのルール

**変更前に確認が必要な場合:**

1. **KidsHome.tsx を変更する場合:**
   - 変更内容をメイン担当者に説明
   - `profileOverride` の動作に影響がないか確認
   - 両方のモード（通常の子供用 + スマホなし子供）でテスト

2. **API Routesを変更する場合:**
   - 変更内容をメイン担当者に説明
   - 大人用画面への影響を確認
   - 互換性を保つこと

3. **データベーススキーマを変更する場合:**
   - **必ずメイン担当者に相談すること**
   - マイグレーションファイルの作成は担当者が行う

### 7.3 マージのタイミング

**Pull Requestを作成するタイミング:**

1. **機能が完成した時:**
   - すべての画面が実装済み
   - ローカルでテスト済み
   - プレビュー環境でテスト済み

2. **大きな変更を行った時:**
   - KidsHome.tsx の変更
   - 新しいAPIエンドポイントの追加
   - 共有ライブラリの変更

3. **こまめにマージしたい場合:**
   - 小さな機能単位でPRを作成
   - レビューの負担を減らす
   - 競合を早期に発見

### 7.4 競合が発生した場合

**マージ競合の解決手順:**

1. **最新のmainをマージ:**
```bash
git checkout main
git pull origin main
git checkout feature/child-mode-ui
git merge main
```

2. **競合ファイルを確認:**
```bash
git status
```

3. **競合を解決:**
   - VSCodeで競合マーカーを確認
   - 適切な変更を選択
   - 両方の変更が必要な場合は統合

4. **動作確認:**
```bash
npm run dev
npm run build
```

5. **コミット:**
```bash
git add .
git commit -m "fix: マージ競合を解決"
git push origin feature/child-mode-ui
```

---

## 8. トラブルシューティング

### 8.1 よくあるエラー

#### エラー1: "selectedChildId is undefined"

**原因:** LocalStorageに子供IDが保存されていない

**解決策:**
1. `/family/manage` で子供を登録
2. 子供のカードをタップして `/child-mode` に遷移

#### エラー2: "プロフィールが見つかりません"

**原因:** 子供のプロフィールがデータベースに存在しない

**解決策:**
1. Supabase Dashboardで `profiles` テーブルを確認
2. 子供のIDが正しいか確認
3. 必要に応じてテストデータを追加

#### エラー3: ビルドエラー "Type error: Property 'X' does not exist"

**原因:** TypeScriptの型定義が正しくない

**解決策:**
1. `types/` フォルダの型定義を確認
2. インターフェースを修正
3. `npx tsc --noEmit` で型チェック

### 8.2 サポート

**問題が解決しない場合:**

1. **エラーメッセージをコピー**
2. **再現手順をまとめる**
3. **メイン担当者に連絡**

---

## 9. チェックリスト

### 開発開始前

- [ ] リポジトリをクローン済み
- [ ] `npm install` 実行済み
- [ ] `.env.local` 設定済み
- [ ] `npm run dev` で起動確認済み
- [ ] feature ブランチを作成済み

### 開発中

- [ ] `/child-mode/**` のみを編集している
- [ ] 共有ファイルの変更は担当者に確認済み
- [ ] こまめにコミットしている
- [ ] コミットメッセージに `(child-mode)` を付けている

### Push前

- [ ] `npm run build` でビルド成功
- [ ] `npx tsc --noEmit` で型エラーなし
- [ ] ローカルで動作確認済み
- [ ] 不要なファイルをコミットしていない

### Pull Request前

- [ ] プレビュー環境で動作確認済み
- [ ] 変更内容を説明文に記載
- [ ] スクリーンショットを添付（必要に応じて）
- [ ] メイン担当者にレビュー依頼

---

## 10. 参考ドキュメント

- **[Doc/04_子供用モード仕様書.md](04_子供用モード仕様書.md)**: 子供用モードの全体仕様
- **[Doc/70_子供画面切替機能仕様.md](70_子供画面切替機能仕様.md)**: 家族機能とスマホなし子供の仕様
- **[Doc/02_ファイル構成.md](02_ファイル構成.md)**: プロジェクト全体のファイル構成

---

**最終更新:** 2026-02-27
**ステータス:** 初版作成完了
**作成者:** メイン開発担当者
