# 90_スタンプ履歴表示改善仕様

**作成日:** 2026-02-26
**対象:** AdultStampPage.tsx の来院履歴表示ロジック
**目的:** 「XX回目の来院」から「スタンプ獲得ログ」への表示変更

---

## 📋 目次

1. [現状の問題点](#1-現状の問題点)
2. [新しい表示方針](#2-新しい表示方針)
3. [データ構造の確認](#3-データ構造の確認)
4. [画面表示設計](#4-画面表示設計)
5. [実装方針](#5-実装方針)
6. [具体的な実装例](#6-具体的な実装例)

---

## 1. 現状の問題点

### 1.1 現在の表示ロジック

**AdultStampPage.tsx (180-208行目):**
```typescript
{stampHistory.map((record, index) => {
  const visitNumber = stampHistory.length - index; // 訪問回数（最新が1番目）
  const { fullStamps: recordStamps } = calculateStampDisplay(record.stamp_number);
  return (
    <li key={record.id}>
      <p>{visitNumber}回目の来院</p>  // ← ここが問題
      <p>{formatStampDate(record.visit_date)} • スタンプ {recordStamps}個</p>
    </li>
  );
})}
```

### 1.2 問題点

**現状:**
- すべてのレコードを「XX回目の来院」と表示
- `stamp_method`に関係なく「来院」扱い
- アンケート報酬も「来院」として表示されてしまう

**例:**
```
8回目の来院
2026年2月26日 22:41 • スタンプ 53個

7回目の来院  ← アンケート報酬なのに「来院」と表示
2026年2月26日 22:12 • スタンプ 50個
```

### 1.3 根本原因

- `stamp_history`はすべてのスタンプ取得履歴を含む
- `stamp_method`は `'qr_scan'`, `'manual_admin'`, `'import'`, `'survey_reward'` の4種類
- 現在の表示ロジックは`stamp_method`を考慮していない

---

## 2. 新しい表示方針

### 2.1 基本コンセプト

**「来院」ではなく「スタンプ獲得ログ」として表示**

- **メイン情報**: スタンプ獲得数（今回+合計）
- **サブ情報**: 獲得理由（来院、スタッフ操作、アンケート報酬）

### 2.2 表示内容の優先順位

| 優先度 | 表示内容 | 説明 |
|-------|---------|------|
| **1** | 今回獲得したスタンプ数 | `amount`（例: +10個、+30個） |
| **2** | 合計スタンプ数 | `stamp_number`（例: 53個） |
| **3** | 獲得理由 | `stamp_method`（来院、スタッフ操作、アンケート報酬） |
| 4 | 日時 | `visit_date` |

### 2.3 表示例（新デザイン）

```
+10個獲得（合計 53個）
来院（QRコード）
2026年2月26日 22:41

+30個獲得（合計 50個）
アンケート回答報酬
2026年2月26日 22:12

+10個獲得（合計 20個）
来院（QRコード）
2026年2月26日 10:01
```

---

## 3. データ構造の確認

### 3.1 stamp_history テーブル

| カラム名 | 型 | 説明 | 例 |
|---------|---|------|---|
| `id` | UUID | レコードID | - |
| `user_id` | TEXT | ユーザーID | - |
| `visit_date` | TIMESTAMPTZ | 日時 | 2026-02-26 22:41:00 |
| `stamp_number` | INTEGER | 累積スタンプ数 | 53 |
| **`stamp_method`** | TEXT | 取得方法 | `'qr_scan'`, `'manual_admin'`, `'import'`, `'survey_reward'` |
| **`amount`** | INTEGER | 今回獲得数 | 10, 30, 50 |
| `notes` | TEXT | 備考 | "アンケート回答: satisfaction_2026Q1" |
| `created_at` | TIMESTAMPTZ | 作成日時 | - |

### 3.2 stamp_method の種類

| 値 | 意味 | 表示テキスト |
|----|------|------------|
| `qr_scan` | QRコード読み取り | 「来院（QRコード）」 |
| `manual_admin` | スタッフ手動操作 | 「スタッフ操作」 |
| `import` | データインポート | 「データ移行」 |
| `survey_reward` | アンケート回答報酬 | 「アンケート回答報酬」 |

### 3.3 amount の値

| stamp_method | amount の値 | 説明 |
|-------------|------------|------|
| `qr_scan` | 10（通常）、5〜50（特別QR） | QRコードから取得 |
| `survey_reward` | 30（現在の設定） | surveysテーブルの`reward_stamps`から取得 |
| `manual_admin` | 差分値 | スタッフが設定した値 - 前の値 |
| `import` | 任意 | インポート時の値 |

---

## 4. 画面表示設計

### 4.1 レイアウト（モックアップ）

```
┌──────────────────────────────────────────────────┐
│ 来院履歴                                           │
├──────────────────────────────────────────────────┤
│ [🎯] +10個獲得（合計 53個）                        │
│      来院（QRコード）                               │
│      2026年2月26日 22:41                          │
├──────────────────────────────────────────────────┤
│ [📝] +30個獲得（合計 50個）                        │
│      アンケート回答報酬                             │
│      2026年2月26日 22:12                          │
├──────────────────────────────────────────────────┤
│ [👤] +10個調整（合計 20個）                        │
│      スタッフ操作                                  │
│      2026年2月24日 10:01                          │
├──────────────────────────────────────────────────┤
│ [🎯] +10個獲得（合計 10個）                        │
│      来院（QRコード）                               │
│      2026年2月23日 15:30                          │
└──────────────────────────────────────────────────┘
```

### 4.2 アイコンの使い分け

| stamp_method | アイコン | 色 |
|-------------|---------|---|
| `qr_scan` | 🎯 (CheckCircle2) | 緑 (primary) |
| `survey_reward` | 📝 (FileText) | 青 (blue-500) |
| `manual_admin` | 👤 (User) | オレンジ (orange-500) |
| `import` | 📦 (Package) | グレー (gray-500) |

### 4.3 テキストのフォーマット

**メインライン（太字）:**
```typescript
`+${amount}個獲得（合計 ${stamp_number}個）`
```

**サブライン1（中サイズ）:**
```typescript
getStampMethodLabel(stamp_method)
```

**サブライン2（小サイズ、グレー）:**
```typescript
formatStampDate(visit_date)
```

---

## 5. 実装方針

### 5.1 修正対象ファイル

1. **AdultStampPage.tsx** (メイン)
   - 来院履歴の表示ロジックを全面改修

2. **types/stamp.ts**
   - `stamp_method`に `'survey_reward'` を追加

3. **lib/stamps.ts** (オプション)
   - `getStampMethodLabel()` ヘルパー関数を追加
   - `getStampMethodIcon()` ヘルパー関数を追加

### 5.2 実装ステップ

#### Step 1: types/stamp.ts の修正
```typescript
export interface StampHistoryRecord {
  id: string;
  user_id: string;
  visit_date: string;
  stamp_number: number;
  stamp_method: "qr_scan" | "manual_admin" | "import" | "survey_reward";  // ← 追加
  qr_code_id: string | null;
  amount: number | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}
```

#### Step 2: lib/stamps.ts にヘルパー関数を追加
```typescript
/**
 * stamp_method を日本語ラベルに変換
 */
export function getStampMethodLabel(method: StampHistoryRecord['stamp_method']): string {
  switch (method) {
    case 'qr_scan':
      return '来院（QRコード）';
    case 'survey_reward':
      return 'アンケート回答報酬';
    case 'manual_admin':
      return 'スタッフ操作';
    case 'import':
      return 'データ移行';
    default:
      return '不明';
  }
}

/**
 * stamp_method に応じたアイコン情報を返す
 */
export function getStampMethodIcon(method: StampHistoryRecord['stamp_method']) {
  switch (method) {
    case 'qr_scan':
      return { icon: 'CheckCircle2', color: 'bg-primary/10 text-primary' };
    case 'survey_reward':
      return { icon: 'FileText', color: 'bg-blue-500/10 text-blue-500' };
    case 'manual_admin':
      return { icon: 'User', color: 'bg-orange-500/10 text-orange-500' };
    case 'import':
      return { icon: 'Package', color: 'bg-gray-500/10 text-gray-500' };
    default:
      return { icon: 'HelpCircle', color: 'bg-gray-500/10 text-gray-500' };
  }
}
```

#### Step 3: AdultStampPage.tsx の修正
```typescript
// 来院履歴リスト部分を修正
{stampHistory.map((record) => {
  const { fullStamps: recordStamps } = calculateStampDisplay(record.stamp_number);
  const methodLabel = getStampMethodLabel(record.stamp_method);
  const iconInfo = getStampMethodIcon(record.stamp_method);
  const amount = record.amount || 0;

  return (
    <li key={record.id} className="...">
      <div className={`flex h-10 w-10 items-center justify-center rounded-full ${iconInfo.color}`}>
        {/* アイコンコンポーネント */}
      </div>
      <div className="flex-1">
        {/* メインライン: +XX個獲得（合計 YY個） */}
        <p className="text-sm font-bold text-gray-800">
          +{amount}個獲得（合計 {recordStamps}個）
        </p>
        {/* サブライン1: 取得方法 */}
        <p className="text-xs text-gray-600">
          {methodLabel}
        </p>
        {/* サブライン2: 日時 */}
        <p className="text-xs text-gray-500">
          {formatStampDate(record.visit_date)}
        </p>
      </div>
    </li>
  );
})}
```

### 5.3 下位互換性の考慮

**既存のamount = nullの場合:**
```typescript
const amount = record.amount || 0;
```

**古いデータでstamp_methodが不明な場合:**
```typescript
const methodLabel = getStampMethodLabel(record.stamp_method || 'qr_scan');
```

---

## 6. 具体的な実装例

### 6.1 Before（現在）

```typescript
<li key={record.id}>
  <div className="...">
    <CheckCircle2 className="..." />
  </div>
  <div className="flex-1">
    <p className="text-sm font-medium text-gray-800">
      {visitNumber}回目の来院  {/* ← すべて「来院」 */}
      {record.stamp_method === 'manual_admin' && (
        <span className="...">( スタッフ編集)</span>
      )}
    </p>
    <p className="text-xs text-gray-500">
      {formatStampDate(record.visit_date)} • スタンプ {recordStamps}個
    </p>
  </div>
</li>
```

### 6.2 After（新デザイン）

```typescript
<li key={record.id}>
  <div className={`flex h-10 w-10 items-center justify-center rounded-full ${iconInfo.color}`}>
    {/* アイコンを stamp_method で切り替え */}
    {iconInfo.icon === 'CheckCircle2' && <CheckCircle2 className="h-5 w-5" />}
    {iconInfo.icon === 'FileText' && <FileText className="h-5 w-5" />}
    {iconInfo.icon === 'User' && <User className="h-5 w-5" />}
    {iconInfo.icon === 'Package' && <Package className="h-5 w-5" />}
  </div>
  <div className="flex-1">
    {/* メインライン */}
    <p className="text-sm font-bold text-gray-800">
      +{amount}個獲得（合計 {recordStamps}個）
    </p>
    {/* サブライン1: 取得方法 */}
    <p className="text-xs font-medium text-gray-600">
      {methodLabel}
    </p>
    {/* サブライン2: 日時 */}
    <p className="text-xs text-gray-500">
      {formatStampDate(record.visit_date)}
    </p>
  </div>
</li>
```

---

## 7. 表示例（実際のデータ）

### 7.1 QRコード来院
```
+10個獲得（合計 53個）
来院（QRコード）
2026年2月26日 22:41
```

### 7.2 アンケート回答報酬
```
+30個獲得（合計 50個）
アンケート回答報酬
2026年2月26日 22:12
```

### 7.3 スタッフ手動操作
```
+10個調整（合計 20個）
スタッフ操作
2026年2月24日 10:01
```

### 7.4 データインポート
```
+10個移行（合計 10個）
データ移行
2026年2月20日 00:00
```

---

## 8. テストケース

### 8.1 通常の来院履歴

**データ:**
```json
{
  "stamp_method": "qr_scan",
  "amount": 10,
  "stamp_number": 53,
  "visit_date": "2026-02-26T22:41:00+09:00"
}
```

**表示:**
```
+10個獲得（合計 53個）
来院（QRコード）
2026年2月26日 22:41
```

### 8.2 アンケート報酬

**データ:**
```json
{
  "stamp_method": "survey_reward",
  "amount": 30,
  "stamp_number": 50,
  "visit_date": "2026-02-26T22:12:00+09:00",
  "notes": "アンケート回答: satisfaction_2026Q1"
}
```

**表示:**
```
+30個獲得（合計 50個）
アンケート回答報酬
2026年2月26日 22:12
```

### 8.3 スタッフ手動編集

**データ:**
```json
{
  "stamp_method": "manual_admin",
  "amount": 10,
  "stamp_number": 20,
  "visit_date": "2026-02-24T10:01:00+09:00",
  "notes": "スタッフによる手動調整"
}
```

**表示:**
```
+10個調整（合計 20個）
スタッフ操作
2026年2月24日 10:01
```

---

## 9. 実装チェックリスト

- [x] types/stamp.ts に `'survey_reward'` を追加
- [x] lib/stamps.ts に `getStampMethodLabel()` を追加
- [x] lib/stamps.ts に `getStampMethodIcon()` を追加
- [x] AdultStampPage.tsx の来院履歴表示を修正
- [x] アイコンのインポート追加（FileText, User, Package）
- [x] 「訪問回数: X回」表示を削除 → 訪問回数とスタンプ獲得回数を分けて表示
- [x] amount = null の場合のフォールバック処理
- [ ] 動作確認（QRコード、アンケート、スタッフ編集）

---

## 10. 実装完了状況

**実装日:** 2026-02-27

### 10.1 実装内容（2026-02-27 第1回）

#### ドキュメント修正
- ✅ [Doc/03_機能仕様書.md:33](../Doc/03_機能仕様書.md#L33) - stamp_method に 'import' と 'survey_reward' を追加
- ✅ [Doc/05_Database_Schema.md:184](../Doc/05_Database_Schema.md#L184) - stamp_method に 'survey_reward' を追加

#### 型定義の更新
- ✅ [types/stamp.ts:13](../types/stamp.ts#L13) - StampHistoryRecord に 'survey_reward' を追加

#### ヘルパー関数の追加（lib/stamps.ts）
- ✅ `getStampMethodLabel()` - スタンプ取得方法の日本語ラベル変換関数
- ✅ `getStampMethodIcon()` - 取得方法に応じたlucide-reactアイコン名取得関数
- ✅ `STAMP_AMOUNTS.SURVEY_REWARD` - アンケート報酬の定数（30個）

#### UI実装の変更（AdultStampPage.tsx）
- ✅ 表示形式を "+XX個獲得（合計 YY個）" + 取得方法ラベル + 日時 に変更
- ✅ stamp_method に応じたアイコンと色の差別化
- ✅ セクション名を "来院履歴" → "スタンプ獲得履歴" に変更

### 10.2 追加実装内容（2026-02-27 第2回）

#### 訪問回数とスタンプ獲得回数の分離表示

**問題点:**
- 当初「訪問回数」として表示していたのが `stampHistory.length`（全スタンプ獲得履歴の件数）
- アンケート報酬も含まれてしまい、実際の来院回数と一致しない

**解決策:**
- `profiles.visit_count`（amount = 10 のレコードのみカウント）を使用
- 訪問回数とスタンプ獲得回数を分けて表示

**実装内容:**

1. **lib/stamps.ts に `fetchVisitCount()` 関数を追加:**
```typescript
export const fetchVisitCount = async (userId: string): Promise<number> => {
  try {
    const { data, error } = await supabase
      .from("profiles")
      .select("visit_count")
      .eq("id", userId)
      .single();

    if (error) {
      console.error("❌ 訪問回数の取得に失敗しました:", error);
      return 0;
    }

    return data?.visit_count ?? 0;
  } catch (err) {
    console.error("❌ 予期しないエラー:", err);
    return 0;
  }
};
```

2. **AdultStampPage.tsx の修正:**
```typescript
// stateに visitCount を追加
const [visitCount, setVisitCount] = useState(0);

// fetchVisitCount をインポート
import {
  fetchStampCount,
  fetchVisitCount,  // 追加
  fetchStampHistory,
  // ...
} from "@/lib/stamps";

// fetchHistory 関数内で visit_count を取得
const visits = await fetchVisitCount(profile.userId);
setVisitCount(visits);

// UI表示
<div className="text-right text-xs text-gray-500">
  <p>訪問回数: {visitCount}回</p>
  <p className="mt-0.5">スタンプ獲得: {stampHistory.length}回</p>
</div>
```

### 10.3 表示例（実装後）

**スタンプカウンターセクション:**
```
現在のスタンプ数              訪問回数: 5回
                            スタンプ獲得: 8回

         53
        / 10個
```

**スタンプ獲得履歴:**
```
[🎯] +10個獲得（合計 53個）
     来院（QRコード）
     2026年2月26日 22:41

[📝] +30個獲得（合計 50個）
     アンケート回答報酬
     2026年2月26日 22:12

[👤] +5個獲得（合計 45個）
     スタッフ操作
     2026年2月25日 15:30
```

**データの意味:**
- **訪問回数 (5回)**: `profiles.visit_count` - amount = 10 のレコードのみ（実際の来院）
- **スタンプ獲得 (8回)**: `stampHistory.length` - すべての履歴（来院5回 + アンケート3回）

---

## 11. 追加の改善提案（将来）

### 11.1 フィルター機能

```
[ すべて ] [ 来院のみ ] [ アンケート ] [ スタッフ操作 ]
```

### 11.2 ソート機能

- 日時順（新しい順/古い順）
- 獲得数順（多い順/少ない順）

### 11.3 月別・年別の集計表示

```
2026年2月の統計
- 来院回数: 5回
- スタンプ獲得: 8回
- 獲得スタンプ数: 140個
```

---

**最終更新:** 2026-02-27
**ステータス:** 実装完了（動作確認待ち）
**関連ドキュメント:** [Doc/60_スタンプルール.md](60_スタンプルール.md)
