# 家族招待コード参加機能 仕様書

**作成日**: 2026-02-18
**最終更新**: 2026-02-18
**ステータス**: 🔄 設計中
**目的**: LIFFアプリ内で招待コードを使って家族に参加する機能

---

## 📋 概要

### 課題

スマホを持つ子供（③ 子供自律パターン）が、親が作成した家族グループに参加する方法が必要。

### 現状

- 親は家族グループを作成できる
- 親は招待コード（= family_id）をコピーできる
- **しかし、子供が招待コードを入力して参加する画面がない**

### 解決策

**オンボーディングフローに「家族参加」ルートを追加**
- 初回起動時、または設定画面から招待コードを入力
- LIFFアプリ内で完結
- 管理ダッシュボード不要

---

## 🎯 対象利用構造

**③ 子供自律（1 Patient + 1 LINE）**

```
親のスマホ (親アカウント)
  └─ 家族グループ作成
      └─ 招待コード: fbaae6e8-e64f-4748-81b8-dbb455393b1e

子供のスマホ (子供アカウント)
  └─ LIFFアプリ初回起動
      └─ 招待コード入力
          └─ 家族グループに参加 ✅
```

**メリット:**
- 親子それぞれのスマホで独立して使える
- 家族全体のスタンプ合計が可視化される
- 子供の自立心を尊重

---

## 🔄 ユーザーフロー

### パターンA: 初回起動時に参加（推奨）

```
子供のスマホで LIFFアプリを初回起動
       ↓
┌─────────────────────────────────────┐
│ つくばホワイト歯科                    │
├─────────────────────────────────────┤
│ ようこそ！                           │
│                                      │
│ あなたの役割を選択してください        │
│                                      │
│ ┌─────────────────┐                 │
│ │ 👨 親として登録   │                 │
│ │ 家族グループを作成  │                 │
│ └─────────────────┘                 │
│                                      │
│ ┌─────────────────┐                 │
│ │ 👶 子供として参加 │ ← これを選択      │
│ │ 招待コードを入力   │                 │
│ └─────────────────┘                 │
│                                      │
│ [スキップして個人で使う]               │
└─────────────────────────────────────┘
       ↓ 「子供として参加」をタップ
┌─────────────────────────────────────┐
│ 家族の招待コードを入力                │
├─────────────────────────────────────┤
│ 親御さんから共有された               │
│ 招待コードを入力してください          │
│                                      │
│ ┌──────────────────────────┐       │
│ │ fbaae6e8-e64f-... (UUID)  │       │
│ └──────────────────────────┘       │
│                                      │
│ [貼り付け]  [キャンセル]  [参加]      │
└─────────────────────────────────────┘
       ↓ 参加ボタンをタップ
┌─────────────────────────────────────┐
│ 参加しました！                        │
├─────────────────────────────────────┤
│ 「横山家」に参加しました               │
│                                      │
│ 家族全体のスタンプ: 20個              │
│ あなたのスタンプ: 0個                 │
│                                      │
│ [ホームへ]                           │
└─────────────────────────────────────┘
```

---

### パターンB: 設定画面から参加（後から参加）

```
すでに個人で使っている子供
       ↓
設定画面を開く
       ↓
┌─────────────────────────────────────┐
│ 設定                                 │
├─────────────────────────────────────┤
│ 【家族管理】                         │
│ 家族グループに参加して                │
│ スタンプを合算しよう                  │
│                                      │
│ → [家族に参加する]                   │
└─────────────────────────────────────┘
       ↓ タップ
┌─────────────────────────────────────┐
│ 家族の招待コードを入力                │
├─────────────────────────────────────┤
│ 親御さんから共有された               │
│ 招待コードを入力してください          │
│                                      │
│ ┌──────────────────────────┐       │
│ │ fbaae6e8-e64f-... (UUID)  │       │
│ └──────────────────────────┘       │
│                                      │
│ [貼り付け]  [キャンセル]  [参加]      │
└─────────────────────────────────────┘
```

---

### パターンC: QRコード経由（親がQR表示）

```
親のスマホ
       ↓
家族管理画面で「QRコードで招待」をタップ
       ↓
┌─────────────────────────────────────┐
│ QRコードで招待                        │
├─────────────────────────────────────┤
│ このQRコードを家族に                  │
│ 読み取ってもらってください            │
│                                      │
│ ┌──────────────┐                   │
│ │              │                   │
│ │   QR CODE    │                   │
│ │              │                   │
│ └──────────────┘                   │
│                                      │
│ 招待コード:                          │
│ fbaae6e8-e64f-4748-81b8-dbb455393b1e │
│                                      │
│ [閉じる]                             │
└─────────────────────────────────────┘

子供のスマホ
       ↓
オンボーディング画面で「QRコードで参加」をタップ
       ↓
カメラでQRコードを読み取り
       ↓
自動的に招待コードが入力される
       ↓
[参加] ボタンをタップして完了
```

---

## 📐 データベース設計

### 参加前（個人利用）

```sql
-- 子供のプロフィール（家族未参加）
INSERT INTO profiles VALUES (
  'U1234567890abcdef',                    -- id (子供のLINE UID)
  'U1234567890abcdef',                    -- line_user_id
  'Mio',                                  -- display_name
  '123457',                               -- ticket_number
  NULL,                                   -- picture_url
  30,                                     -- stamp_count (3個)
  3,                                      -- visit_count
  '2026-02-12',                           -- last_visit_date
  NULL,                                   -- family_id ★ NULL（未参加）
  NULL,                                   -- family_role ★ NULL
  'kids',                                 -- view_mode
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);
```

### 参加後

```sql
-- 子供のプロフィール（家族参加済み）
UPDATE profiles
SET
  family_id = 'fbaae6e8-e64f-4748-81b8-dbb455393b1e',  -- ★ 家族IDを設定
  family_role = 'child',                               -- ★ ロールを設定
  updated_at = NOW()
WHERE id = 'U1234567890abcdef';
```

---

## 🔧 API実装

### POST /api/families/join

**リクエスト:**
```json
{
  "userId": "U1234567890abcdef",  // 子供のLINE UID
  "inviteCode": "fbaae6e8-e64f-4748-81b8-dbb455393b1e"  // 家族ID
}
```

**処理フロー:**
```typescript
1. バリデーション
   - userId が必須
   - inviteCode が必須
   - inviteCode が有効な family_id であることを確認

2. 家族の存在確認
   const { data: family, error: familyError } = await supabase
     .from('families')
     .select('*')
     .eq('id', inviteCode)
     .single();

   if (familyError || !family) {
     return { error: '招待コードが無効です' };
   }

3. ユーザーの状態確認
   const { data: profile, error: profileError } = await supabase
     .from('profiles')
     .select('family_id')
     .eq('id', userId)
     .single();

   if (profile.family_id !== null) {
     return { error: 'すでに他の家族に参加しています' };
   }

4. 家族に参加
   const { error: updateError } = await supabase
     .from('profiles')
     .update({
       family_id: inviteCode,
       family_role: 'child',
       updated_at: new Date().toISOString(),
     })
     .eq('id', userId);

   if (updateError) {
     return { error: '参加に失敗しました' };
   }

5. 成功レスポンス
   return {
     success: true,
     family: {
       id: family.id,
       name: family.family_name,
     },
   };
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "family": {
    "id": "fbaae6e8-e64f-4748-81b8-dbb455393b1e",
    "name": "横山家"
  }
}
```

**レスポンス（エラー）:**
```json
{
  "error": "招待コードが無効です"
}
```

---

## 🎨 UI実装

### 1. オンボーディング画面（`app/onboarding/page.tsx`）

**新規作成が必要**

```tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useLiff } from '@/hooks/useLiff';

export default function OnboardingPage() {
  const router = useRouter();
  const { profile } = useLiff();
  const [showJoinForm, setShowJoinForm] = useState(false);
  const [inviteCode, setInviteCode] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  const handleJoinFamily = async () => {
    if (!profile?.userId || !inviteCode.trim()) {
      setError('招待コードを入力してください');
      return;
    }

    setIsLoading(true);
    setError('');

    try {
      const res = await fetch('/api/families/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: profile.userId,
          inviteCode: inviteCode.trim(),
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || '参加に失敗しました');
      }

      // 参加成功
      router.push('/');
    } catch (err) {
      setError(err instanceof Error ? err.message : '予期しないエラーが発生しました');
    } finally {
      setIsLoading(false);
    }
  };

  const handlePaste = async () => {
    try {
      const text = await navigator.clipboard.readText();
      setInviteCode(text);
    } catch (err) {
      console.error('貼り付けエラー:', err);
    }
  };

  if (showJoinForm) {
    return (
      <div className="min-h-screen bg-gray-50 px-4 py-8">
        <div className="max-w-md mx-auto">
          <h1 className="text-2xl font-bold text-gray-800 mb-6">
            家族の招待コードを入力
          </h1>
          <p className="text-sm text-gray-600 mb-4">
            親御さんから共有された招待コードを入力してください
          </p>

          <input
            type="text"
            value={inviteCode}
            onChange={(e) => setInviteCode(e.target.value)}
            placeholder="fbaae6e8-e64f-..."
            className="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 font-mono text-sm"
          />

          {error && (
            <p className="text-sm text-red-600 mb-4">{error}</p>
          )}

          <div className="flex gap-2">
            <button
              onClick={handlePaste}
              disabled={isLoading}
              className="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium disabled:opacity-50"
            >
              貼り付け
            </button>
            <button
              onClick={() => setShowJoinForm(false)}
              disabled={isLoading}
              className="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium disabled:opacity-50"
            >
              キャンセル
            </button>
            <button
              onClick={handleJoinFamily}
              disabled={isLoading || !inviteCode.trim()}
              className="flex-1 px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark font-medium disabled:opacity-50"
            >
              {isLoading ? '参加中...' : '参加'}
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-primary/10 to-sky-50 px-4 py-12">
      <div className="max-w-md mx-auto text-center">
        <h1 className="text-3xl font-bold text-gray-800 mb-2">
          つくばホワイト歯科
        </h1>
        <p className="text-sm text-gray-600 mb-8">
          スタンプを貯めて特典をゲット！
        </p>

        <div className="space-y-4">
          <button
            onClick={() => router.push('/onboarding/create-family')}
            className="w-full px-6 py-4 bg-white border-2 border-primary text-primary rounded-xl hover:bg-primary/5 font-bold text-left shadow-sm"
          >
            <div className="text-2xl mb-1">👨</div>
            <div className="font-bold">親として登録</div>
            <div className="text-sm opacity-70">家族グループを作成</div>
          </button>

          <button
            onClick={() => setShowJoinForm(true)}
            className="w-full px-6 py-4 bg-white border-2 border-primary text-primary rounded-xl hover:bg-primary/5 font-bold text-left shadow-sm"
          >
            <div className="text-2xl mb-1">👶</div>
            <div className="font-bold">子供として参加</div>
            <div className="text-sm opacity-70">招待コードを入力</div>
          </button>

          <button
            onClick={() => router.push('/')}
            className="w-full px-6 py-4 text-gray-600 hover:text-gray-800 font-medium"
          >
            スキップして個人で使う
          </button>
        </div>
      </div>
    </div>
  );
}
```

---

### 2. 設定画面に「家族に参加」ボタンを追加（`app/settings/page.tsx`）

**既存ファイルに追加**

```tsx
// 家族未参加の場合に表示
{!userProfile?.family_id && (
  <div className="rounded-xl border border-gray-200 bg-white p-4">
    <h3 className="font-semibold text-gray-800 mb-2">家族管理</h3>
    <p className="text-sm text-gray-600 mb-3">
      家族グループに参加してスタンプを合算しよう
    </p>
    <button
      onClick={() => router.push('/onboarding')}
      className="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark font-medium"
    >
      家族に参加する
    </button>
  </div>
)}
```

---

### 3. QRコード生成（親の家族管理画面）

**将来実装（Phase 2）**

```tsx
import QRCode from 'qrcode';

const handleShowQRCode = async () => {
  const qrDataUrl = await QRCode.toDataURL(family.id);
  setQrCodeUrl(qrDataUrl);
  setShowQRModal(true);
};

// モーダル内でQRコードを表示
<img src={qrCodeUrl} alt="招待QRコード" />
```

---

## 🔒 セキュリティ考慮事項

### 1. 招待コードの有効性確認

- 招待コード（family_id）が実在するかチェック
- 削除された家族に参加できないようにする

### 2. 二重参加の防止

- すでに家族に参加しているユーザーは参加不可
- エラーメッセージ: 「すでに他の家族に参加しています」

### 3. 家族からの脱退

**将来実装（Phase 2）**

```typescript
// POST /api/families/leave
{
  "userId": "U1234567890abcdef"
}

// 処理:
// - family_id を NULL に設定
// - family_role を NULL に設定
// - スタンプ履歴は保持
```

---

## 🎯 実装優先度

### Phase 1（必須）✅
- [x] POST /api/families/join API実装
- [ ] オンボーディング画面（`app/onboarding/page.tsx`）
- [ ] 設定画面に「家族に参加」ボタン追加
- [ ] 参加成功後の確認画面

### Phase 2（推奨）
- [ ] QRコード生成機能（親側）
- [ ] QRコード読み取り機能（子供側）
- [ ] 家族からの脱退機能
- [ ] 家族参加の通知機能（親に通知）

### Phase 3（将来）
- [ ] 参加承認フロー（親が承認）
- [ ] 招待コードの有効期限設定
- [ ] 招待リンクの共有（LINE Shareボタン）

---

## 📊 代替案：管理ダッシュボードで紐付け

LIFFアプリでの実装が難しい場合の代替案：

### 管理ダッシュボード案

```
管理ダッシュボード（スタッフ用）
       ↓
患者管理画面
       ↓
「横山Mio（診察券番号: 123457）」を選択
       ↓
┌─────────────────────────────────────┐
│ 患者情報編集                         │
├─────────────────────────────────────┤
│ 名前: 横山Mio                        │
│ 診察券番号: 123457                   │
│                                      │
│ 【家族紐付け】                       │
│ この患者を家族に紐付けますか？        │
│                                      │
│ LINE User ID:                        │
│ [U1234567890abcdef     ]             │
│                                      │
│ 家族ID:                              │
│ [fbaae6e8-e64f-...     ] [検索]      │
│                                      │
│ 家族ロール:                          │
│ ( ) 代表者  (●) 子供                 │
│                                      │
│ [保存] [キャンセル]                  │
└─────────────────────────────────────┘
```

**メリット:**
- スタッフが確実に紐付けできる
- ユーザー操作不要

**デメリット:**
- スタッフの作業負担
- リアルタイム性がない
- ユーザーの自主性が損なわれる

---

## ✅ 実装チェックリスト

### バックエンド
- [ ] POST /api/families/join API実装
- [ ] 招待コードの有効性確認ロジック
- [ ] 二重参加の防止ロジック
- [ ] エラーハンドリング

### フロントエンド
- [ ] app/onboarding/page.tsx 作成
- [ ] 招待コード入力フォーム
- [ ] 貼り付けボタン実装
- [ ] 設定画面に「家族に参加」ボタン追加
- [ ] 参加成功後の確認画面

### テスト
- [ ] 有効な招待コードで参加できる
- [ ] 無効な招待コードでエラー表示
- [ ] すでに家族に参加している場合エラー表示
- [ ] 参加後、家族合計スタンプが表示される
- [ ] 参加後、家族管理画面で自分が表示される

---

## 📝 注意事項

### 家族の代表者について

- 最初に家族を作成した人が自動的に `family_role = 'parent'` になる
- 招待コードで参加した人は `family_role = 'child'` になる
- 代表者の変更は管理ダッシュボードでのみ可能（Phase 2 以降）

### スタンプの集計

- 参加前に貯めたスタンプも家族合計に反映される
- 家族から脱退してもスタンプは保持される

---

## 🗂️ 関連ドキュメント

- [50_利用構造形態.md](50_利用構造形態.md): ③ 子供自律パターンの詳細
- [25_仮想メンバー機能仕様書.md](25_仮想メンバー機能仕様書.md): 代理管理メンバーとの違い
- [03_機能仕様書.md](03_機能仕様書.md): 家族機能の全体像

---

**作成者**: Claude Code
**最終更新日**: 2026-02-18
**ステータス**: 🔄 設計中
