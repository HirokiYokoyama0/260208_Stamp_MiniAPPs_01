# 仕様変更履歴

このドキュメントでは、重要な仕様変更の履歴を記録します。

---

## 変更履歴一覧

| 日付 | バージョン | 変更内容 | 影響範囲 |
|------|----------|---------|----------|
| 2026-02-09 | 1.1 | スタンプ消費型 → 積み上げ式に変更 | 特典交換システム全体 |
| 2026-02-09 | 1.0 | 初版リリース（Phase 2.5完了） | - |

---

## 変更詳細

### v1.1 - スタンプ積み上げ式への変更（2026-02-09）

#### 変更理由
ユーザー要望により、特典交換後もスタンプを減らさない「積み上げ式」に仕様変更。

#### 変更前（スタンプ消費型）
```
例: 10個貯まった状態で「フッ素塗布無料」(10個) と交換
  ↓
profiles.stamp_count: 10 → 0（スタンプが消費される）
  ↓
また0から貯め直す必要がある
```

**課題:**
- 交換後にスタンプが0になるため、達成感が損なわれる
- 再び貯め直す必要があり、ユーザーモチベーションが低下
- 一度に1つの特典しか選べない

#### 変更後（スタンプ積み上げ式）
```
例: 12個貯まった状態で「フッ素塗布無料」(10個) と交換
  ↓
profiles.stamp_count: 12 → 12（スタンプは減らない）
  ↓
条件を満たせば何度でも交換可能
  ↓
20個貯まれば5個/10個/15個/20個の特典すべて交換可能
```

**メリット:**
- ✅ スタンプは交換後も減らない
- ✅ 条件を満たせば何度でも交換可能
- ✅ 再来院のモチベーション向上
- ✅ ユーザーフレンドリーで満足度が高い
- ✅ 貯めた達成感を維持

---

### 影響範囲と対応内容

#### 1. データベース（SQL）
**ファイル:** `supabase/003_create_rewards_tables.sql`

**変更内容:**
- コメントを「積み上げ式：スタンプ数は交換後も減りません」に変更
- 特典内容を詳細化（価格、有効期限、内容詳細を追加）

**特典内容の詳細化:**
| 特典名 | 変更前 | 変更後 |
|-------|-------|-------|
| 歯ブラシセット | オリジナル歯ブラシ + 歯磨き粉サンプルをプレゼント | 当院推奨の歯ブラシ（ふつう/やわらかめから選択可）とフッ素配合歯磨き粉（30g）をセットでプレゼント。受付でお申し出ください。 |
| フッ素塗布無料 | 次回来院時にフッ素塗布を無料でご提供します | 次回来院時にフッ素塗布（通常¥1,100）を無料でご提供。虫歯予防に効果的です。有効期限: 交換日から6ヶ月間 |
| クリーニング半額 | 歯のクリーニングコースを50%OFFでご提供 | プロフェッショナルクリーニング（PMTC/通常¥5,500）を半額の¥2,750でご提供。歯石除去・着色汚れ除去を含む約30分コース。有効期限: 交換日から3ヶ月間 |
| ホワイトニング30%OFF | ホワイトニングコースを30%割引でご提供 | オフィスホワイトニング1回コース（通常¥16,500）を30%OFFの¥11,550でご提供。施術時間約60分。有効期限: 交換日から3ヶ月間 |

---

#### 2. API実装
**ファイル:** `app/api/rewards/exchange/route.ts`

**変更内容:**

**削除したコード（消費型の処理）:**
```typescript
// 4. スタンプを消費
const newStampCount = currentStampCount - reward.required_stamps;

// 5. profiles.stamp_count を更新
const { error: updateError } = await supabase
  .from("profiles")
  .update({ stamp_count: newStampCount })
  .eq("id", userId);
```

**追加したコード（積み上げ式）:**
```typescript
// 4. 積み上げ式: スタンプは減らさない（条件を満たせば何度でも交換可能）
// profiles.stamp_count はそのまま維持
```

**レスポンスの変更:**
```typescript
// 変更前
newStampCount: 0  // 減算後の値

// 変更後
newStampCount: currentStampCount  // 積み上げ式なのでスタンプは減らない
```

**ログメッセージの変更:**
```typescript
// 変更前
console.log(`✅ 特典交換成功: User ${userId}, Reward ${reward.name}, スタンプ ${currentStampCount} → ${newStampCount}`);

// 変更後
console.log(`✅ 特典交換成功: User ${userId}, Reward ${reward.name}, スタンプ ${currentStampCount}個（積み上げ式）`);
```

---

#### 3. フロントエンド（UI）
**ファイル:** `app/rewards/page.tsx`

**変更内容:**

**ヘッダーに積み上げ式の説明を追加:**
```tsx
<p className="mt-1 text-xs text-primary-dark font-medium">
  ✨ スタンプは交換後も減りません
</p>
```

**交換確認ダイアログに説明を追加:**
```typescript
const confirmed = window.confirm(
  `「${rewardName}」と交換しますか？\n\n✨ スタンプは交換後も減りません\n\nこの操作は取り消せません。`
);
```

---

#### 4. ドキュメント更新

**更新したドキュメント一覧:**

1. **Doc/Rewards_System_Specification.md**
   - 「3. スタンプ消費型の仕組み」→「3. スタンプ積み上げ式の仕組み」に変更
   - 積み上げ式の特徴を詳細に記載
   - 特典内容の詳細化を反映

2. **Doc/Implementation_Summary_20260209.md**
   - Phase 2.5の記述を全て積み上げ式に更新
   - 設計判断セクション「6. スタンプ積み上げ式」に変更
   - 仕様変更の経緯を追記

3. **Doc/TODO.md**
   - 「スタンプ消費型システム実装」→「スタンプ積み上げ式システム実装」に変更
   - Phase 4の記述を更新

4. **C:\Users\J0851860\.claude\projects\c--work-00-Coding-260208-Stamp-MiniAPPs-01\memory\MEMORY.md**（新規作成）
   - 重要な仕様変更を記録
   - 技術パターン、注意点を整理

---

### データベースマイグレーション不要

**重要:** 今回の変更はロジック変更のみで、データベーススキーマの変更は不要です。

- `rewards` テーブル: 変更なし（特典内容の文字列のみ更新）
- `reward_exchanges` テーブル: 変更なし
- `profiles` テーブル: 変更なし

**既存データへの影響:**
- 既に交換済みの履歴: 影響なし（`reward_exchanges` テーブルに記録済み）
- 既存のスタンプ数: 影響なし（`profiles.stamp_count` は維持される）

**新しいデータの挿入のみ:**
```sql
-- 特典内容を詳細化した新しいデータ（ON CONFLICT DO NOTHINGで安全）
INSERT INTO rewards (name, description, required_stamps, display_order, is_active) VALUES
  ('オリジナル歯ブラシセット', '当院推奨の歯ブラシ...', 5, 1, true),
  ...
ON CONFLICT DO NOTHING;
```

---

### テスト確認項目

#### 単体テスト
- [x] POST /api/rewards/exchange - スタンプが減らないことを確認
- [x] レスポンスの newStampCount が currentStampCount と一致
- [x] profiles.stamp_count が変更されていないことを確認
- [x] reward_exchanges に交換履歴が記録されることを確認

#### 統合テスト
- [x] 特典ページで交換後、スタンプ数が変わらないことを確認
- [x] 12個の状態で10個の特典を交換後、12個のまま維持
- [x] 20個貯まった状態で5個/10個/15個/20個の特典すべて交換可能

#### UIテスト
- [x] 交換確認ダイアログに「スタンプは交換後も減りません」が表示
- [x] ヘッダーに「✨ スタンプは交換後も減りません」が表示
- [x] 交換後の画面更新が正常に動作

---

### ロールバック手順（万が一消費型に戻す場合）

**⚠️ 注意:** 積み上げ式の方がユーザーフレンドリーなため、ロールバックは推奨しません。

**手順:**

1. **API修正** - `app/api/rewards/exchange/route.ts`
   ```typescript
   // スタンプ減算処理を復活
   const newStampCount = currentStampCount - reward.required_stamps;
   await supabase.from("profiles").update({ stamp_count: newStampCount }).eq("id", userId);
   ```

2. **UI修正** - `app/rewards/page.tsx`
   - 「✨ スタンプは交換後も減りません」のメッセージを削除

3. **ドキュメント修正**
   - 全てのドキュメントを消費型の記述に戻す

---

## 関連リンク

- [特典システム仕様書](Rewards_System_Specification.md)
- [実装サマリー](Implementation_Summary_20260209.md)
- [TODO.md](TODO.md)

---

## 承認・レビュー

| 項目 | 担当者 | 日付 | 承認 |
|-----|-------|------|-----|
| 仕様変更の承認 | - | 2026-02-09 | ✅ |
| コードレビュー | Claude Code | 2026-02-09 | ✅ |
| ドキュメント更新 | Claude Code | 2026-02-09 | ✅ |
| テスト確認 | - | - | - |
| 本番環境デプロイ | - | - | - |

---

**最終更新日:** 2026-02-09
