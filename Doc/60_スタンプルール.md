# スタンプシステム - 数値管理ルール

**作成日**: 2026-02-17
**ステータス**: ✅ 確定仕様

---

## 1. 基本ルール

### 1.1 付与ルール

**来院時の付与:**
- 1回の来院 = **10個**のスタンプ

**スロットゲーム:**
- 当選時 = **3〜8個**のスタンプ（ランダム）

### 1.2 重要な設計思想

**なぜ「10個」なのか:**

小数点を使わずに整数値だけで管理するため。

- スロットゲームで「0.3個」「0.5個」「0.8個」を表現したい
- しかしDBやプログラムで小数点を扱うのは複雑でバグの原因になる
- **解決策**: すべて10倍にして整数で表現する

**具体例:**
```
実際の概念        → DB保存値
スタンプ 1.0個    → 10
スタンプ 1.3個    → 13
スタンプ 1.5個    → 15
スタンプ 1.8個    → 18
スタンプ 2.0個    → 20
スタンプ 13.5個   → 135
```

---

## 2. データベース設計

### 2.1 profiles.stamp_count

**型**: INTEGER
**格納値**: 10, 20, 30, 40, 50, 135, 148...

**例:**
```sql
-- ユーザーAの例
-- 1回目来院: +10 → stamp_count = 10
-- 2回目来院: +10 → stamp_count = 20
-- スロット当選: +5 → stamp_count = 25
-- 3回目来院: +10 → stamp_count = 35
```

### 2.2 stamp_history.stamp_number

**型**: INTEGER
**意味**: その時点での累積スタンプ数

**例:**
```
| visit_date      | stamp_number | stamp_method  | 説明                    |
|-----------------|--------------|---------------|------------------------|
| 2月8日 09:00    | 10           | qr_scan       | 1回目来院 → 10個       |
| 2月9日 10:00    | 20           | qr_scan       | 2回目来院 → 累積20個   |
| 2月9日 10:30    | 50           | manual_admin  | スタッフが「50個に設定」|
| 2月9日 11:00    | 40           | manual_admin  | スタッフが「40個に修正」|
```

### 2.3 stamp_history.amount

**型**: INTEGER
**意味**: その操作で付与/変更されたスタンプ数

**例:**
```
通常来院: amount = 10
スロット当選（最小）: amount = 3
スロット当選（中）: amount = 5
スロット当選（最大）: amount = 8
スタッフ手動調整: amount = (新値 - 旧値)
```

---

## 3. 画面表示ルール

### 3.1 基本方針

**DBの値をそのまま表示する**

```typescript
// ❌ 間違い（10で割る）
const display = stamp_count / 10;  // 20 → 2 (ダメ！)

// ✅ 正しい（そのまま表示）
const display = stamp_count;  // 20 → 20 (正解！)
```

### 3.2 表示例

| DB値 (stamp_count) | 画面表示 |
|-------------------|---------|
| 10                | 10個    |
| 20                | 20個    |
| 25                | 25個    |
| 135               | 135個   |
| 148               | 148個   |

### 3.3 プログレスバーの動的目標値（100個単位）

**設計思想:**
- スタンプは積み上げ式（上限なし）
- プログレスバーは100個単位で次の目標を動的に設定
- 100個達成 → 次は200個、200個達成 → 次は300個...

**計算ロジック:**
```typescript
// 次の目標値を計算（100個単位）
const calculateNextGoal = (currentStamps: number): number => {
  const GOAL_UNIT = 100;
  return Math.ceil(currentStamps / GOAL_UNIT) * GOAL_UNIT || GOAL_UNIT;
};

// 例:
calculateNextGoal(63)  // → 100
calculateNextGoal(100) // → 100
calculateNextGoal(101) // → 200
calculateNextGoal(150) // → 200
calculateNextGoal(200) // → 200
calculateNextGoal(201) // → 300
```

**表示例:**

| 現在のスタンプ数 | 次の目標 | プログレスバー | 表示メッセージ |
|----------------|---------|--------------|---------------|
| 63個           | 100個   | 63%          | 次の目標まであと37個（目標: 100個） |
| 100個          | 100個   | 100%         | 次の目標まであと0個（目標: 100個） |
| 150個          | 200個   | 75%          | 次の目標まであと50個（目標: 200個） |
| 200個          | 200個   | 100%         | 次の目標まであと0個（目標: 200個） |

### 3.4 特典交換の必要スタンプ数

| 特典                        | 必要スタンプ数 |
|----------------------------|--------------|
| オリジナル歯ブラシセット      | 50個         |
| フッ素塗布1回無料券          | 100個        |
| 歯のクリーニング50%OFF券     | 150個        |
| ホワイトニング1回30%OFF券    | 200個        |

**注意**: 従来「5個」だった特典は「50個」、「10個」だった特典は「100個」になる。

### 3.5 特典交換時のスタンプ数判定ルール（重要）

**基本方針:**
- 家族機能を使用しているユーザー → **家族全体の合算スタンプ数**で判定
- 家族機能を使用していないユーザー → **個人のスタンプ数**で判定

**判定ロジック:**
```typescript
// 特典交換に使用するスタンプ数の決定
const effectiveStampCount = familyId && familyStampCount !== null
  ? familyStampCount  // 家族がいる場合: family_stamp_totals.total_stamp_count
  : stampCount;       // 家族がいない場合: profiles.stamp_count
```

**データ取得元:**
| 状態 | 使用するスタンプ数 | データ取得元 |
|------|------------------|-------------|
| 家族あり | 家族合算値 | `family_stamp_totals.total_stamp_count` |
| 家族なし | 個人スタンプ数 | `profiles.stamp_count` |

**具体例:**

| ユーザー | 個人スタンプ数 | 家族合算値 | 判定に使用 | 100個特典交換可否 |
|---------|--------------|-----------|----------|-----------------|
| Aさん（家族なし） | 63個 | - | 63個 | ❌ 不可 |
| Bさん（家族あり） | 63個 | 150個 | 150個 | ✅ 可能 |
| Cさん（家族あり） | 30個 | 80個 | 80個 | ❌ 不可 |

**画面表示:**
- 家族あり: 「家族全体のスタンプ数」（紫色）+ 個人スタンプ数を小さく併記
- 家族なし: 「現在のスタンプ数」（通常色）

**実装ファイル:**
- `components/(adult)/AdultRewardsPage.tsx`

---

## 4. コード実装ルール

### 4.1 lib/stamps.ts

```typescript
/**
 * スタンプ付与量の定数
 */
export const STAMP_AMOUNTS = {
  /** 通常の来院: 10個 */
  REGULAR_VISIT: 10,
  /** スロット当選（最小）: 3個 */
  SLOT_MIN: 3,
  /** スロット当選（中）: 5個 */
  SLOT_MID: 5,
  /** スロット当選（最大）: 8個 */
  SLOT_MAX: 8,
} as const;

/**
 * スタンプ表示用のヘルパー関数
 * DBの値をそのまま返す（変換しない）
 */
export function calculateStampDisplay(stampCount: number): StampDisplay {
  return {
    fullStamps: stampCount,  // そのまま返す
    progress: 0,
    totalPoints: stampCount,
  };
}

/**
 * スタンプ数を文字列に変換
 */
export function formatStampCount(stampCount: number): string {
  return `${stampCount}個`;
}
```

### 4.2 API実装 (app/api/stamps/route.ts)

```typescript
// 通常来院の場合
const stampAmount = STAMP_AMOUNTS.REGULAR_VISIT; // 10
const nextStampNumber = currentStampCount + stampAmount;

// 例: currentStampCount = 20 の場合
// nextStampNumber = 20 + 10 = 30
```

### 4.3 スタッフ手動編集 (app/api/stamps/manual/route.ts)

```typescript
// スタッフが「50個に設定」と入力した場合
const newStampCount = 50;  // そのまま50をDBに保存

// ❌ 間違い
const newStampCount = 50 * 10;  // 500 (ダメ！)

// ✅ 正しい
const newStampCount = 50;  // 50 (正解！)
```

---

## 5. 用語統一

**禁止用語:**
- ❌ 「ポイント」「pt」
- ❌ 「10倍整数システム」

**推奨用語:**
- ✅ 「スタンプ」「個」
- ✅ 「整数管理システム」

**理由**: 「ポイント」という言葉を使うと、「1回の来院 = 1ポイント = 画面表示1個」と誤解する可能性があるため。

---

## 6. よくある誤解と正しい理解

### 誤解1: 「10で割って表示する」

❌ **間違い:**
```typescript
const display = stamp_count / 10;  // 20 → 2
```

✅ **正しい:**
```typescript
const display = stamp_count;  // 20 → 20
```

### 誤解2: 「1回の来院 = 1個」

❌ **間違い:**
```typescript
const stampAmount = 1;
```

✅ **正しい:**
```typescript
const stampAmount = 10;
```

### 誤解3: 「スタッフが『5個』と入力したら50を保存」

❌ **間違い:**
```typescript
const newStampCount = inputValue * 10;  // 5 → 50
```

✅ **正しい:**
```typescript
const newStampCount = inputValue;  // 50 → 50
```

**説明**: スタッフは既に「50個」と入力するので、変換不要。

---

## 7. データ移行（既存データがある場合）

**現状確認SQL:**
```sql
SELECT id, display_name, stamp_count
FROM profiles
WHERE stamp_count > 0
ORDER BY stamp_count DESC
LIMIT 10;
```

**もし stamp_count が 1, 2, 3... になっている場合:**

```sql
-- 全データを10倍に変換
UPDATE profiles
SET stamp_count = stamp_count * 10
WHERE stamp_count > 0;

UPDATE stamp_history
SET stamp_number = stamp_number * 10
WHERE stamp_number > 0;
```

**もし stamp_count が既に 10, 20, 30... の場合:**
→ データ移行不要。現在の実装のまま。

---

## 8. テストケース

### 8.1 通常来院のテスト

**初回来院:**
```
現在のstamp_count: 0
付与: +10
結果: stamp_count = 10
画面表示: "10個"
```

**2回目来院:**
```
現在のstamp_count: 10
付与: +10
結果: stamp_count = 20
画面表示: "20個"
```

### 8.2 スロットゲームのテスト

**スロット当選（+5個）:**
```
現在のstamp_count: 20
付与: +5
結果: stamp_count = 25
画面表示: "25個"
```

### 8.3 スタッフ手動編集のテスト

**スタッフが「50個に設定」:**
```
入力値: 50
結果: stamp_count = 50
画面表示: "50個"
```

---

## 9. 実装チェックリスト

- [ ] `STAMP_AMOUNTS.REGULAR_VISIT = 10`
- [ ] `STAMP_AMOUNTS.SLOT_MIN = 3`
- [ ] `STAMP_AMOUNTS.SLOT_MID = 5`
- [ ] `STAMP_AMOUNTS.SLOT_MAX = 8`
- [ ] `calculateStampDisplay()` は値をそのまま返す（割り算しない）
- [ ] `formatStampCount()` はそのまま「○個」と表示
- [ ] API実装で `+10` を付与
- [ ] スタッフ手動編集で入力値をそのまま保存
- [ ] 画面表示で `stamp_count` をそのまま表示
- [ ] 特典の必要スタンプ数を10倍に調整（5→50, 10→100, 15→150, 20→200）

---

## 改訂履歴

| 日付 | 内容 |
|------|------|
| 2026-03-01 | 3.3 プログレスバーの動的目標値（100個単位）を追加 |
| 2026-03-01 | 3.5 特典交換時のスタンプ数判定ルール（家族合算値対応）を追加 |
| 2026-02-17 | 初版作成（仕様明確化のため） |
