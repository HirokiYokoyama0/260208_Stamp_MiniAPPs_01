# QRコードスキャン機能 実装完了報告書

**作成日**: 2026-02-22
**最終修正日**: 2026-02-24
**ステータス**: ✅ 実装完了（重大バグ修正済み）
**関連ドキュメント**:
- [81_QRコード表示_LIFFアプリ開発者へ.md](81_QRコード表示_LIFFアプリ開発者へ.md) - 初期仕様書（`stamps` フィールドに修正済み）

---

## ⚠️ 重要：実装時の問題と対策

### 発生した問題

**症状:**
- QRコード「通常患者様用（5個）」をスキャンしても、**常に10個**付与されていた
- QRコードには正しく `{"type":"regular","stamps":5}` が入っているのに、アプリ側で正しく読み取れていなかった

**根本原因:**

1. **ドキュメント（Doc/24）を無視した実装ミス**
   - ドキュメントに「`stamps` を使用」と明記されていたが、実装では `points` を使用していた
   - QRコードの仕様: `{"type":"regular","stamps":5}`
   - 間違った実装: `payload.points` を読み取ろうとしていた（→ `undefined`）

2. **複数のAPIエンドポイントが存在**
   - `/api/stamps` (古い汎用スタンプAPI) - **常に10個固定で付与**
   - `/api/stamps/scan` (新しいQRスキャン専用API) - 本来こちらを使うべき
   - フロントエンドがキャッシュにより古いコードを使い、`/api/stamps` を呼んでいた

3. **`/api/stamps` の問題点**
   - QRコードの中身（`stamps` の値）を一切見ていなかった
   - 固定値 `STAMP_AMOUNTS.REGULAR_VISIT = 10` を使用していた
   - どんなQRコードをスキャンしても10個付与されていた

**修正内容:**

1. ✅ **全てのコードを `stamps` に統一**
   - フロントエンド: `payload.stamps` を使用
   - API: `stamps` パラメータを受け取る
   - ドキュメント通りの実装に修正

2. ✅ **`/api/stamps` を修正**（後方互換性のため）
   - QRコードのJSONペイロードをパースして `stamps` 値を読み取るように修正
   - キャッシュされた古いフロントエンドコードが `/api/stamps` を呼んでも正しく動作するようにした

```typescript
// 修正後のコード (app/api/stamps/route.ts)
let stampAmount = STAMP_AMOUNTS.REGULAR_VISIT; // デフォルト: +10個
try {
  const qrPayload = JSON.parse(qrCodeId);
  if (qrPayload.stamps && typeof qrPayload.stamps === 'number') {
    stampAmount = qrPayload.stamps; // QRコードの stamps 値を使用
    console.log(`📱 [Stamps API] QRコードから読み取り: ${stampAmount}個`);
  }
} catch {
  // JSONパースエラー = 通常のQRコードID、デフォルト値を使用
}
```

### 今後の対策

**必須ルール:**

1. **ドキュメント（Doc/24）を厳守**
   - QRコードペイロードは **`stamps`** を使用（`points` は廃止）
   - 「ポイント」という用語は使わず、「個」「スタンプ数」に統一

2. **APIエンドポイントの明確化**
   - **QRスキャンには必ず `/api/stamps/scan` を使用**
   - `/api/stamps` は汎用API（後方互換性のためのみ残す）
   - 新規実装では `/api/stamps/scan` を使うこと

3. **キャッシュ対策**
   - 重要な変更後は必ずキャッシュクリア
   - LINEアプリの再起動を推奨
   - 開発時は DevTools でキャッシュ無効化

4. **テスト項目に追加**
   - QRコード「通常患者様用」で **5個** 増えることを確認
   - QRコード「優良患者様用」で **10個** 増えることを確認
   - ログで `/api/stamps/scan` が呼ばれていることを確認

---

## 📌 概要

LIFFアプリ内でQRコードをスキャンし、スタンプを付与する機能を実装しました。

**Doc/81の仕様**に基づき、以下の2種類のQRコードペイロードに対応：
- **優良患者様用**: `{"type":"premium","stamps":10}` - 10個付与
- **通常患者様用**: `{"type":"regular","stamps":5}` - 5個付与

**重要**: `stamps` フィールドを使用（`points` ではない）
- 初期仕様書（Doc/81）では `points` と記載されていましたが、実装時に `stamps` に変更
- 2026-02-24にDoc/81も修正済み

---

## 🎯 実装内容

### 1. バックエンドAPI

#### `/api/stamps/scan` エンドポイント

**ファイル**: `app/api/stamps/scan/route.ts`

**機能:**
- QRコードペイロード（type, stamps）を受け取り、スタンプを付与
- ユーザー存在チェック
- 重複チェック（同日同QRコードIDの登録防止）
- stamp_historyへの登録
- 自動でprofiles.stamp_countが更新される（DBトリガー）

**リクエスト形式:**
```json
{
  "userId": "U5c70cd61...",
  "type": "premium",
  "stamps": 10,
  "qrCodeId": "premium_2026-02-22"
}
```

**レスポンス（成功）:**
```json
{
  "success": true,
  "message": "10個のスタンプを獲得しました！",
  "stampCount": 25,
  "stampsAdded": 10
}
```

**レスポンス（失敗 - 重複）:**
```json
{
  "success": false,
  "message": "本日すでにこのQRコードでスタンプを取得済みです",
  "error": "Duplicate QR code scan today"
}
```

**エラーコード:**
- `400`: 必須パラメータ不足、無効なタイプ/スタンプ数
- `404`: ユーザーが見つかりません
- `409`: 重複（同日同QRコードID）
- `500`: サーバーエラー

### 2. フロントエンド

#### QRスキャンページ

**ファイル**: `app/scan/page.tsx`

**機能:**
- LIFF SDK `scanCodeV2()` を使用してQRコードをスキャン
- QRコードペイロードをJSONパースして検証
- `/api/stamps/scan` APIを呼び出し
- 成功/失敗のフィードバック表示
- 開発者モード：手動入力機能（テスト用）

**主要コンポーネント:**
```typescript
// LIFFのQRコードスキャナーを起動
const handleScanQR = async () => {
  const result = await window.liff.scanCodeV2();
  if (result && result.value) {
    await processQRCode(result.value);
  }
};

// QRペイロードをパースしてAPIを呼び出し
const processQRCode = async (qrValue: string) => {
  const payload = JSON.parse(qrValue);

  const response = await fetch('/api/stamps/scan', {
    method: 'POST',
    body: JSON.stringify({
      userId: profile.userId,
      type: payload.type,
      stamps: payload.stamps,  // ⚠️ 重要: stamps を使用（points ではない）
      qrCodeId: `${payload.type}_${date}`,
    }),
  });
};
```

**UI/UX:**
- カラフルなグラデーション背景
- 大きなスキャンボタン
- 成功時：緑色の成功メッセージ + 診察券へのリンク
- 失敗時：赤色のエラーメッセージ
- 注意事項表示（1日1回のみ、設置場所案内）

#### LIFF SDK型定義

**ファイル**: `types/liff.d.ts`

`scanCodeV2()` メソッドの型定義を追加：
```typescript
interface Window {
  liff: {
    // ... 既存のメソッド
    scanCodeV2?: () => Promise<{
      value: string | null;
    }>;
  };
}
```

---

## 🔄 データフロー

```
ユーザーが院内QRコードをスキャン
  ↓
LIFF: window.liff.scanCodeV2()
  ↓
QRコード値取得: {"type":"premium","stamps":10}
  ↓
JSONパース & 検証
  ↓
POST /api/stamps/scan
  body: { userId, type: "premium", stamps: 10, qrCodeId }
  ↓
サーバー側処理:
  1. ユーザー存在チェック
  2. 重複チェック（同日同QRコードID）
  3. stamp_history INSERT (amount: 10)
  4. profiles.stamp_count 自動更新（DBトリガー）
  ↓
レスポンス:
  { success: true, stampCount: 25, stampsAdded: 10 }
  ↓
UI更新:
  ✅ 「10個のスタンプを獲得しました！」
  📊 合計スタンプ数: 25個
  [診察券を確認する] ボタン
```

---

## 🎨 UI/UXデザイン

### QRスキャンページ

**URL**: `/scan`

**デザイン要素:**
- **背景**: グラデーション（青→白→緑）
- **ヘッダー**: 「QRコードスキャン」+ QRアイコン
- **説明カード**: カメラアイコン + 使い方説明
- **スキャンボタン**: 大きめ、プライマリカラー、ホバー効果
- **結果表示**:
  - 成功: 緑背景 + チェックアイコン + ポイント数
  - 失敗: 赤背景 + Xアイコン + エラーメッセージ
- **注意事項**: 黄色背景、1日1回制限の説明

### 開発者モード（開発環境のみ）

**機能:**
- 手動でQRコードペイロードを入力
- プリセットボタン（premium 10個 / regular 5個）
- テスト環境でカメラなしでスキャン機能をテスト可能

---

## 🧪 テスト手順

### 1. 本番環境テスト（LIFFブラウザ）

1. LINEアプリでミニアプリを開く
2. `/scan` ページに移動
3. 「QRコードをスキャン」ボタンをタップ
4. カメラが起動することを確認
5. テスト用QRコード（`{"type":"premium","stamps":10}`）をスキャン
6. 成功メッセージ「10個のスタンプを獲得しました！」が表示されることを確認
7. 診察券ページでスタンプ数が増加していることを確認
8. 同じQRコードを再度スキャン
9. 「本日すでにこのQRコードでスタンプを取得済みです」エラーが表示されることを確認

### 2. 開発環境テスト（手動入力）

1. 開発環境（`npm run dev`）でアプリを起動
2. `/scan` ページに移動
3. 「開発者モード: 手動入力」セクションが表示されることを確認
4. プリセットボタン「優良患者様用 (10個)」をクリック
5. 入力欄に `{"type":"premium","stamps":10}` が入力される
6. 「送信」ボタンをクリック
7. 成功メッセージが表示され、スタンプが付与されることを確認

### 3. エラーハンドリングテスト

**無効なJSON:**
```json
{"invalid"}
```
→ 「無効なQRコードです」エラー表示

**サポートされていないタイプ:**
```json
{"type":"invalid","stamps":10}
```
→ 「サポートされていないQRコードタイプです」エラー表示

**重複スキャン:**
同日に同じqrCodeIdで2回スキャン
→ 409 Conflict「本日すでにこのQRコードでスタンプを取得済みです」

---

## 🔒 セキュリティ

### 重複防止機能

**仕様:**
- 同一ユーザー + 同一QRコードID + 同日の組み合わせで重複チェック
- `qrCodeId` は `${type}_${date}` 形式で生成
  - 例: `premium_2026-02-22`
  - 日付が変わると別のスキャンとして認識される

**データベースクエリ:**
```typescript
const today = new Date().toISOString().split("T")[0];
const existing = await supabase
  .from("stamp_history")
  .select("id")
  .eq("user_id", userId)
  .eq("qr_code_id", qrCodeId)
  .gte("visit_date", `${today}T00:00:00`)
  .lt("visit_date", `${today}T23:59:59`)
  .maybeSingle();
```

### 認証

- LIFF SDK経由でLINEユーザーIDを取得
- サーバー側で `profiles` テーブルに存在するユーザーかチェック
- 存在しない場合は404エラー

---

## 📊 データベーススキーマ

### stamp_history テーブル

QRスキャンで新規レコードが追加される：

```sql
INSERT INTO stamp_history (
  user_id,
  visit_date,
  stamp_number,
  stamp_method,
  qr_code_id,
  amount
) VALUES (
  'U5c70cd61...',
  '2026-02-22T10:30:00Z',
  25,
  'qr_scan',
  'premium_2026-02-22',
  10
);
```

**フィールド説明:**
- `user_id`: LINEユーザーID
- `visit_date`: スキャン日時
- `stamp_number`: 累積スタンプ数（現在値 + amount）
- `stamp_method`: `'qr_scan'`（固定）
- `qr_code_id`: 重複防止用ID
- `amount`: 今回付与したスタンプ個数（5 or 10）

### DBトリガー

`stamp_history` に INSERT されると、DBトリガー `update_profile_stamp_count()` が自動で `profiles.stamp_count` を更新します。

---

## 🚀 デプロイ

### 環境変数

追加の環境変数は不要です。

### ビルド確認

```bash
npx tsc --noEmit  # ✅ 型チェック成功
npm run build     # ビルド実行
```

### Vercelデプロイ

1. GitHub にプッシュ
2. Vercel が自動デプロイ
3. LIFF URLを最新のVercel URLに更新（LINE Developers Console）
4. QRスキャン機能をLINEアプリでテスト

---

## 🛠️ トラブルシューティング

### 問題: カメラが起動しない

**原因:** LIFFブラウザ以外で開いている
**解決:** LINEアプリ内でミニアプリを開く

### 問題: 「無効なQRコードです」エラー

**原因:** QRコードペイロードがJSON形式でない
**解決:** 正しいJSON形式（`{"type":"premium","points":10}`）のQRコードを使用

### 問題: 「重複」エラーが出る

**原因:** 同日に同じQRコードを既にスキャン済み
**解決:** 翌日にスキャンするか、別のQRコード（異なるtype）を使用

### 問題: スタンプが増えない

**確認ポイント:**
1. APIレスポンスが `success: true` か確認
2. ブラウザコンソールでエラーログ確認
3. Supabaseダッシュボードで `stamp_history` にレコードが追加されているか確認
4. `profiles.stamp_count` が更新されているか確認

---

## 📝 今後の拡張案

### 本番用QRコード

**現在（テスト用）:**
- 固定ペイロード: `{"type":"premium","points":10}`
- 重複防止: `qrCodeId = type_date` 形式

**将来（本番用）:**
- 1回限り有効なトークン付きQRコード
- ペイロード拡張例:
```json
{
  "type": "premium",
  "points": 10,
  "token": "abc123xyz789",
  "expires_at": "2026-02-22T23:59:59Z"
}
```
- サーバー側でトークン検証 + 有効期限チェック

### QRコード生成機能

管理ダッシュボードに、院内設置用のQRコード生成機能を追加：
- 日付ごとにユニークなQRコードを生成
- PDF出力機能
- 印刷用A4サイズテンプレート

### スキャン履歴

ユーザーが過去にスキャンしたQRコードの履歴を表示：
- スキャン日時
- 獲得ポイント数
- QRコードタイプ

---

## 📚 関連ドキュメント

- [81_QRコード表示_LIFFアプリ開発者へ.md](81_QRコード表示_LIFFアプリ開発者へ.md) - QRコード仕様（2026-02-24修正済み）
- [05_Database_Schema.md](05_Database_Schema.md) - データベーススキーマ
- [90_実装履歴.md](90_実装履歴.md) - 実装履歴

---

## 📋 QRコードペイロード仕様（Doc/81より）

### 優良患者様用（10個）
```json
{"type":"premium","stamps":10}
```

### 通常患者様用（5個）
```json
{"type":"regular","stamps":5}
```

### API呼び出し例
```typescript
const payload = JSON.parse(qrValue); // QRコードから取得

const response = await fetch('/api/stamps/scan', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    userId: profile.userId,
    type: payload.type,      // 'premium' or 'regular'
    stamps: payload.stamps,  // 10 or 5
    qrCodeId: `${payload.type}_${date}`,
  }),
});
```

---

**最終更新**: 2026-02-24
**実装者**: Claude Code
**ステータス**: ✅ 実装完了、ドキュメント統合完了
