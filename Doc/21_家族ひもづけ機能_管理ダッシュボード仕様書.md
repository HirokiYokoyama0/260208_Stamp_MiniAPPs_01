# 家族ひもづけ機能 - 管理ダッシュボード仕様書

**作成日:** 2026-02-16
**最終更新:** 2026-02-16
**対象:** つくばホワイト歯科 管理ダッシュボード
**ステータス:** 🔄 Phase 1完了、Phase 2以降は仕様確定済み・未実装
**関連ドキュメント:** [20_家族ひもづけ仕様検討.md](20_家族ひもづけ仕様検討.md)

---

## 📋 目次

1. [概要](#概要)
2. [実装方針](#実装方針)
3. [データベーススキーマ](#データベーススキーマ)
4. [管理ダッシュボード機能要件](#管理ダッシュボード機能要件)
5. [UI設計](#ui設計)
6. [API設計](#api設計)
7. [実装手順（フェーズ分け）](#実装手順フェーズ分け)
8. [注意事項・制約](#注意事項制約)

---

## 概要

### 目的

現在の「1つのLINEアカウント = 1枚の診察券 = 1つのスタンプ数」という1:1構造を、**家族単位でスタンプを共有できる仕組み**に拡張する。

### 採用方針

- **案4（10倍整数管理）+ 案3（段階的導入）** を採用
- 既存設計を維持しつつ、家族紐付け機能を追加
- `families` テーブル + `profiles.family_id` 拡張
- 家族合計スタンプ数は **VIEW で計算**（同期不要）

### 実現するユースケース

| ケース | 現状 | 実装後 |
|-------|------|--------|
| **母親が子供を連れて来院** | 母親+1個、子供+1個（別々） | 家族の合計+2個（共有財布） |
| **父親が定期検診** | 父親+1個 | 家族の合計+1個（同じ財布） |
| **特典交換** | 母親が10個貯めて交換 | 家族で10個貯めたら誰でも交換可能 |
| **独立・離婚** | - | スタンプを分配して家族解除 |

---

## 実装方針

### ✅ Phase 1: 10倍整数システムへの移行（完了: 2026-02-16）

**実装内容:**
- ✅ マイグレーションSQL作成: `008_add_10x_system_columns.sql`
- ✅ `profiles.visit_count` カラム追加
- ✅ `stamp_history.amount` カラム追加
- ✅ トリガー関数更新（`visit_count` 自動計算）
- ✅ ユーティリティ関数作成: `lib/stamps.ts` に `calculateStampDisplay()` など追加
- ✅ フロントエンド修正: AdultHome.tsx, AdultStampPage.tsx, AdultRewardsPage.tsx
- ✅ API修正: `/api/stamps` (+1 → +10), `/api/stamps/manual` (amount追加)

### Phase 2-1: データベース拡張（1〜2日） - 🚧 未実装

- `families` テーブル作成
- `profiles` テーブルに `family_id`, `family_role` 追加
- 既存ユーザー全員に「単身家族」を作成
- ビュー `family_stamp_totals` 作成

### Phase 2: 管理ダッシュボード実装（3〜5日）★本ドキュメントの範囲

- 患者一覧に家族情報を表示
- 患者詳細パネルに「家族情報」セクション追加
- 家族の紐付け・解除UI
- 家族メンバー一覧・編集機能

### Phase 3: LIFF側の表示（LIFFアプリ側の実装）

- 個人のスタンプ数 + 家族全体のスタンプ数表示
- 特典交換時の選択機能

### Phase 4: 特典交換の拡張（LIFFアプリ側の実装）

- 家族スタンプを使った特典交換
- 交換履歴に「誰が」「どのスタンプで」を記録

---

## データベーススキーマ

### 新規テーブル: `families`

世帯（お財布）の実体。

```sql
CREATE TABLE families (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  family_name TEXT NOT NULL,
  representative_user_id TEXT REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_families_representative ON families(representative_user_id);
```

| カラム名 | 型 | 説明 |
|---------|---|------|
| id | UUID | 家族ID（主キー） |
| family_name | TEXT | 「○○家」などの表示用名称 |
| representative_user_id | TEXT (FK) | 代表者のprofiles.id |
| created_at | TIMESTAMPTZ | 作成日時 |
| updated_at | TIMESTAMPTZ | 更新日時 |

### 既存テーブル拡張: `profiles`

```sql
ALTER TABLE profiles
  ADD COLUMN family_id UUID REFERENCES families(id),
  ADD COLUMN family_role TEXT DEFAULT 'member'
    CHECK (family_role IN ('representative', 'member'));

CREATE INDEX idx_profiles_family_id ON profiles(family_id);
```

| カラム名 | 型 | 説明 |
|---------|---|------|
| family_id | UUID (FK) | 所属する families.id への参照 |
| family_role | TEXT | 'representative' (代表者) / 'member' (メンバー) |

### ビュー: `family_stamp_totals`

家族の合計スタンプ数を計算。

```sql
CREATE VIEW family_stamp_totals AS
SELECT
  f.id AS family_id,
  f.family_name,
  f.representative_user_id,
  SUM(p.stamp_count) AS total_stamp_count,
  SUM(p.visit_count) AS total_visit_count,
  COUNT(p.id) AS member_count,
  MAX(p.last_visit_date) AS last_family_visit,
  MAX(p.updated_at) AS last_family_login
FROM families f
LEFT JOIN profiles p ON p.family_id = f.id
GROUP BY f.id, f.family_name, f.representative_user_id;
```

---

## 管理ダッシュボード機能要件

### 1. 患者一覧画面の拡張

#### 1-1. 家族情報の表示

**追加カラム:**

| カラム名 | 表示内容 | 備考 |
|---------|---------|------|
| 家族名 | 「○○家」 | `families.family_name` |
| 家族スタンプ | 家族全体の合計スタンプ数 | `family_stamp_totals.total_stamp_count` |
| 家族メンバー数 | 「3人」 | `family_stamp_totals.member_count` |

**表示例:**

```
┌────────────────────────────────────────────────────────────┐
│ 氏名     │ 診察券 │ 個人スタ│ 家族名  │ 家族スタ│ メンバ │
│          │ 番号   │ ンプ    │         │ ンプ    │ ー数   │
├────────────────────────────────────────────────────────────┤
│ 横山太郎 │ 12345  │ 12個   │ 横山家  │ 23個   │ 3人   │
│ 横山花子 │ 12346  │ 8個    │ 横山家  │ 23個   │ 3人   │
│ 横山一郎 │ 12347  │ 3個    │ 横山家  │ 23個   │ 3人   │
│ 山田太郎 │ 54321  │ 5個    │ 山田家  │ 5個    │ 1人   │
└────────────────────────────────────────────────────────────┘
```

#### 1-2. 検索・フィルタの拡張

**追加フィルタ:**

- 家族名での検索
- 単身者のみ表示（メンバー数 = 1）
- 家族持ちのみ表示（メンバー数 > 1）

---

### 2. 患者詳細パネル（新規）

患者一覧の各行をクリックすると、右側にスライド表示されるパネル。

#### 2-1. 基本情報セクション

- 氏名、診察券番号、個人スタンプ数、最終来院日
- 現在の家族情報（家族名、代表者、メンバー数）

#### 2-2. 家族情報セクション

**単身者の場合:**

```
┌─────────────────────────────────────┐
│ 👨‍👩‍👧‍👦 家族情報                        │
├─────────────────────────────────────┤
│ 家族名: 横山太郎の家族                │
│ メンバー: 本人のみ（単身）             │
│                                      │
│ [他の患者を家族に追加]               │
└─────────────────────────────────────┘
```

**家族持ちの場合:**

```
┌─────────────────────────────────────┐
│ 👨‍👩‍👧‍👦 家族情報                        │
├─────────────────────────────────────┤
│ 家族名: 横山家                        │
│ 代表者: 横山太郎（本人） ⭐           │
│                                      │
│ メンバー一覧:                         │
│   🔵 横山太郎（代表） - 12個         │
│   ⚪ 横山花子（配偶者） - 8個        │
│   ⚪ 横山一郎（子供） - 3個          │
│                                      │
│ 家族合計スタンプ: 23個                │
│ 家族合計来院回数: 23回                │
│                                      │
│ [メンバー追加] [メンバー削除]         │
│ [家族名変更] [家族解除]               │
└─────────────────────────────────────┘
```

---

### 3. 家族操作機能

#### 3-1. 他の患者を家族に追加

**シナリオ:** 横山太郎（単身）に、横山花子を家族として追加する

**UI:**

1. 「他の患者を家族に追加」ボタンをクリック
2. ダイアログが開く
3. 患者検索（名前または診察券番号）
4. 追加したい患者を選択
5. 確認メッセージ表示
6. 「追加」ボタンをクリック

**確認メッセージ:**

```
┌─────────────────────────────────────┐
│ 家族に追加しますか？                  │
├─────────────────────────────────────┤
│ 追加先の家族: 横山家                  │
│ 代表者: 横山太郎                      │
│                                      │
│ 追加するメンバー: 横山花子             │
│ 現在のスタンプ: 8個                   │
│                                      │
│ ⚠️ 注意:                             │
│ - 横山花子の既存の家族「横山花子の家  │
│   族」は解散されます。                │
│ - 横山花子のスタンプ8個は、横山家の   │
│   合計スタンプに加算されます。        │
│                                      │
│ [キャンセル] [追加]                   │
└─────────────────────────────────────┘
```

**処理フロー:**

1. 横山花子の `family_id` を横山太郎の `family_id` に変更
2. 横山花子の `family_role` を `'member'` に設定
3. 横山花子の旧家族（単身家族）を削除
4. 家族合計スタンプ数を再計算（VIEW なので自動）

#### 3-2. メンバーを家族から削除（分家）

**シナリオ:** 横山一郎（子供）が独立する

**UI:**

1. メンバー一覧で「横山一郎」の「削除」ボタンをクリック
2. ダイアログが開く
3. スタンプの分配を入力
4. 確認メッセージ表示
5. 「独立させる」ボタンをクリック

**ダイアログ:**

```
┌─────────────────────────────────────┐
│ 家族から独立させますか？              │
├─────────────────────────────────────┤
│ メンバー: 横山一郎                    │
│ 現在の個人スタンプ: 3個               │
│                                      │
│ 独立後のスタンプ数:                   │
│ ┌─────────────────────────────┐     │
│ │ 3個（現在の個人スタンプ数）   │     │
│ └─────────────────────────────┘     │
│                                      │
│ ⚠️ 注意:                             │
│ - 横山一郎は新しい単身家族「横山一郎  │
│   の家族」に所属します。              │
│ - 家族「横山家」の合計スタンプは23個  │
│   から20個に減少します。              │
│                                      │
│ [キャンセル] [独立させる]             │
└─────────────────────────────────────┘
```

**処理フロー:**

1. 横山一郎用の新しい `family` レコードを作成（「横山一郎の家族」）
2. 横山一郎の `family_id` を新しい家族IDに変更
3. 横山一郎の `family_role` を `'representative'` に設定
4. 横山一郎の `stamp_count` はそのまま（個人のスタンプ数は変わらない）
5. 旧家族「横山家」の合計スタンプは自動的に再計算（VIEW）

**重要:** スタンプの分配は行わない（個人のスタンプ数はそのまま維持）

#### 3-3. 家族名の変更

**UI:**

1. 「家族名変更」ボタンをクリック
2. ダイアログが開く
3. 新しい家族名を入力
4. 「保存」ボタンをクリック

**ダイアログ:**

```
┌─────────────────────────────────────┐
│ 家族名を変更                          │
├─────────────────────────────────────┤
│ 現在の家族名: 横山家                  │
│                                      │
│ 新しい家族名:                         │
│ ┌─────────────────────────────┐     │
│ │ 横山ファミリー                │     │
│ └─────────────────────────────┘     │
│                                      │
│ [キャンセル] [保存]                   │
└─────────────────────────────────────┘
```

#### 3-4. 家族の完全解除（全員を単身に戻す）

**シナリオ:** 家族「横山家」を解散し、全員を単身に戻す

**UI:**

1. 「家族解除」ボタンをクリック
2. 確認ダイアログが開く
3. 「解除」ボタンをクリック

**確認ダイアログ:**

```
┌─────────────────────────────────────┐
│ 家族を解除しますか？                  │
├─────────────────────────────────────┤
│ 家族名: 横山家                        │
│ メンバー: 3人                         │
│                                      │
│ ⚠️ 注意:                             │
│ - 全てのメンバーが単身者になります。  │
│ - 各メンバーの個人スタンプ数は変わり  │
│   ません。                            │
│ - 横山太郎: 12個                      │
│ - 横山花子: 8個                       │
│ - 横山一郎: 3個                       │
│                                      │
│ [キャンセル] [解除]                   │
└─────────────────────────────────────┘
```

**処理フロー:**

1. 各メンバーに新しい単身家族を作成
2. 各メンバーの `family_id` を新しい家族IDに変更
3. 各メンバーの `family_role` を `'representative'` に設定
4. 旧家族「横山家」を削除

---

### 4. 家族関連の分析機能

`/admin/analysis` ページに以下を追加:

#### 4-1. 家族の分布

- 単身者の人数
- 2人家族の数
- 3人家族の数
- 4人以上の家族の数

#### 4-2. 家族単位の統計

- 家族の平均スタンプ数
- 家族の平均メンバー数
- 最もスタンプが多い家族（TOP 5）

---

## UI設計

### 患者一覧画面のモックアップ

#### デスクトップ表示

```
┌──────────────────────────────────────────────────────────────────┐
│ つくばホワイト歯科 管理ダッシュボード                              │
├──────────────────────────────────────────────────────────────────┤
│ 🔍 [検索: 名前/診察券/家族名]  [フィルタ▼] [CSV出力]           │
├──────────────────────────────────────────────────────────────────┤
│ Table Header:                                                     │
│ 氏名 │ 診察券 │ 個人 │ 家族名 │ 家族 │ 役割 │ 最終来院 │ 操作  │
│      │ 番号   │ スタ │        │ スタ │      │          │       │
│      │        │ ンプ │        │ ンプ │      │          │       │
├──────────────────────────────────────────────────────────────────┤
│ 横山太郎│12345│ 12個│ 横山家 │ 23個│ 代表 │2/16 10:00│ [詳細]│
│ 横山花子│12346│  8個│ 横山家 │ 23個│ -   │2/15 14:30│ [詳細]│
│ 横山一郎│12347│  3個│ 横山家 │ 23個│ -   │2/14 09:00│ [詳細]│
│ 山田太郎│54321│  5個│ 山田家 │  5個│ 代表 │2/13 16:00│ [詳細]│
└──────────────────────────────────────────────────────────────────┘
```

#### モバイル表示（カードUI）

```
┌─────────────────────────────────────┐
│ 🔍 [検索]                            │
├─────────────────────────────────────┤
│ ┌─────────────────────────────────┐ │
│ │ 横山太郎 (診察券: 12345)         │ │
│ │ 🏠 横山家 (代表)                 │ │
│ │ 個人: 12個 │ 家族: 23個 (3人)   │ │
│ │ [詳細] [+1] [-1] [メッセージ]   │ │
│ └─────────────────────────────────┘ │
│                                      │
│ ┌─────────────────────────────────┐ │
│ │ 横山花子 (診察券: 12346)         │ │
│ │ 🏠 横山家                         │ │
│ │ 個人: 8個 │ 家族: 23個 (3人)    │ │
│ │ [詳細] [+1] [-1] [メッセージ]   │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

### 患者詳細パネルのモックアップ

```
┌─────────────────────────────────────┐
│ [×] 患者詳細: 横山太郎               │
├─────────────────────────────────────┤
│ 📋 基本情報                          │
│ 氏名: 横山太郎                        │
│ 診察券番号: 12345                     │
│ 個人スタンプ: 12個                    │
│ 最終来院: 2026/02/16 10:00           │
│                                      │
│ [編集] [メッセージ送信]              │
├─────────────────────────────────────┤
│ 👨‍👩‍👧‍👦 家族情報                        │
│                                      │
│ 家族名: 横山家 [✏️編集]              │
│ 代表者: 横山太郎（本人） ⭐           │
│                                      │
│ メンバー一覧:                         │
│ ┌─────────────────────────────────┐ │
│ │ 🔵 横山太郎（代表）               │ │
│ │    個人: 12個 │ 来院: 12回        │ │
│ │    最終来院: 2/16 10:00           │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ ⚪ 横山花子                       │ │
│ │    個人: 8個 │ 来院: 8回         │ │
│ │    最終来院: 2/15 14:30          │ │
│ │    [削除]                         │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ ⚪ 横山一郎                       │ │
│ │    個人: 3個 │ 来院: 3回         │ │
│ │    最終来院: 2/14 09:00          │ │
│ │    [削除]                         │ │
│ └─────────────────────────────────┘ │
│                                      │
│ 家族合計スタンプ: 23個                │
│ 家族合計来院回数: 23回                │
│                                      │
│ [メンバー追加] [家族解除]             │
└─────────────────────────────────────┘
```

---

## API設計

### 1. 家族一覧取得

**エンドポイント:** `GET /api/families`

**レスポンス:**

```json
[
  {
    "id": "uuid-1",
    "family_name": "横山家",
    "representative_user_id": "user-1",
    "member_count": 3,
    "total_stamp_count": 23,
    "total_visit_count": 23,
    "last_family_visit": "2026-02-16T10:00:00Z",
    "members": [
      {
        "id": "user-1",
        "display_name": "横山太郎",
        "ticket_number": "12345",
        "stamp_count": 12,
        "visit_count": 12,
        "family_role": "representative"
      },
      {
        "id": "user-2",
        "display_name": "横山花子",
        "ticket_number": "12346",
        "stamp_count": 8,
        "visit_count": 8,
        "family_role": "member"
      }
    ]
  }
]
```

### 2. 家族詳細取得

**エンドポイント:** `GET /api/families/[family_id]`

**レスポンス:**

```json
{
  "id": "uuid-1",
  "family_name": "横山家",
  "representative_user_id": "user-1",
  "member_count": 3,
  "total_stamp_count": 23,
  "total_visit_count": 23,
  "members": [
    {
      "id": "user-1",
      "display_name": "横山太郎",
      "ticket_number": "12345",
      "stamp_count": 12,
      "visit_count": 12,
      "family_role": "representative",
      "last_visit_date": "2026-02-16T10:00:00Z"
    }
  ]
}
```

### 3. 家族作成（新規家族を作成して既存ユーザーを移動）

**エンドポイント:** `POST /api/families`

**リクエストボディ:**

```json
{
  "family_name": "横山家",
  "representative_user_id": "user-1",
  "member_ids": ["user-1", "user-2"]
}
```

**レスポンス:**

```json
{
  "id": "uuid-1",
  "family_name": "横山家",
  "representative_user_id": "user-1",
  "created_at": "2026-02-16T10:00:00Z"
}
```

### 4. 家族名変更

**エンドポイント:** `PATCH /api/families/[family_id]`

**リクエストボディ:**

```json
{
  "family_name": "横山ファミリー"
}
```

### 5. 家族にメンバー追加

**エンドポイント:** `POST /api/families/[family_id]/members`

**リクエストボディ:**

```json
{
  "user_id": "user-3"
}
```

**処理内容:**

1. `user-3` の旧 `family_id` を取得
2. 旧家族のメンバー数を確認
3. 単身家族（メンバー数=1）なら削除
4. `user-3` の `family_id` を `family_id` に変更
5. `user-3` の `family_role` を `'member'` に設定

### 6. 家族からメンバー削除（分家）

**エンドポイント:** `DELETE /api/families/[family_id]/members/[user_id]`

**処理内容:**

1. `user_id` 用の新しい単身家族を作成
2. `user_id` の `family_id` を新しい家族IDに変更
3. `user_id` の `family_role` を `'representative'` に設定

### 7. 家族の完全解除

**エンドポイント:** `DELETE /api/families/[family_id]`

**処理内容:**

1. 家族の全メンバーを取得
2. 各メンバーに新しい単身家族を作成
3. 各メンバーの `family_id` を新しい家族IDに変更
4. 各メンバーの `family_role` を `'representative'` に設定
5. 旧家族を削除

---

## 実装手順（フェーズ分け）

### Phase 2-1: データベース・API実装（2日）

**タスク:**

1. ✅ マイグレーションファイル作成
   - `supabase/009_add_family_support.sql`
   - `families` テーブル作成
   - `profiles` テーブル拡張
   - ビュー作成
   - 既存ユーザーに単身家族作成

2. ✅ API Routes 実装
   - `app/api/families/route.ts` (GET, POST)
   - `app/api/families/[family_id]/route.ts` (GET, PATCH, DELETE)
   - `app/api/families/[family_id]/members/route.ts` (POST)
   - `app/api/families/[family_id]/members/[user_id]/route.ts` (DELETE)

3. ✅ 型定義追加
   - `lib/types.ts` に `Family`, `FamilyStampTotal` 型を追加

### Phase 2-2: 患者一覧画面の拡張（1日）

**タスク:**

1. ✅ `components/admin/patients-table.tsx` を拡張
   - 家族情報カラム追加（家族名、家族スタンプ、メンバー数）
   - 家族名でのソート追加
   - 家族名での検索追加

### Phase 2-3: 患者詳細パネル実装（2日）

**タスク:**

1. ✅ `components/admin/patient-detail-panel.tsx` を新規作成
   - 基本情報セクション
   - 家族情報セクション
   - メンバー一覧表示

2. ✅ 家族操作ダイアログ実装
   - `components/admin/family/add-member-dialog.tsx`
   - `components/admin/family/remove-member-dialog.tsx`
   - `components/admin/family/edit-family-name-dialog.tsx`
   - `components/admin/family/dissolve-family-dialog.tsx`

### Phase 2-4: 分析画面の拡張（1日）

**タスク:**

1. ✅ `app/admin/analysis/page.tsx` を拡張
   - 家族の分布グラフ追加
   - 家族単位の統計追加

---

## 注意事項・制約

### 1. データ整合性

- **家族の削除:** 必ず全メンバーを単身に戻してから削除
- **代表者の削除:** 代表者を削除する前に、別のメンバーを代表者に変更する必要がある
- **スタンプ数の整合性:** 個人のスタンプ数は変更せず、家族の合計は VIEW で自動計算

### 2. 権限管理

- **現状:** 管理ダッシュボードはすべて管理者権限
- **将来:** メンバー削除・家族解除は「院長のみ」などの権限分けを検討

### 3. 監査証跡

- **family_id の変更履歴:** 現状は保存しない
- **将来:** `family_history` テーブルを作成して履歴を保存することを検討

### 4. パフォーマンス

- **VIEW の計算:** 患者数が増えた場合、VIEW の計算が遅くなる可能性
- **対策:** 必要に応じて `families` テーブルに `total_stamp_count` カラムを追加し、トリガーで同期

### 5. エラーハンドリング

- **代表者の削除:** 代表者を削除しようとした場合はエラーメッセージを表示
- **単身者の削除:** 単身者を家族から削除しようとした場合は「この操作は不要です」と表示

---

## 改訂履歴

| 日付 | バージョン | 内容 |
|------|----------|------|
| 2026-02-16 | 1.0 | 初版作成：管理ダッシュボード側の仕様確定 |
| 2026-02-16 | 1.1 | Phase 1完了を反映、実装方針セクションを更新 |

---

**作成者:** Claude Code
**最終更新日:** 2026-02-16
**ステータス:** ✅ 仕様確定（実装待ち）