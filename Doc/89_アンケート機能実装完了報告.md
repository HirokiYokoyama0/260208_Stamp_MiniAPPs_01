# 89_アンケート機能実装完了報告

**作成日:** 2026-02-26
**対象:** LIFFアプリ（患者側）アンケート機能 Phase 1
**関連ドキュメント:** [Doc/85](85_アンケート機能仕様検討.md), [Doc/86](86_アンケート機能仕様検討_ダッシュボード側.md), [Doc/87](87_アンケート機能_懸念点対応方針.md)

---

## 📋 実装完了サマリー

### 実装フェーズ
✅ **Phase 1 完了**: データベース、API、フロントエンド、モーダル表示

### 実装日時
2026-02-26

---

## ✅ 完了した実装

### Phase 1: データベースマイグレーション

**ファイル:** `supabase/017_create_survey_tables.sql`

作成されたテーブル:
1. **surveys** - アンケート定義マスタ
   - `id` (TEXT, PK): アンケート識別子（例: 'satisfaction_2026Q1'）
   - `title` (TEXT): タイトル
   - `description` (TEXT): 説明文
   - `reward_stamps` (INTEGER): 報酬スタンプ数（10倍整数）
   - `is_active` (BOOLEAN): 公開中フラグ
   - `start_date`, `end_date` (TIMESTAMPTZ): 公開期間
   - `created_by`, `created_at`, `updated_at`: 管理情報

2. **survey_answers** - 回答データ
   - `id` (UUID, PK): 回答ID
   - `user_id` (TEXT, FK → profiles.id): 回答者
   - `survey_id` (TEXT, FK → surveys.id): アンケート
   - `q1_rating` (INTEGER): Q1 満足度評価（1〜5）
   - `q2_comment` (TEXT): Q2 自由記述
   - `q3_recommend` (INTEGER): Q3 NPS推奨度（0〜10）
   - `created_at` (TIMESTAMPTZ): 回答日時
   - **UNIQUE制約**: `(user_id, survey_id)` - 重複回答防止

3. **survey_targets** - 配信対象者管理
   - `id` (UUID, PK): レコードID
   - `user_id` (TEXT, FK → profiles.id): 対象ユーザー
   - `survey_id` (TEXT, FK → surveys.id): 対象アンケート
   - `show_on_liff_open` (BOOLEAN): LIFFアプリ起動時に表示するか
   - `shown_count` (INTEGER): 表示回数
   - `last_shown_at` (TIMESTAMPTZ): 最終表示日時
   - `postponed_count` (INTEGER): 後回しボタン押下回数
   - `last_postponed_at` (TIMESTAMPTZ): 最後に後回しにした日時
   - `answered_at` (TIMESTAMPTZ): 回答完了日時（NULL=未回答）
   - **UNIQUE制約**: `(user_id, survey_id)`

作成されたビュー:
- **survey_target_status** - 管理画面用の配信状況一覧

作成されたRPC関数:
- **increment_survey_postponed** - 「あとで」ボタン押下時のカウンタ更新

初期データ:
- `satisfaction_2026Q1` - サンプルアンケート（2026-02-26 〜 2026-03-31、報酬0.3スタンプ）

**重要な設計判断:**
- カラム名を `active` → `is_active` に統一（Doc/86, Doc/87との整合性）
- RLSポリシー: `using (true)` でアプリ層フィルタ
- 10倍整数ルール: `reward_stamps = 3` = 0.3スタンプ

---

### Phase 2: LIFF側API実装

作成されたAPIエンドポイント:

#### 1. `/api/survey/check/route.ts`
**目的:** ユーザーが回答すべき未回答アンケートがあるかチェック

**機能:**
- `survey_targets` から未回答（`answered_at` IS NULL）のアンケートを取得
- `is_active = true` のアンケートのみ対象
- `last_shown_at` から24時間以上経過していれば再表示
- レスポンス: `shouldShow`, `surveyId`, `surveyTitle`, `surveyDescription`, `shownCount`, `postponedCount`

**実装仕様:**
```typescript
POST /api/survey/check
Body: { userId: string }
Response: {
  shouldShow: boolean;
  surveyId?: string;
  surveyTitle?: string;
  surveyDescription?: string;
  shownCount?: number;
  postponedCount?: number;
}
```

#### 2. `/api/survey/submit/route.ts`
**目的:** アンケート回答を保存し、スタンプ報酬を付与

**処理フロー:**
1. バリデーション（q1_rating: 1-5, q3_recommend: 0-10）
2. `surveys` テーブルから `reward_stamps` と `is_active` を確認
3. `survey_answers` にINSERT（重複チェック: unique制約）
4. `stamp_history` にINSERT（`stamp_method: 'survey_reward'`）
5. `survey_targets` の `answered_at` を更新
6. トリガーで `profiles.stamp_count` が自動更新

**実装仕様:**
```typescript
POST /api/survey/submit
Body: {
  userId: string;
  surveyId: string;
  q1Rating: number;  // 1-5
  q2Comment: string;
  q3Recommend: number;  // 0-10
}
Response: {
  success: boolean;
  message: string;
  rewardStamps?: number;  // 10倍整数
  error?: string;
}
```

#### 3. `/api/survey/postpone/route.ts`
**目的:** 「あとで回答する」ボタン押下時の処理

**機能:**
- RPC関数 `increment_survey_postponed` を呼び出し
- `postponed_count`, `last_postponed_at` を更新
- `shown_count`, `last_shown_at` も更新（表示したことになるため）
- 24時間以内は再表示されない

**実装仕様:**
```typescript
POST /api/survey/postpone
Body: { userId: string; surveyId: string }
Response: {
  success: boolean;
  message: string;
  error?: string;
}
```

---

### Phase 3: アンケート画面フロントエンド実装

**ファイル:** `app/survey/[surveyId]/page.tsx`

**機能:**
- LIFF未ログイン時はホームへリダイレクト
- `/api/survey/check` で回答済みチェック
- 回答済みの場合: 「回答済みです」画面を表示
- 未回答の場合: `SurveyForm` を表示
- 回答送信成功後: `SurveyCompleted` を表示（2秒後にホームへ自動遷移）

**実装パターン:**
```typescript
// 既存のページ構造を踏襲
// - useLiff() でプロフィール取得
// - profile.userId を使用（= profiles.id）
// - ローディング状態の管理
// - エラーハンドリング
```

---

### Phase 4: 共有コンポーネント実装

作成されたコンポーネント:

#### 1. `components/survey/SurveyForm.tsx`
**機能:**
- Q1: 5段階星評価（`StarRating` コンポーネント）
- Q2: 自由記述（textarea）
- Q3: NPS 0-10スケール（`NPSScale` コンポーネント）
- バリデーション（Q1, Q3は必須）
- 送信中の状態管理

#### 2. `components/survey/StarRating.tsx`
**機能:**
- 1〜5の星アイコン
- クリックで選択
- 選択済み: ⭐️ / 未選択: ☆

#### 3. `components/survey/NPSScale.tsx`
**機能:**
- 0〜10のボタン
- 選択済み: 緑色 + 拡大
- 未選択: グレー

#### 4. `components/survey/SurveyCompleted.tsx`
**機能:**
- 完了画面
- 付与されたスタンプ数を表示（10倍整数を実数に変換）
- 「2秒後に自動的にホームへ戻ります」メッセージ

---

### Phase 5: アプリ起動時のアンケートモーダル表示機能

**ファイル:**
- `components/survey/SurveyModal.tsx`（新規作成）
- `components/layout/AppLayout.tsx`（既存ファイルに追加）

#### 1. `SurveyModal.tsx`
**機能:**
- モーダルUI
- 「今すぐ回答する」ボタン → `/survey/[surveyId]` へ遷移
- 「後で回答する」ボタン → `/api/survey/postpone` を呼び出し

#### 2. `AppLayout.tsx` への統合
**追加機能:**
- アプリ起動時に `/api/survey/check` を呼び出し
- `shouldShow: true` の場合、`SurveyModal` を表示
- 友だち登録モーダルとの共存（優先度を考慮して遅延表示）

**実装ロジック:**
```typescript
useEffect(() => {
  if (!isLoggedIn || !profile || isLoading) return;

  const checkPendingSurvey = async () => {
    const res = await fetch('/api/survey/check', {
      method: 'POST',
      body: JSON.stringify({ userId: profile.userId }),
    });
    const data = await res.json();

    if (data.shouldShow && data.surveyId) {
      // 友だち登録モーダルの後に表示（優先度を考慮）
      setTimeout(() => {
        setSurveyData({
          surveyId: data.surveyId,
          title: data.surveyTitle || 'アンケート',
          description: data.surveyDescription,
        });
        setShowSurveyModal(true);
      }, showFriendshipModal ? 3000 : 1500);
    }
  };

  checkPendingSurvey();
}, [isLoggedIn, profile, isLoading, showFriendshipModal]);
```

---

## 🔧 技術的な実装ポイント

### 1. 認証方式
- **LIFF認証のみ（Supabase Auth なし）**
- `useLiff()` の `profile.userId` = `profiles.id`
- `auth.uid()` は常に NULL（使用不可）

### 2. RLSポリシー
- `using (true)` でアプリ層フィルタ
- `user_id` は必ずアプリ側で指定

### 3. スタンプ報酬の仕組み
- `stamp_history` にINSERT
- `stamp_method: 'survey_reward'`
- `amount`: 報酬スタンプ数（10倍整数）
- トリガーで `profiles.stamp_count` が自動更新

### 4. 重複回答防止
- `survey_answers` と `survey_targets` に `UNIQUE(user_id, survey_id)` 制約
- INSERT時にエラーコード `23505` で判定

### 5. 24時間再表示抑制
- `last_shown_at` から24時間以内は `shouldShow: false`
- 「あとで」ボタン押下時に `last_shown_at` を更新

---

## 📂 作成されたファイル一覧

### データベース
- `supabase/017_create_survey_tables.sql`

### API
- `app/api/survey/check/route.ts`
- `app/api/survey/submit/route.ts`
- `app/api/survey/postpone/route.ts`

### ページ
- `app/survey/[surveyId]/page.tsx`

### コンポーネント
- `components/survey/SurveyForm.tsx`
- `components/survey/StarRating.tsx`
- `components/survey/NPSScale.tsx`
- `components/survey/SurveyCompleted.tsx`
- `components/survey/SurveyModal.tsx`

### 既存ファイルへの追加
- `components/layout/AppLayout.tsx`（アンケートモーダル表示ロジック追加）

---

## 🧪 Phase 6: テスト・動作確認項目

### データベース確認

```sql
-- テーブル作成確認
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public' AND table_name LIKE 'survey%';

-- 初期データ確認
SELECT * FROM surveys WHERE id = 'satisfaction_2026Q1';

-- RLSポリシー確認
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE tablename LIKE 'survey%';
```

### API動作確認

#### 1. アンケートチェックAPI
```bash
curl -X POST http://localhost:3000/api/survey/check \
  -H "Content-Type: application/json" \
  -d '{"userId": "U1234567890abcdef"}'
```

**期待結果:**
- 未回答アンケートがある場合: `{"shouldShow": true, "surveyId": "...", ...}`
- 回答済み or 対象なし: `{"shouldShow": false}`

#### 2. アンケート送信API
```bash
curl -X POST http://localhost:3000/api/survey/submit \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "U1234567890abcdef",
    "surveyId": "satisfaction_2026Q1",
    "q1Rating": 5,
    "q2Comment": "とても良かったです",
    "q3Recommend": 10
  }'
```

**期待結果:**
- 成功: `{"success": true, "message": "回答を受け付けました", "rewardStamps": 3}`
- 重複: `{"success": false, "message": "既に回答済みです", ...}` (409)

#### 3. 後回しAPI
```bash
curl -X POST http://localhost:3000/api/survey/postpone \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "U1234567890abcdef",
    "surveyId": "satisfaction_2026Q1"
  }'
```

**期待結果:**
- 成功: `{"success": true, "message": "後で回答するに設定しました"}`

### フロントエンド確認

#### 1. アンケートページ
1. `http://localhost:3000/survey/satisfaction_2026Q1` にアクセス
2. Q1で星を選択（1〜5）
3. Q2に自由記述を入力（任意）
4. Q3でNPSスケールを選択（0〜10）
5. 「送信する」ボタンをクリック
6. 完了画面が表示され、2秒後にホームへ遷移

#### 2. 回答済みチェック
1. 同じアンケートに再度アクセス
2. 「回答済みです」画面が表示される

#### 3. モーダル表示
1. アプリを起動（ホーム画面）
2. 未回答アンケートがある場合、1.5秒後にモーダルが表示
3. 「今すぐ回答する」をクリック → アンケートページへ遷移
4. または「後で回答する」をクリック → モーダルが閉じる

#### 4. 24時間再表示抑制
1. 「後で回答する」をクリック
2. アプリを再起動
3. モーダルが表示されないことを確認
4. 24時間後に再度表示されることを確認（時間経過が必要）

### スタンプ付与確認

```sql
-- スタンプ履歴確認
SELECT * FROM stamp_history
WHERE user_id = 'U1234567890abcdef'
  AND stamp_method = 'survey_reward'
ORDER BY created_at DESC;

-- プロフィールのstamp_count確認
SELECT id, display_name, stamp_count
FROM profiles
WHERE id = 'U1234567890abcdef';
```

**期待結果:**
- `stamp_history` に `amount = 3`, `stamp_method = 'survey_reward'` のレコードが追加
- `profiles.stamp_count` が3増加（0.3スタンプ = 3）

### エッジケース確認

#### 1. 重複回答防止
- 同じユーザーが同じアンケートに複数回答を試みる → 409エラー

#### 2. 無効なアンケートID
- 存在しないsurveyIdでアクセス → 404エラー

#### 3. バリデーションエラー
- q1_rating が 0 または 6以上 → 400エラー
- q3_recommend が -1 または 11以上 → 400エラー

#### 4. LIFF未ログイン
- ログインしていない状態でアンケートページにアクセス → ホームへリダイレクト

---

## 🚀 次のステップ（将来拡張）

### Phase 2: 動的アンケート設計（JSONB方式）

**目的:** 質問内容を管理画面から自由に変更可能にする

**実装内容:**
1. `surveys.questions` カラムを JSONB 型に変更
2. `survey_answers.answers` カラムを JSONB 型に変更
3. フロントエンドで動的レンダリング実装
4. 管理画面でJSONエディタ実装

**メリット:**
- コード修正不要で質問内容を変更可能
- 複数アンケートの並行実施が容易
- PostgreSQLの強力なJSONB検索機能を活用

### Phase 3: 管理画面実装

**目的:** アンケート結果の可視化と集計

**実装内容:**
1. 回答一覧表示
2. 評価分布グラフ
3. NPS計算
4. CSV出力機能
5. 自由記述の一覧表示

---

## 📝 実装履歴

| 日時 | フェーズ | 内容 | 担当 |
|------|---------|------|------|
| 2026-02-26 | Phase 1 | データベースマイグレーション作成 | Claude |
| 2026-02-26 | Phase 2 | LIFF側API実装（check, submit, postpone） | Claude |
| 2026-02-26 | Phase 3 | アンケート画面フロントエンド実装 | Claude |
| 2026-02-26 | Phase 4 | 共有コンポーネント実装 | Claude |
| 2026-02-26 | Phase 5 | アプリ起動時モーダル表示機能実装 | Claude |

---

## ✅ チェックリスト

### 実装完了確認
- [x] データベースマイグレーションファイル作成
- [x] API 3本の実装完了
- [x] アンケートページの実装完了
- [x] 共有コンポーネント 4本の実装完了
- [x] モーダル表示機能の実装完了
- [ ] マイグレーション実行（ユーザーが実施）
- [ ] 動作確認テスト実施
- [ ] スタンプ付与の動作確認
- [ ] 本番環境へのデプロイ

### ドキュメント
- [x] Doc/85 アンケート機能仕様検討.md（既存）
- [x] Doc/86 アンケート機能仕様検討_ダッシュボード側.md（既存）
- [x] Doc/87 アンケート機能_懸念点対応方針.md（既存）
- [x] Doc/89 アンケート機能実装完了報告.md（本ドキュメント）

---

**最終更新:** 2026-02-26
**ステータス:** Phase 1-5 実装完了、Phase 6（テスト）待機中
