# LINEスタンプシステム：4つの利用構造形態

**作成日:** 2026-02-17
**最終更新:** 2026-02-17
**バージョン:** 1.0

---

## 📋 目次

1. [概要](#概要)
2. [4つの利用構造](#4つの利用構造)
   - [① 本人のみ（1 LINE : 1 Patient）](#-本人のみ1-line--1-patient)
   - [② 親子管理（1 LINE : N Patients）](#-親子管理1-line--n-patients)
   - [③ 子供自律（1 Patient + 1 LINE）](#-子供自律1-patient--1-line)
   - [④ 大人連携（N LINE : N Patients）](#-大人連携n-line--n-patients)
3. [用語の定義](#用語の定義)
4. [データベース設計との対応](#データベース設計との対応)
5. [UXの違い](#uxの違い)
6. [将来の拡張：成長に伴うアップグレード](#将来の拡張成長に伴うアップグレード)

---

## 概要

つくばホワイト歯科のLINEスタンプシステムは、さまざまな家族構成・年齢層に対応するため、**4つの利用構造**をサポートしています。

これらの構造は相互に排他的ではなく、家族の状況に応じて**組み合わせて利用**できます。

---

## 4つの利用構造

### ① 本人のみ（1 LINE : 1 Patient）

**説明:**
自分一人のためにLINEを使い、自分の診察券のみを管理する基本形態。

**構造:**
```
1つのLINE UID = 1つのPatient ID
```

**特徴:**
- 家族IDを持たない、または「単身世帯」の状態
- 最もシンプルな利用形態
- 登録時のデフォルト状態

**UX:**
- 診察券は常に自分の一枚
- スロットゲームは view_mode に依存:
  - `view_mode = 'adult'` → スロット非表示
  - `view_mode = 'kids'` → スロット表示

**データベース例:**
```sql
-- profilesテーブル
INSERT INTO profiles VALUES (
  'U5c70cd61f4fe89a65381cd7becee8de3',  -- id (LINE UID)
  'U5c70cd61f4fe89a65381cd7becee8de3',  -- line_user_id
  '横山浩紀',                              -- display_name
  '123456',                               -- ticket_number
  NULL,                                   -- picture_url
  50,                                     -- stamp_count (5個)
  5,                                      -- visit_count
  '2026-02-15',                           -- last_visit_date
  'family-solo-001',                      -- family_id (単身家族)
  'parent',                               -- family_role
  'adult',                                -- view_mode
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);

-- familiesテーブル（単身家族）
INSERT INTO families VALUES (
  'family-solo-001',                      -- id
  '横山浩紀の家族',                        -- family_name
  'U5c70cd61f4fe89a65381cd7becee8de3',   -- representative_user_id
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);
```

---

### ② 親子管理（1 LINE : N Patients）

**説明:**
「スマホなし子供」を含むケース。親が自分のLINEを使って、自分と「スマホを持たない子供」を同時に管理する。

**構造:**
```
1つのLINE UID → 複数のPatient ID
  - 1つは本人（メインメンバー）
  - 他は代理登録（代理管理メンバー）
```

**特徴:**
- 親は自分のプロフィールを持つ（line_user_id あり）
- 子供は代理管理メンバーとして登録（line_user_id = NULL）
- 代理管理メンバーのIDは `manual-child-${UUID}` 形式

**UX:**
- 親のLIFF内で「自分」と「子」の診察券を切り替える
- **設定画面に「子供の画面」セクション**が表示され、各代理管理メンバーごとにボタンを配置
- ボタンタップ → ViewModeを kids に切り替え → localStorage に selectedChildId を保存 → / へリダイレクト
- キッズモード画面で選択した子供のデータを表示（KidsHome コンポーネントを利用）
- 詳細は [Doc/70_子供画面切替機能仕様.md](70_子供画面切替機能仕様.md) を参照

**メリット:**
- スマホを持たない年齢層のスタンプとスロット体験を、親のデバイスで完全に担保できる
- 親が来院を忘れても、子供のスタンプは独立して管理できる
- 兄弟姉妹など複数の子供がいる場合も、各子供専用の画面に直接アクセス可能

**データベース例:**
```sql
-- 親（メインメンバー）
INSERT INTO profiles VALUES (
  'U5c70cd61f4fe89a65381cd7becee8de3',  -- id (LINE UID)
  'U5c70cd61f4fe89a65381cd7becee8de3',  -- line_user_id
  '横山浩紀',                              -- display_name
  '123456',                               -- ticket_number
  NULL,                                   -- picture_url
  50,                                     -- stamp_count (5個)
  5,                                      -- visit_count
  '2026-02-15',                           -- last_visit_date
  'family-001',                           -- family_id
  'parent',                               -- family_role
  'adult',                                -- view_mode
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);

-- 子供（代理管理メンバー）
INSERT INTO profiles VALUES (
  'manual-child-a1b2c3d4',                -- id (手動生成)
  NULL,                                   -- line_user_id = NULL ★
  '横山太郎',                              -- display_name
  '123460',                               -- ticket_number
  NULL,                                   -- picture_url
  10,                                     -- stamp_count (1個)
  4,                                      -- visit_count
  '2026-02-10',                           -- last_visit_date
  'family-001',                           -- family_id (親と同じ)
  'child',                                -- family_role
  'kids',                                 -- view_mode
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);
```

**判定ロジック:**
```typescript
// lib/members.ts
export const isProxyMember = (profile: { id: string; line_user_id: string | null }) => {
  return profile.line_user_id === null && profile.id.startsWith('manual-');
};

// 代理管理メンバーの削除: 完全削除
if (isProxyMember(childProfile)) {
  await supabase.from('profiles').delete().eq('id', memberId);
}
```

---

### ③ 子供自律（1 Patient + 1 LINE）

**説明:**
「自分専用のスマホを持つ子供」のケース。自分のLINEで自分の診察券を管理するが、家計（スタンプ）は親と共通。

**構造:**
```
子供自身のLINE UID = 自分のPatient ID
ただし、family_id は親と共通
```

**特徴:**
- 子供自身の line_user_id を持つ（独立したユーザー）
- family_id で親と紐付く
- 自分のスマホで自分のスタンプを管理

**UX:**
- 自分のスマホで自分のスタンプを貯める
- 表示される「合計スタンプ」は親の分と合算されている
- 家族の特典交換は親の承認が必要（将来実装）

**メリット:**
- 子供の自立心を尊重しつつ、家族特典への貢献感を持たせることができる
- 親の管理負担を軽減

**データベース例:**
```sql
-- 親（メインメンバー）
INSERT INTO profiles VALUES (
  'U5c70cd61f4fe89a65381cd7becee8de3',  -- id (親のLINE UID)
  'U5c70cd61f4fe89a65381cd7becee8de3',  -- line_user_id
  '横山浩紀',                              -- display_name
  '123456',                               -- ticket_number
  NULL,                                   -- picture_url
  50,                                     -- stamp_count (5個)
  5,                                      -- visit_count
  '2026-02-15',                           -- last_visit_date
  'family-001',                           -- family_id
  'parent',                               -- family_role
  'adult',                                -- view_mode
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);

-- 子供（共有メンバー、独自LINEあり）
INSERT INTO profiles VALUES (
  'U1234567890abcdef',                    -- id (子供のLINE UID) ★
  'U1234567890abcdef',                    -- line_user_id ★
  'Mio',                                  -- display_name
  '123457',                               -- ticket_number
  NULL,                                   -- picture_url
  30,                                     -- stamp_count (3個)
  3,                                      -- visit_count
  '2026-02-12',                           -- last_visit_date
  'family-001',                           -- family_id (親と同じ)
  'child',                                -- family_role
  'kids',                                 -- view_mode
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);
```

**招待コードでの参加:**
```typescript
// POST /api/families/join
// 子供が招待コードを入力して家族に参加
{
  "userId": "U1234567890abcdef",  // 子供のLINE UID
  "inviteCode": "family-001"
}

// → profiles.family_id が更新され、family_role = 'child' に設定される
```

---

### ④ 大人連携（N LINE : N Patients）

**説明:**
「夫婦・祖父母」などが加わるケース。複数の成人がそれぞれのスマホを持ちつつ、同じ家族口座を共有する。

**構造:**
```
複数の独立したLINE UID → 同じ family_id を共有
```

**特徴:**
- 全員が独自の line_user_id を持つ
- 誰がどの「代理管理メンバー」を呼び出しても良い状態
- 家族の代表者（parent）は1人、他は child

**UX:**
- 父が連れて行っても、母が連れて行っても、同じ「子の診察券」を出してスロットができる
- 家族の合計スタンプ数は全員分の合算
- 特典交換は代表者の承認が必要（将来実装）

**メリット:**
- 育児・介護の分担が、スタンプという共通のインセンティブで可視化・共有される
- 柔軟な家族管理が可能

**データベース例:**
```sql
-- 夫（代表者）
INSERT INTO profiles VALUES (
  'U5c70cd61f4fe89a65381cd7becee8de3',  -- id (夫のLINE UID)
  'U5c70cd61f4fe89a65381cd7becee8de3',  -- line_user_id
  '横山浩紀',                              -- display_name
  '123456',                               -- ticket_number
  NULL,                                   -- picture_url
  50,                                     -- stamp_count (5個)
  5,                                      -- visit_count
  '2026-02-15',                           -- last_visit_date
  'family-001',                           -- family_id
  'parent',                               -- family_role ★ 代表者
  'adult',                                -- view_mode
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);

-- 妻（共有メンバー）
INSERT INTO profiles VALUES (
  'U9876543210fedcba',                    -- id (妻のLINE UID)
  'U9876543210fedcba',                    -- line_user_id
  '横山花子',                              -- display_name
  '123458',                               -- ticket_number
  NULL,                                   -- picture_url
  40,                                     -- stamp_count (4個)
  4,                                      -- visit_count
  '2026-02-14',                           -- last_visit_date
  'family-001',                           -- family_id (夫と同じ)
  'child',                                -- family_role ★ メンバー
  'adult',                                -- view_mode
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);

-- 代理管理メンバー（スマホなし子供）
INSERT INTO profiles VALUES (
  'manual-child-a1b2c3d4',                -- id
  NULL,                                   -- line_user_id = NULL
  '横山太郎',                              -- display_name
  '123460',                               -- ticket_number
  NULL,                                   -- picture_url
  10,                                     -- stamp_count (1個)
  4,                                      -- visit_count
  '2026-02-10',                           -- last_visit_date
  'family-001',                           -- family_id (同じ)
  'child',                                -- family_role
  'kids',                                 -- view_mode
  NOW(),                                  -- created_at
  NOW()                                   -- updated_at
);
```

**家族合計の計算:**
```sql
-- family_stamp_totals ビュー
SELECT
  f.id AS family_id,
  f.family_name,
  SUM(p.stamp_count) AS total_stamp_count,  -- 50 + 40 + 10 = 100 (10個)
  SUM(p.visit_count) AS total_visit_count,  -- 5 + 4 + 4 = 13回
  COUNT(p.id) AS member_count               -- 3人
FROM families f
LEFT JOIN profiles p ON p.family_id = f.id
WHERE f.id = 'family-001'
GROUP BY f.id, f.family_name;
```

---

## 用語の定義

これまでの「仮想メンバー」という呼称を、以下のように統一します。

| 呼称（旧） | 呼称（新） | 定義 | 識別方法 |
|-----------|-----------|------|---------|
| 本人 | **メインメンバー** | LINEアカウントと紐付いている本人 | `line_user_id IS NOT NULL` かつ `family_role = 'parent'` |
| 仮想メンバー | **代理管理メンバー** | LINEを持たず、メインメンバーの管理下にある実在の患者 | `line_user_id IS NULL` かつ `id LIKE 'manual-%'` |
| 家族メンバー | **共有メンバー** | 別LINEアカウントだが、家族IDを共有している他者 | `line_user_id IS NOT NULL` かつ `family_role = 'child'` |

**用語統一の理由:**
- **血の通った表現**: 「仮想」という言葉は無機質で、実在の患者（子供）に対して失礼
- **役割の明確化**: 誰が管理責任を持つかが一目でわかる
- **将来の拡張性**: 「代理管理」→「共有」へのアップグレードパスが自然

---

## データベース設計との対応

### profiles テーブルの活用

**設計原則:**
- **カラムを増やさない**: `line_user_id` だけで判断
- **ID命名規則**: 代理管理メンバーは `manual-child-${UUID}` 形式
- **判定の安全性**: `isProxyMember()` 関数で二重チェック

```typescript
// lib/members.ts
export const isProxyMember = (profile: { id: string; line_user_id: string | null }) => {
  return profile.line_user_id === null && profile.id.startsWith('manual-');
};
```

### 削除ロジックの違い

```typescript
if (isProxyMember(childProfile)) {
  // 代理管理メンバー: 完全削除（復元不可）
  await supabase.from('profiles').delete().eq('id', memberId);
} else {
  // 実メンバー: 紐付け解除のみ（データは残る）
  await supabase.from('profiles').update({
    family_id: null,
    family_role: null,
  }).eq('id', memberId);
}
```

**重要:**
- 代理管理メンバーは親が作成した「架空のアカウント」なので完全削除OK
- 実メンバーは独立した患者なので、紐付けを解除するだけ

---

## UXの違い

### ① 本人のみ

```
[ホーム画面]
  ├─ 自分の診察券（1枚）
  ├─ 自分のスタンプ進捗
  └─ 設定 → 家族管理なし
```

### ② 親子管理（代理管理メンバーあり）

```
[ホーム画面（親）]
  ├─ 自分の診察券
  ├─ 自分のスタンプ進捗
  └─ 設定
      └─ 家族管理
          ├─ 家族合計: 6個（親5個 + 子1個）
          ├─ メンバー一覧
          │   ├─ 横山浩紀（代表者） 5個 [編集] [削除]
          │   └─ 横山太郎（仮想） 1個 [開く] [編集] [削除]
          └─ [+ 子供を追加]
```

```
[子供モード画面（横山太郎）]
  ├─ ハブラーシカのイラスト
  ├─ スタンプカード（10個のマス、1個埋まっている）
  ├─ 励ましメッセージ「いいちょうし だよ！」
  └─ [🎰 ゲームで あそぶ！]
```

### ③ 子供自律（共有メンバー）

```
[ホーム画面（子供自身のスマホ）]
  ├─ 自分の診察券（Mio）
  ├─ 自分のスタンプ進捗: 3個
  ├─ 家族の合計スタンプ: 8個（親5個 + 自分3個）
  └─ 設定 → 家族管理（閲覧のみ）
```

### ④ 大人連携

```
[ホーム画面（夫）]
  ├─ 自分の診察券（横山浩紀）
  ├─ 自分のスタンプ進捗: 5個
  ├─ 家族の合計スタンプ: 10個（夫5個 + 妻4個 + 子1個）
  └─ 設定
      └─ 家族管理（代表者）
          ├─ 家族合計: 10個
          ├─ メンバー一覧
          │   ├─ 横山浩紀（代表者） 5個
          │   ├─ 横山花子 4個 [削除]
          │   └─ 横山太郎（仮想） 1個 [開く] [編集] [削除]
          └─ [+ 子供を追加]
```

```
[ホーム画面（妻）]
  ├─ 自分の診察券（横山花子）
  ├─ 自分のスタンプ進捗: 4個
  ├─ 家族の合計スタンプ: 10個
  └─ 設定
      └─ 家族管理（メンバー）
          ├─ 家族合計: 10個
          ├─ メンバー一覧（閲覧のみ）
          │   ├─ 横山浩紀（代表者） 5個
          │   ├─ 横山花子（自分） 4個
          │   └─ 横山太郎（仮想） 1個 [開く]
          └─ ※ 妻は代理管理メンバーを開くことはできるが、編集・削除はできない
```

---

## 将来の拡張：成長に伴うアップグレード

### シナリオ: 代理管理メンバー → 共有メンバーへの移行

**背景:**
- 子供が成長してスマホを持った
- 親の管理下から独立したい
- 過去のスタンプ履歴は引き継ぎたい

**実装案（Phase 3以降）:**

#### 1. アップグレードAPIエンドポイント

```typescript
// POST /api/families/members/[memberId]/upgrade
{
  "userId": "U5c70cd61...",           // 親のLINE UID
  "childLineUserId": "U1234567890",   // 子供の新しいLINE UID
  "childDisplayName": "横山太郎"       // LINEの表示名
}

// 処理:
// 1. memberIdが代理管理メンバー（manual-で始まる）であることを確認
// 2. childLineUserIdが既存のプロフィールに存在しないことを確認
// 3. profiles.line_user_id を NULL → childLineUserId に更新
// 4. profiles.display_name を更新（必要に応じて）
// 5. profiles.id はそのまま（履歴を保持）
```

#### 2. データベース変更例

```sql
-- アップグレード前（代理管理メンバー）
SELECT * FROM profiles WHERE id = 'manual-child-a1b2c3d4';
-- id: manual-child-a1b2c3d4
-- line_user_id: NULL
-- display_name: 横山太郎
-- stamp_count: 10
-- visit_count: 4

-- アップグレード後（共有メンバー）
UPDATE profiles
SET
  line_user_id = 'U1234567890abcdef',
  display_name = '横山太郎',
  updated_at = NOW()
WHERE id = 'manual-child-a1b2c3d4';

-- 結果:
-- id: manual-child-a1b2c3d4 （変更なし・履歴保持）
-- line_user_id: U1234567890abcdef ★ LINEアカウント紐付け
-- display_name: 横山太郎
-- stamp_count: 10 （過去のスタンプも引き継ぎ）
-- visit_count: 4
```

#### 3. UX フロー

```
[親の家族管理画面]
  └─ 横山太郎（仮想） 1個 [開く] [編集] [削除] [アップグレード] ★

[アップグレードボタンをタップ]
  ↓
[ダイアログ表示]
  「横山太郎さんにLINEアカウントを紐付けますか？」
  「子供のLINEからこのアプリを開き、表示される確認コードを入力してください」

  確認コード: ABCD1234
  [キャンセル] [続行]
  ↓
[子供のスマホ]
  LINEミニアプリを開く
  「確認コードを入力してください」
  [ABCD1234] を入力
  ↓
[紐付け完了]
  「横山太郎さんのアカウントが紐付けられました！」
  「過去のスタンプ（1個）も引き継がれています」
```

#### 4. セキュリティ考慮事項

- **確認コードの有効期限**: 10分間
- **ワンタイムコード**: 1回のみ使用可能
- **親の承認**: 代表者のみがアップグレードを開始できる
- **子供の同意**: 子供のLINEからコードを入力することで同意

---

## まとめ

この4つの利用構造により、以下のユーザー層をカバーできます：

1. **単身者**: シンプルにスタンプを貯める
2. **小さい子供のいる親**: 親が代理で管理
3. **スマホを持つ子供**: 自立しつつ家族貢献
4. **複数の大人がいる家族**: 柔軟な分担管理

**データの連続性**を保ちながら、ライフステージに合わせて柔軟に構造を変更できることが、このシステムの最大の強みです。

---

**関連ドキュメント:**
- [機能仕様書](03_機能仕様書.md)
- [データベーススキーマ](05_Database_Schema.md)
- [仮想メンバー機能仕様書](25_仮想メンバー機能仕様書.md)
- [実装履歴](90_実装履歴.md)

---

**作成者:** Claude Code
**最終更新日:** 2026-02-17
