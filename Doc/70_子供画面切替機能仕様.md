# 子供画面切替機能 仕様書

**作成日**: 2026-02-17
**最終更新**: 2026-02-19
**ステータス**: ✅ 実装完了（統合済み、バグ修正済み）

---

## 📌 このドキュメントについて

この機能の詳細仕様は **[25_仮想メンバー機能仕様書.md](25_仮想メンバー機能仕様書.md)** に統合されました。

子供画面切替機能は、代理管理メンバー（スマホを持たない子供）を管理する機能の一部として実装されています。

---

## 🔗 関連セクション

[25_仮想メンバー機能仕様書.md](25_仮想メンバー機能仕様書.md) の以下のセクションを参照してください：

### 実装方法
- **「2. 子供の画面を開く」** セクション
  - 方法A: 家族管理画面から
  - 方法B: 設定画面から（推奨）

### UI実装
- **「1. 家族管理画面」** セクション：「開く」ボタンの実装
- **「2. 設定画面」** セクション：「子供の画面」セクションの実装

### データフロー
- **「🔄 ViewModeContext の実装」** セクション：`selectedChildId` の管理方法

---

## ✅ 実装完了の確認

以下の機能がすべて実装済みです：

### 家族管理画面から
- [x] メンバーカードに「開く」ボタン表示（代理管理メンバーのみ）
- [x] ボタンタップで ViewMode を 'kids' に切り替え
- [x] selectedChildId を Context + LocalStorage に保存
- [x] ホーム画面（`/`）にリダイレクト

### 設定画面から（推奨）
- [x] 「子供の画面」セクション表示（条件：parent && 代理管理メンバー1人以上）
- [x] 各子供用のボタン表示（名前・スタンプ数）
- [x] ボタンタップで ViewMode を 'kids' に切り替え
- [x] selectedChildId を Context + LocalStorage に保存
- [x] ホーム画面（`/`）にリダイレクト

### キッズモード画面
- [x] 診察券タブ：子供の名前・診察券番号・次回予約日を表示
- [x] スタンプタブ：子供のスタンプ履歴を表示
- [x] すべてのタブで selectedChildId のデータを表示
- [x] 「おやの がめんに もどる」ボタンで親の画面に戻る

---

## 📐 アーキテクチャ概要

```
親のスマホ
    │
    ├─ 設定画面 or 家族管理画面
    │       │
    │       ├─ 「子供の画面：太郎くん」ボタンをタップ
    │       │
    │       ▼
    │  handleSwitchToChild(childId) / handleOpenChildMode(childId)
    │       │
    │       ├─ setSelectedChildId(childId)
    │       │   └─ Context + LocalStorage に保存
    │       │
    │       ├─ setViewMode('kids')
    │       │   └─ DB の view_mode を 'kids' に更新
    │       │
    │       └─ router.push('/')
    │
    ▼
ホーム画面（/）
    │
    ├─ viewMode === 'kids' ?
    │       │
    │       └─ KidsHome コンポーネント表示
    │           │
    │           ├─ selectedChildId を取得
    │           ├─ Supabase から子供のデータ取得
    │           │   - display_name
    │           │   - ticket_number
    │           │   - next_visit_date
    │           │   - next_memo
    │           │   - stamp_count
    │           │
    │           └─ 子供専用のカラフルなUI表示
    │
    └─ すべてのタブ（スタンプ・特典・ケア記録・医院情報）で同様に動作
```

---

## 🎨 UIデザイン

詳細は [25_仮想メンバー機能仕様書.md](25_仮想メンバー機能仕様書.md) を参照してください。

**キッズモードの特徴:**
- カラフルな背景グラデーション（ピンク・イエロー・ブルー）
- ひらがな表記（「しんさつけん」「スタンプカード」）
- 大きなフォント・タップしやすいボタン
- ハブラーシカのイラスト
- 励ましメッセージ

---

## 🔧 技術スタック

- **フロントエンド**: React (Next.js 16.1.6)
- **状態管理**: ViewModeContext (React Context API)
- **永続化**: LocalStorage + Supabase
- **データベース**: Supabase PostgreSQL
- **ルーティング**: Next.js App Router

---

## 📝 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-02-17 | 初版作成 |
| 2026-02-18 | 実装完了、25_仮想メンバー機能仕様書.md に統合 |
| 2026-02-19 | バグ修正: 設定画面で代理管理メンバー表示されない問題を解決 |

---

## 🐛 トラブルシューティング

### 設定画面に「子供の画面」セクションが表示されない

**症状:**
- 親ユーザーが代理管理メンバーを作成済み
- しかし設定画面に「子供の画面」セクションが表示されない

**原因:**
APIレスポンスの構造とフロントエンドのデータアクセスパスの不一致。

`GET /api/families/me` のレスポンス構造:
```json
{
  "success": true,
  "family": {
    "id": "...",
    "family_name": "横山家",
    "members": [...]  // メンバー配列はfamilyオブジェクト内
  }
}
```

しかし `app/settings/page.tsx` は `familyData.members` を直接参照していた（正しくは `familyData.family.members`）。

**修正内容（2026-02-19）:**

[app/settings/page.tsx:44-47](app/settings/page.tsx#L44-L47)
```typescript
// 修正前
if (familyData.success && familyData.members) {
  const proxyMembers = familyData.members.filter(...)
}

// 修正後
if (familyData.success && familyData.family?.members) {
  const proxyMembers = familyData.family.members.filter(...)
}
```

**デバッグログ:**
```typescript
console.log('[Settings] 親ユーザー検出、家族情報を取得中...');
console.log('[Settings] 家族情報レスポンス:', familyData);
console.log('[Settings] 全メンバー:', familyData.family.members);
console.log('[Settings] 代理管理メンバー:', proxyMembers);
console.log('[Settings Render] familyRole:', familyRole);
console.log('[Settings Render] proxyChildren:', proxyChildren);
```

**検証方法:**
1. ブラウザの開発者ツールを開く（F12）
2. 設定画面をリロード
3. コンソールログで以下を確認:
   - `[Settings] 代理管理メンバー:` が空配列でないこと
   - `[Settings Render] proxyChildren.length:` が 0 より大きいこと
4. UIに「子供の画面」セクションが表示されること

---

**作成者**: Claude Code
**最終更新日**: 2026-02-19
**ステータス**: ✅ 実装完了（バグ修正済み）

## 🛠️ 技術的な実装詳細（2026-02-22更新）

### localStorageキー名の統一

**重要**: `selectedChildId` を統一キー名として使用すること

| 用途 | キー名 | 管理者 |
|------|--------|--------|
| 子供ID保存 | `selectedChildId` | ViewModeContext |
| ~~旧キー名~~ | ~~`currentChildId`~~ | ❌ 廃止済み |

**理由:**
- ViewModeContextが`selectedChildId`で一元管理
- `currentChildId`との不一致でバグが発生していた

### 名前フィールドの使い分け

**スマホなし子供（代理管理メンバー）:**
```typescript
// 保存時
{
  display_name: childName,  // 検索用・互換性用
  real_name: childName,     // 本名（実際の名前）★メイン
}

// 表示時
displayName = profile.real_name || "登録なし"  // display_nameは無視
```

**スマホあり子供（実メンバー）:**
```typescript
// 保存時（LINEから自動取得）
{
  display_name: lineDisplayName,  // LINEの表示名
  real_name: null,                 // 使用しない
}

// 表示時
displayName = profile.display_name
```

### ViewModeContextの使用方法

**正しい実装:**
```typescript
// ViewModeContextから直接取得
const { selectedChildId, setSelectedChildId, setViewMode } = useViewMode();

// プロフィール取得
useEffect(() => {
  if (!selectedChildId) {
    setError('子供IDが見つかりません');
    return;
  }
  
  const res = await fetch(`/api/profiles/${selectedChildId}`);
  // ...
}, [selectedChildId]);
```

**間違った実装（廃止）:**
```typescript
// ❌ localStorageを直接使用しない
const childId = localStorage.getItem('currentChildId');

// ❌ ローカルstateで管理しない
const [childId, setChildId] = useState<string | null>(null);
```

### キッズモード設定画面の実装パターン

**app/child-mode/settings/page.tsx:**
```typescript
export default function ChildModeSettingsPage() {
  const { selectedChildId, setSelectedChildId, setViewMode } = useViewMode();
  
  // ✅ ViewModeContextから直接取得
  useEffect(() => {
    if (!selectedChildId) {
      throw new Error('子供IDが見つかりません');
    }
    
    const res = await fetch(`/api/profiles/${selectedChildId}`);
    const data = await res.json();
    
    // ✅ real_nameを優先
    setDisplayName(data.profile.real_name || data.profile.display_name || '');
  }, [selectedChildId]);
  
  // ✅ 保存時は両方更新
  const handleSave = async () => {
    await supabase
      .from('profiles')
      .update({
        display_name: displayName.trim(),  // 検索用・互換性用
        real_name: displayName.trim(),     // 本名（実際の名前）
        ticket_number: ticketNumber.trim() || null,
      })
      .eq('id', selectedChildId);  // ✅ selectedChildIdを使用
  };
}
```

### 「親のモードに戻る」機能

**実装場所:** app/child-mode/settings/page.tsx

**目的:**
親が誤って自分のアカウントでキッズモードに入った場合の脱出手段

**実装:**
```typescript
const handleBackToParentMode = async () => {
  setSelectedChildId(null);      // selectedChildIdをクリア
  await setViewMode('adult');    // 大人用モードに切り替え
  router.push('/');              // ホーム画面にリダイレクト
};

// UIボタン
<button onClick={handleBackToParentMode}>
  <LogOut size={20} />
  <span>おやの モード に もどる</span>
</button>
<p className="text-xs text-white/80 text-center mt-2">
  ※ おやが まちがえて きっずもーど に なった ときに つかってね
</p>
```

### データフロー図（更新版）

```
親が「子供の画面」ボタンをクリック
  ↓
settings/page.tsx: handleSwitchToChild(childId)
  ↓
ViewModeContext.setSelectedChildId(childId)
  ↓
localStorage.setItem('selectedChildId', childId)  ★ キー名統一
  ↓
ViewModeContext.setViewMode('kids')
  ↓
router.push('/') → KidsHomeが表示
  ↓
KidsHome: ViewModeContextから selectedChildId 取得
  ↓
Supabase query:
  .select("stamp_count, display_name, real_name, ...")
  .eq("id", selectedChildId)
  ↓
表示ロジック:
  setDisplayName(data.real_name || "登録なし")  ★ real_name優先
  ↓
「設定」ボタンをクリック → /child-mode/settings
  ↓
child-mode/settings/page.tsx:
  ViewModeContextから selectedChildId 取得 ★ 正しく取得できる
  ↓
/api/profiles/${selectedChildId} でプロフィール取得
  ↓
real_name を表示・編集 ★ 本名管理
```

### トラブルシューティング（追加）

#### 問題: 「子供IDが見つかりません」エラー（修正済み）

**症状:**
- 設定画面で子供画面に切り替え
- キッズモード設定画面を開くと「子供IDが見つかりません」エラー

**原因:**
- ViewModeContext: `selectedChildId` で保存
- キッズモード設定画面: `currentChildId` で取得（不一致）

**修正内容:**
```typescript
// 修正前
const id = localStorage.getItem('currentChildId');  // ❌

// 修正後
const { selectedChildId } = useViewMode();  // ✅
```

#### 問題: 子供の名前が「登録なし」と表示される

**症状:**
- 名前を登録したのに「登録なし」と表示される

**原因:**
- `display_name`には保存されているが、`real_name`が空
- 表示ロジックが`real_name`を優先している

**解決方法:**
1. 子供モード設定画面で名前を再入力して保存
2. または、APIで`real_name`を直接更新:
```sql
UPDATE profiles
SET real_name = display_name
WHERE line_user_id IS NULL AND real_name IS NULL;
```

#### 問題: 名前編集が反映されない

**症状:**
- キッズモード設定画面で名前を編集
- 保存しても他の画面に反映されない

**確認ポイント:**
1. 保存時に`real_name`と`display_name`の両方を更新しているか
2. 表示時に`real_name`を優先しているか

---

**最終更新日**: 2026-02-22
**更新内容**: localStorageキー名統一、real_name優先ロジック、親モードに戻る機能追加

