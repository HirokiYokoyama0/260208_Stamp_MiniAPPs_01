# 子供画面切替機能 仕様書

**作成日**: 2026-02-17
**最終更新**: 2026-02-19
**ステータス**: ✅ 実装完了（統合済み、バグ修正済み）

---

## 📌 このドキュメントについて

この機能の詳細仕様は **[25_仮想メンバー機能仕様書.md](25_仮想メンバー機能仕様書.md)** に統合されました。

子供画面切替機能は、代理管理メンバー（スマホを持たない子供）を管理する機能の一部として実装されています。

---

## 🔗 関連セクション

[25_仮想メンバー機能仕様書.md](25_仮想メンバー機能仕様書.md) の以下のセクションを参照してください：

### 実装方法
- **「2. 子供の画面を開く」** セクション
  - 方法A: 家族管理画面から
  - 方法B: 設定画面から（推奨）

### UI実装
- **「1. 家族管理画面」** セクション：「開く」ボタンの実装
- **「2. 設定画面」** セクション：「子供の画面」セクションの実装

### データフロー
- **「🔄 ViewModeContext の実装」** セクション：`selectedChildId` の管理方法

---

## ✅ 実装完了の確認

以下の機能がすべて実装済みです：

### 家族管理画面から
- [x] メンバーカードに「開く」ボタン表示（代理管理メンバーのみ）
- [x] ボタンタップで ViewMode を 'kids' に切り替え
- [x] selectedChildId を Context + LocalStorage に保存
- [x] ホーム画面（`/`）にリダイレクト

### 設定画面から（推奨）
- [x] 「子供の画面」セクション表示（条件：parent && 代理管理メンバー1人以上）
- [x] 各子供用のボタン表示（名前・スタンプ数）
- [x] ボタンタップで ViewMode を 'kids' に切り替え
- [x] selectedChildId を Context + LocalStorage に保存
- [x] ホーム画面（`/`）にリダイレクト

### キッズモード画面
- [x] 診察券タブ：子供の名前・診察券番号・次回予約日を表示
- [x] スタンプタブ：子供のスタンプ履歴を表示
- [x] すべてのタブで selectedChildId のデータを表示
- [x] 「おやの がめんに もどる」ボタンで親の画面に戻る

---

## 📐 アーキテクチャ概要

```
親のスマホ
    │
    ├─ 設定画面 or 家族管理画面
    │       │
    │       ├─ 「子供の画面：太郎くん」ボタンをタップ
    │       │
    │       ▼
    │  handleSwitchToChild(childId) / handleOpenChildMode(childId)
    │       │
    │       ├─ setSelectedChildId(childId)
    │       │   └─ Context + LocalStorage に保存
    │       │
    │       ├─ setViewMode('kids')
    │       │   └─ DB の view_mode を 'kids' に更新
    │       │
    │       └─ router.push('/')
    │
    ▼
ホーム画面（/）
    │
    ├─ viewMode === 'kids' ?
    │       │
    │       └─ KidsHome コンポーネント表示
    │           │
    │           ├─ selectedChildId を取得
    │           ├─ Supabase から子供のデータ取得
    │           │   - display_name
    │           │   - ticket_number
    │           │   - next_visit_date
    │           │   - next_memo
    │           │   - stamp_count
    │           │
    │           └─ 子供専用のカラフルなUI表示
    │
    └─ すべてのタブ（スタンプ・特典・ケア記録・医院情報）で同様に動作
```

---

## 🎨 UIデザイン

詳細は [25_仮想メンバー機能仕様書.md](25_仮想メンバー機能仕様書.md) を参照してください。

**キッズモードの特徴:**
- カラフルな背景グラデーション（ピンク・イエロー・ブルー）
- ひらがな表記（「しんさつけん」「スタンプカード」）
- 大きなフォント・タップしやすいボタン
- ハブラーシカのイラスト
- 励ましメッセージ

---

## 🔧 技術スタック

- **フロントエンド**: React (Next.js 16.1.6)
- **状態管理**: ViewModeContext (React Context API)
- **永続化**: LocalStorage + Supabase
- **データベース**: Supabase PostgreSQL
- **ルーティング**: Next.js App Router

---

## 📝 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-02-17 | 初版作成 |
| 2026-02-18 | 実装完了、25_仮想メンバー機能仕様書.md に統合 |
| 2026-02-19 | バグ修正: 設定画面で代理管理メンバー表示されない問題を解決 |

---

## 🐛 トラブルシューティング

### 設定画面に「子供の画面」セクションが表示されない

**症状:**
- 親ユーザーが代理管理メンバーを作成済み
- しかし設定画面に「子供の画面」セクションが表示されない

**原因:**
APIレスポンスの構造とフロントエンドのデータアクセスパスの不一致。

`GET /api/families/me` のレスポンス構造:
```json
{
  "success": true,
  "family": {
    "id": "...",
    "family_name": "横山家",
    "members": [...]  // メンバー配列はfamilyオブジェクト内
  }
}
```

しかし `app/settings/page.tsx` は `familyData.members` を直接参照していた（正しくは `familyData.family.members`）。

**修正内容（2026-02-19）:**

[app/settings/page.tsx:44-47](app/settings/page.tsx#L44-L47)
```typescript
// 修正前
if (familyData.success && familyData.members) {
  const proxyMembers = familyData.members.filter(...)
}

// 修正後
if (familyData.success && familyData.family?.members) {
  const proxyMembers = familyData.family.members.filter(...)
}
```

**デバッグログ:**
```typescript
console.log('[Settings] 親ユーザー検出、家族情報を取得中...');
console.log('[Settings] 家族情報レスポンス:', familyData);
console.log('[Settings] 全メンバー:', familyData.family.members);
console.log('[Settings] 代理管理メンバー:', proxyMembers);
console.log('[Settings Render] familyRole:', familyRole);
console.log('[Settings Render] proxyChildren:', proxyChildren);
```

**検証方法:**
1. ブラウザの開発者ツールを開く（F12）
2. 設定画面をリロード
3. コンソールログで以下を確認:
   - `[Settings] 代理管理メンバー:` が空配列でないこと
   - `[Settings Render] proxyChildren.length:` が 0 より大きいこと
4. UIに「子供の画面」セクションが表示されること

---

**作成者**: Claude Code
**最終更新日**: 2026-02-19
**ステータス**: ✅ 実装完了（バグ修正済み）
