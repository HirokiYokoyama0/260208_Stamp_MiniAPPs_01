# QRコード表示・読み取り仕様（LIFFアプリ開発者向け）

**作成日:** 2026-02-08  
**対象:** LINEミニアプリ（LIFF）側で、来院時QRコードをカメラ読み取りし、スタンプ付与APIを呼ぶ実装を行う開発者。  
**関連:** [24_テスト用QRコード表示.md](24_テスト用QRコード表示.md)（管理ダッシュボード側のテスト用QR表示仕様）

---

## 1. 概要

- 患者が**来院時**に、院内に設置されたQRコード（またはテスト用として管理画面に表示されたQR）を、**LIFFアプリ内のカメラで読み取る**。
- 読み取った内容に応じて、**スタンプ付与API** を呼び出し、`stamp_history` に1件登録する。これにより `profiles.stamp_count` 等が既存トリガーで自動更新される。
- 本ドキュメントでは、**QRコードのデータ形式**と、**読み取り後にLIFF側で呼ぶAPIの仕様**を定義する。

---

## 2. QRコードのデータ形式（ペイロード）

管理ダッシュボードの「テスト用QRコード」タブで表示する2種類のQRは、次の **JSON文字列** をそのままエンコードしたものとする（改行なし・UTF-8）。

### 2.1 優良患者様用（10点/回）

```json
{"type":"premium","points":10}
```

- **type:** `premium` … 優良患者様用
- **points:** `10` … 1回のスキャンで付与するポイント数（10点 = スタンプ1個分）

### 2.2 通常患者様用（5点/回）

```json
{"type":"regular","points":5}
```

- **type:** `regular` … 通常患者様用
- **points:** `5` … 1回のスキャンで付与するポイント数（0.5スタンプ分）

### 2.3 共通

- 将来的に本番用QRで `qr_code_id`（重複防止用）や `expires_at` などを含める場合は、LIFF側でそれらをパースし、APIに渡す想定。**テスト用では上記2種類の固定ペイロードのみでよい。**

---

## 3. LIFF側の処理フロー

1. **カメラ起動**  
   LIFFアプリ内でカメラを起動し、QRコードを読み取る（LIFF SDK または HTML5 の `getUserMedia` + 任意のQRデコードライブラリ）。

2. **デコード**  
   読み取った文字列が上記JSON形式であればパースする。`type` と `points` を取得。不正な形式の場合はエラー表示し、再スキャンさせる。

3. **スタンプ付与APIの呼び出し**  
   - **エンドポイント:** 管理ダッシュボード（Next.js）側に、スタンプ付与用のAPIを用意する想定。  
     例: `POST /api/stamps/scan` または既存のスタンプ登録用APIがある場合はそのURL・メソッドに準拠。
   - **リクエスト例（JSON）:**
     ```json
     {
       "type": "premium",
       "points": 10,
       "qr_code_id": "optional-unique-id-for-dedup"
     }
     ```
   - **認証:** 呼び出し元が「どの患者（LINEユーザー）か」を識別する必要がある。LIFFの `getProfile()` で取得した `userId`（LINEのユーザーID）を、ヘッダーまたはBodyに含める。API側で `profiles` の `id` または `line_user_id` と突き合わせ、該当患者の `stamp_history` にINSERTする。
   - **重複防止:** 同一QRを短時間に連打されないよう、`qr_code_id` をリクエストに含め、サーバー側で「同一 `qr_code_id` + 同一ユーザー」の連続登録を制限する設計が望ましい。テスト用では `qr_code_id` を省略または固定でも可。

4. **レスポンス**  
   - 成功: 200 + 付与後のスタンプ数など（任意）。LIFF側で「スタンプが付与されました」と表示。
   - 失敗: 4xx/5xx + エラー内容。LIFF側でメッセージ表示し、必要なら再スキャンさせる。

---

## 4. スタンプ付与API（管理ダッシュボード側）の役割案

- **入力:** LINEユーザーID（LIFFから渡す）、`type` または `points`、任意で `qr_code_id`。
- **処理:**
  1. `profiles` から `line_user_id`（または `id`）で該当患者を取得。
  2. 該当がなければ 404 または 400。
  3. `stamp_history` に1件INSERT: `user_id`, `visit_date = NOW()`, `stamp_number`（既存の最大値 + 今回の `points` など、既存ロジックに合わせる）, `amount = points`, `stamp_method = 'qr_scan'`, `qr_code_id`（あれば）。
  4. 既存のDBトリガーで `profiles.stamp_count` 等が更新される。
- **重複防止:** 同一 `qr_code_id` + 同一 `user_id` で既に登録済みの場合は、409 Conflict または 200（冪等）で返すなどの方針を決める。

※ 上記APIが未実装の場合は、管理ダッシュボード担当者と相談し、エンドポイント・パラメータを確定すること。

---

## 5. テスト手順（想定）

1. 管理ダッシュボードで「テストQR」タブを開き、2種類のQRを表示する。
2. テスト端末でLIFFアプリを開き、カメラで「優良患者様用」のQRを読み取る。
3. LIFF側でAPIを呼び、成功したら「10点付与されました」等を表示。
4. 管理画面の患者一覧またはスタンプ履歴で、該当患者のスタンプが増えていることを確認する。
5. 同様に「通常患者様用」のQRで 5点 付与を確認する。

---

## 6. 本番用QRとの違い（将来拡張）

- **テスト用:** 固定の `{"type":"premium","points":10}` / `{"type":"regular","points":5}` のみ。`qr_code_id` は省略または簡易値で可。
- **本番用（案）:**  
  - 院内QRには、重複防止のため「1回限り有効なトークン」や「日付+QR設置場所ID」などを含め、サーバーで検証する方式を検討する。  
  - その場合、ペイロード形式の拡張（例: `token`, `expires_at`）と、API側の検証仕様を別途定義する。

---

## 7. 関連ドキュメント

- [24_テスト用QRコード表示.md](24_テスト用QRコード表示.md) … 管理画面でのテスト用QR表示
- [05_Database_Schema.md](05_Database_Schema.md) … `stamp_history` 構造
- [05_LINEミニアプリ仕様書.md](05_LINEミニアプリ仕様書.md) … LIFFアプリ全体仕様（あれば）

---

最終更新: 2026-02-08
